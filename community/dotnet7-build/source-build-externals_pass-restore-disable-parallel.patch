From 79f02a53316f90543d60269d7c06727c376f423b Mon Sep 17 00:00:00 2001
From: Antoine Martin <dev@ayakael.net>
Date: Wed, 24 Aug 2022 18:41:08 +0000
Subject: [PATCH 1/1] pass RestoreParallelDisable

A bug was introduced in dotnet7 that causes issues with parallel restore
operations when using mono-flavored runtime. A workaround is setting
/p:RestoreParallelDisable=true.

This patch allows proper flow of that flag through the build

See https://github.com/dotnet/runtime/issues/77364

---
diff --git a/src/source-build-externals/repos/MSBuildLocator.proj b/src/source-build-externals/repos/MSBuildLocator.proj
index 863a93c539..5844094e78 100644
--- a/src/source-build-externals/repos/MSBuildLocator.proj
+++ b/src/source-build-externals/repos/MSBuildLocator.proj
@@ -17,6 +17,7 @@
       <BuildCommandArgs>$(BuildCommandArgs) $(RedirectRepoOutputToLog)</BuildCommandArgs>
       <BuildCommandArgs>$(BuildCommandArgs) /p:MicrosoftSourceLinkVersion=$(MicrosoftSourceLinkVersion)</BuildCommandArgs>
       <BuildCommandArgs>$(BuildCommandArgs) /p:Version=1.4.1</BuildCommandArgs>
+      <BuildCommandArgs Condition="'$(RestoreDisableParallel)' == 'true'">$(BuildCommandArgs) /p:RestoreDisableParallel=true</BuildCommandArgs>
     </PropertyGroup>
 
     <Exec Command="$(DotnetToolCommand) restore /bl:restore.binlog $(BuildCommandArgs)"
diff --git a/src/source-build-externals/repos/application-insights.proj b/src/source-build-externals/repos/application-insights.proj
index 358839eb6c..13880a32c2 100644
--- a/src/source-build-externals/repos/application-insights.proj
+++ b/src/source-build-externals/repos/application-insights.proj
@@ -28,6 +28,8 @@
       <BuildCommandArgs>$(BuildCommandArgs) /p:BinRoot=$(ProjectDirectory)/bin</BuildCommandArgs>
       <BuildCommandArgs>$(BuildCommandArgs) /p:ObjRoot=$(ProjectDirectory)/obj</BuildCommandArgs>
       <BuildCommandArgs>$(BuildCommandArgs) /p:PackageOutputDir=$(ProjectDirectory)/bin/$(Configuration)</BuildCommandArgs>
+
+      <BuildCommandArgs Condition="'$(RestoreDisableParallel)' == 'true'">$(BuildCommandArgs) /p:RestoreDisableParallel=true</BuildCommandArgs>
     </PropertyGroup>
 
     <Exec Command="$(DotnetToolCommand) restore /bl:restore.binlog $(BuildCommandArgs)  "
diff --git a/src/source-build-externals/repos/cssparser.proj b/src/source-build-externals/repos/cssparser.proj
index 800d5706fe..90e901e57f 100644
--- a/src/source-build-externals/repos/cssparser.proj
+++ b/src/source-build-externals/repos/cssparser.proj
@@ -15,6 +15,7 @@
       <BuildCommandArgs>$(BuildCommandArgs) /p:Configuration=$(Configuration)</BuildCommandArgs>
       <BuildCommandArgs>$(BuildCommandArgs) /v:$(LogVerbosity)</BuildCommandArgs>
       <BuildCommandArgs>$(BuildCommandArgs) $(RedirectRepoOutputToLog)</BuildCommandArgs>
+      <BuildCommandArgs Condition="'$(RestoreDisableParallel)' == 'true'">$(BuildCommandArgs) /p:RestoreDisableParallel=true</BuildCommandArgs>
     </PropertyGroup>
 
     <Exec Command="$(DotnetToolCommand) restore /bl:restore.binlog $(BuildCommandArgs)  "
diff --git a/src/source-build-externals/repos/humanizer.proj b/src/source-build-externals/repos/humanizer.proj
index 96f9e9c41c..4770d7fb6b 100644
--- a/src/source-build-externals/repos/humanizer.proj
+++ b/src/source-build-externals/repos/humanizer.proj
@@ -16,6 +16,7 @@
       <!-- Always build release mode: nuspecs in repo are hard-coded to Release config outputs. -->
       <BuildCommandArgs>$(BuildCommandArgs) /p:Configuration=Release</BuildCommandArgs>
       <BuildCommandArgs>$(BuildCommandArgs) /v:$(LogVerbosity)</BuildCommandArgs>
+      <BuildCommandArgs Condition="'$(RestoreDisableParallel)' == 'true'">$(BuildCommandArgs) /p:RestoreDisableParallel=true</BuildCommandArgs>
 
       <PackCommandArgs>$(BuildCommandArgs)</PackCommandArgs>
       <PackCommandArgs>$(PackCommandArgs) /p:NuspecFile=$(ProjectDirectory)NuSpecs/Humanizer.Core.nuspec</PackCommandArgs>
diff --git a/src/source-build-externals/repos/netcorecli-fsc.proj b/src/source-build-externals/repos/netcorecli-fsc.proj
index a9c1d27d35..7fee9e6ff7 100644
--- a/src/source-build-externals/repos/netcorecli-fsc.proj
+++ b/src/source-build-externals/repos/netcorecli-fsc.proj
@@ -3,6 +3,7 @@
 
   <PropertyGroup>
     <OutputArgs>/bl /v:$(LogVerbosity) /p:OutputPath=$(OutputPath)$(RepositoryName)/ /p:BaseIntermediateOutputPath=$(IntermediatePath)$(RepositoryName)</OutputArgs>
+    <OutputArgs Condition="'$(RestoreDisableParallel)' == 'true'">$(OutputArgs) /p:RestoreDisableParallel=true</OutputArgs>
     <BuildCommand>$(DotnetToolCommand) pack -c $(Configuration) --output $(SourceBuiltPackagesPath) --no-build FSharp.NET.Sdk.csproj /p:NuspecFile=FSharp.NET.Sdk.nuspec $(OutputArgs) $(RedirectRepoOutputToLog)</BuildCommand>
     <PackagesOutput>$(SourceBuiltPackagesPath)</PackagesOutput>
     <RepoApiImplemented>false</RepoApiImplemented>
diff --git a/src/source-build-externals/repos/newtonsoft-json.proj b/src/source-build-externals/repos/newtonsoft-json.proj
index 1ce720419d..e6ebe33fb1 100644
--- a/src/source-build-externals/repos/newtonsoft-json.proj
+++ b/src/source-build-externals/repos/newtonsoft-json.proj
@@ -13,6 +13,7 @@
     <NewtonsoftJsonDirectory>$(ProjectDirectory)/Src/Newtonsoft.Json/</NewtonsoftJsonDirectory>
     <NewtonsoftJsonProjectPath>$(NewtonsoftJsonDirectory)Newtonsoft.Json.csproj</NewtonsoftJsonProjectPath>
     <DotnetToolCommandArguments>"/p:DotnetOnly=true" "/p:Configuration=$(Configuration)" "/p:AssemblyOriginatorKeyFile=$(NewtonsoftJsonKeyFilePath)" "/p:SignAssembly=true" "/p:PublicSign=true" "/p:TreatWarningsAsErrors=false" "/p:AdditionalConstants=SIGNED"</DotnetToolCommandArguments>
+    <DotnetToolCommandArguments Condition="'$(RestoreDisableParallel)' == 'true'">$(DotnetToolCommandArguments) /p:RestoreDisableParallel=true</DotnetToolCommandArguments>
     <BuildCommand>$(DotnetToolCommand) build $(NewtonsoftJsonProjectPath) /bl:build.binlog $(DotnetToolCommandArguments)</BuildCommand>
     <BuildPackagesCommand>$(DotnetToolCommand) pack $(NewtonsoftJsonProjectPath) /bl:pack.binlog $(DotnetToolCommandArguments)</BuildPackagesCommand>
     <CleanCommand>$(DotnetToolCommand) clean $(NewtonsoftJsonProjectPath) $(DotnetToolCommandArguments)</CleanCommand>
diff --git a/src/source-build-externals/repos/azure-activedirectory-identitymodel-extensions-for-dotnet.proj b/src/source-build-externals/repos/azure-activedirectory-identitymodel-extensions-for-dotnet.proj
index 77d5def81b..5e06f43022 100644
--- a/src/source-build-externals/repos/azure-activedirectory-identitymodel-extensions-for-dotnet.proj
+++ b/src/source-build-externals/repos/azure-activedirectory-identitymodel-extensions-for-dotnet.proj
@@ -22,6 +22,7 @@
       <BuildCommandArgs>$(BuildCommandArgs) /v:$(LogVerbosity)</BuildCommandArgs>
       <BuildCommandArgs>$(BuildCommandArgs) $(RedirectRepoOutputToLog)</BuildCommandArgs>
       <BuildCommandArgs>$(BuildCommandArgs) /p:Version=6.21.0</BuildCommandArgs>
+      <BuildCommandArgs Condition="'$(RestoreDisableParallel)' == 'true'">$(BuildCommandArgs) /p:RestoreDisableParallel=true</BuildCommandArgs>
 
       <PackCommandArgs>$(BuildCommandArgs) --output $(ProjectDirectory)pack</PackCommandArgs>
     </PropertyGroup>
