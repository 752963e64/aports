From faa8ecb8a6f444f62ce1e3c093e3727138c02b56 Mon Sep 17 00:00:00 2001
Patch-Source: https://github.com/dotnet/installer/pull/14647
From: Tom Deseyn <tom.deseyn@gmail.com>
Date: Tue, 4 Oct 2022 08:58:58 +0200
Subject: [PATCH] BundledVersions: update portable rid logic.

Defaults the portable rid to match the rid.
This works for portable builds.

For non-portable builds, the portable rid can be
controlled using PortableOSName.

For source-build, we set PortableOSName based
on the bootstrap SDK's portable rid.
---
 .../tarball/content/repos/installer.proj         |  5 +++++
 src/redist/targets/GetRuntimeInformation.targets | 16 +++++++++-------
 2 files changed, 14 insertions(+), 7 deletions(-)

diff --git a/src/installer/src/redist/targets/GetRuntimeInformation.targets b/src/installer/src/redist/targets/GetRuntimeInformation.targets
index f8f556518b2..6d216ff20df 100644
--- a/src/installer/src/redist/targets/GetRuntimeInformation.targets
+++ b/src/installer/src/redist/targets/GetRuntimeInformation.targets
@@ -9,10 +9,15 @@
       <HostOSName Condition=" '$(HostOSName)' == '' AND $([MSBuild]::IsOSPlatform('OSX')) ">osx</HostOSName>
       <HostOSName Condition=" '$(HostOSName)' == '' AND $([MSBuild]::IsOSPlatform('FREEBSD')) ">freebsd</HostOSName>
       <HostOSName Condition=" '$(HostOSName)' == '' AND '$(IsLinux)' == 'True' ">linux</HostOSName>
-      
+
+      <OSName Condition=" '$(OSName)' == '' AND $(Rid) != '' ">$(Rid.Substring(0, $(Rid.LastIndexOf('-'))))</OSName>
       <OSName Condition=" '$(OSName)' == '' ">$(HostOSName)</OSName>
 
-      <Rid Condition=" '$(Rid)' == '' ">$(OSName)-$(Architecture)</Rid>
+      <PortableOSName Condition=" '$(PortableOSName)' == '' ">$(OSName)</PortableOSName>
+
+      <Rid>$(OSName)-$(Architecture)</Rid>
+
+      <PortableRid>$(PortableOSName)-$(Architecture)</PortableRid>
     </PropertyGroup>
 
     <PropertyGroup>
@@ -24,12 +29,9 @@
     </PropertyGroup>
 
     <PropertyGroup>
-      <ProductMonikerRid Condition=" '$(Rid)' == 'ubuntu.16.04-x64' OR
-                                   '$(Rid)' == 'rhel.6-x64' OR
-                                   '$(Rid)' == 'linux-musl-x64' ">$(Rid)</ProductMonikerRid>
-      <ProductMonikerRid Condition=" '$(ProductMonikerRid)' == '' ">$(OSName)-$(Architecture)</ProductMonikerRid>
+      <ProductMonikerRid Condition=" '$(ProductMonikerRid)' == '' ">$(Rid)</ProductMonikerRid>
 
-      <PortableProductMonikerRid Condition=" '$(PortableProductMonikerRid)' == '' ">$(HostOSName)-$(Architecture)</PortableProductMonikerRid>
+      <PortableProductMonikerRid Condition=" '$(PortableProductMonikerRid)' == '' ">$(PortableRid)</PortableProductMonikerRid>
 
       <ArtifactNameSdk>dotnet-sdk-internal$(PgoTerm)</ArtifactNameSdk>
       <ArtifactNameCombinedHostHostFxrFrameworkSdk>dotnet-sdk$(PgoTerm)</ArtifactNameCombinedHostHostFxrFrameworkSdk>
