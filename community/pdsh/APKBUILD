# Contributor: Jakub Jirutka <jakub@jirutka.cz>
# Maintainer: Jakub Jirutka <jakub@jirutka.cz>
pkgname=pdsh
pkgver=2.35
pkgrel=0
pkgdesc="A high performance, parallel remote shell utility"
url="https://github.com/chaos/pdsh"
arch="all"
license="GPL-2.0-or-later"
depends="perl"
makedepends="autoconf automake libtool readline-dev ncurses-dev"
checkdepends="bash"
subpackages="$pkgname-doc $pkgname-rcmd-ssh:_rcmd_ssh"
source="https://github.com/chaos/pdsh/archive/pdsh-$pkgver.tar.gz
	without-rresvport.patch
	fix-test-t6036.patch"
builddir="$srcdir/$pkgname-$pkgname-$pkgver"

prepare() {
	default_prepare

	sed -i "s|m4_esyscmd(\[git describe .*\])|[$pkgver]|" configure.ac
	./bootstrap
}

build() {
	./configure \
		--build=$CBUILD \
		--host=$CHOST \
		--prefix=/usr \
		--sysconfdir=/etc \
		--mandir=/usr/share/man \
		--localstatedir=/var \
		--disable-static \
		--without-rsh \
		--with-ssh \
		--with-readline
	make
}

check() {
	make check
}

package() {
	make DESTDIR="$pkgdir" install
}

_rcmd_ssh() {
	pkgdesc="Pdsh module for ssh rcmd functionality"
	depends="$pkgname openssh-client"
	install_if="$pkgname=$pkgver-r$pkgrel openssh-client"

	mkdir -p "$subpkgdir"/usr/lib/$pkgname
	mv "$pkgdir"/usr/lib/$pkgname/sshcmd.* "$subpkgdir"/usr/lib/$pkgname/
}

sha512sums="
fcfb72fa6db7d44599c93cee4dbf91acb7dc35e7e4a3da54e21ac4fa5feb0164bb8f2c4293c90cbc085c25f79af71008dc5de05a716a0070a46b1f4f249c47d8  pdsh-2.35.tar.gz
4789a1e8ee5d5a9060b6f05f4daf010fd85f3fb1050935f722d4ebcca490b8a311bd8ea025b174a2e72219291e869ccb33be501a60afccd6f51107b99fe05c05  without-rresvport.patch
8ddfb37a4e7c9550f79e8bf0d24795203f23452541382f8d744adfe40889964fa966655795f2d4d594ee21af3f14c9d2fe93ad98a0620403d5c42aaab1f55949  fix-test-t6036.patch
"
