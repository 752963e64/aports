# Contributor: Mark Pashmfouroush <mark@markpash.me>
# Contributor: Francesco Colista <fcolista@alpinelinux.org>
# Maintainer: Mark Pashmfouroush <mark@markpash.me>
pkgname=coredns
pkgver=1.9.3
pkgrel=4
pkgdesc="fast and flexible DNS server"
url="https://github.com/coredns/coredns"
license="Apache-2.0"
arch="all"
options="net chmod-clean"
depends="unbound-libs"
makedepends="go libcap unbound-dev"
install="$pkgname.pre-install"
subpackages="$pkgname-openrc"
source="$pkgname-$pkgver.tar.gz::https://github.com/coredns/coredns/archive/v$pkgver.tar.gz
	coredns.confd
	coredns.initd
	coredns.logrotated
	ensure-cgo.patch
	plugin.cfg.enabled
	add-tsig-support.patch
	"

# secfixes:
#   1.9.3-r0:
#     - CVE-2022-27191
#     - CVE-2022-28948

export GOCACHE="$srcdir/go-cache"
export GOTMPDIR="$srcdir"
export GOMODCACHE="$srcdir/go"

prepare() {
	default_prepare
	cp "$srcdir"/plugin.cfg.enabled "$builddir"/plugin.cfg
}

build() {
	CGO_ENABLED=1 make
}

check() {
	cd "$builddir"/request; go test ./...
	cd "$builddir"/core; go test ./...
	cd "$builddir"/coremain; go test ./...
	cd "$builddir"/plugin; go test ./...
}

package() {
	install -Dm755 coredns "$pkgdir"/usr/bin/coredns
	setcap cap_net_bind_service=+ep "$pkgdir"/usr/bin/coredns

	install -Dm755 "$srcdir"/coredns.initd "$pkgdir"/etc/init.d/coredns
	install -Dm644 "$srcdir"/coredns.confd "$pkgdir"/etc/conf.d/coredns
	install -Dm 644 "$srcdir"/coredns.logrotated "$pkgdir"/etc/logrotate.d/coredns

	install -d "$pkgdir"/etc/coredns
	install -d "$pkgdir"/var/log/coredns
}

sha512sums="
d0c24c5d9f27883519e0d6edf917c6e0051b80627a320a20f6d5ee3e154f65790d1f66b5e0255aeed66874ff5826b2ab3d1237d6fd53452e7dfaf3b34b17fdfb  coredns-1.9.3.tar.gz
90300a3035b00b58f362b2c12dfaeee21b889e10e90600523b5785c907dfbd7e515c3269dd29a9d4c758990e78ede8343edfac0bc022bd3a23652543ba2d42d3  coredns.confd
06d9fcf227e064f8ea21f4f003d33611aabf2d75b2e6e097dc10af1db42ea823d15c26649e52584da4fb4a85e87b3f27959a44ce873f176c2a082624f6845f38  coredns.initd
c697c08c3b1153ae224a1eeb3521f9ee594de4852bc6ef78d94dc7f6f680517659a653ab5c13ea03918deb79e6654ef11512ba4c90fe06ea4591fefbab876ece  coredns.logrotated
9f2c08750b42f0901bc190a4c829a5a003e4c3aa9bd55e9a2f37f68f446cdd15b60227b7d2381d85b49674580f7c0206af76345d6dd5160401772c3efbf50ab6  ensure-cgo.patch
ea1f6a5bee5279fb18385858d96f60982ba1298784f80a7c9d497d5a532734c0c78cfc869816ead5d3c6f91f6271857946f38a963b2f99bfe66e582fae37f7f0  plugin.cfg.enabled
ed7a6fb2786dc9e1b2d9164026ac846008bb79b0253a38e727adf2dc293b759a277bd216df145debc68038625205ed0ff95678570a4e97b7bc2bba4c1bcd751d  add-tsig-support.patch
"
