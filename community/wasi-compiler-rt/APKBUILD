# Contributor: psykose <alice@ayaya.dev>
# Contributor: Alex Yam <alex@alexyam.com>
# Maintainer: psykose <alice@ayaya.dev>
pkgname=wasi-compiler-rt
# match llvm ver
pkgver=14.0.4
_llvmver="${pkgver%%.*}"
_wasi_sdk_ver=15
pkgrel=0
pkgdesc="WASI LLVM compiler runtime"
url="https://compiler-rt.llvm.org/"
arch="all"
options="!check" # TODO: check
license="Apache-2.0 WITH LLVM-exception BSD-2-Clause"
makedepends="
	clang
	cmake
	libxml2-dev
	llvm$_llvmver-dev
	llvm$_llvmver-static
	python3-dev
	samurai
	wasi-libc
	zlib-dev
	"
source="https://github.com/llvm/llvm-project/releases/download/llvmorg-$pkgver/compiler-rt-$pkgver.src.tar.xz
	https://github.com/llvm/llvm-project/releases/download/llvmorg-$pkgver/llvm-$pkgver.src.tar.xz
	https://github.com/WebAssembly/wasi-sdk/archive/refs/tags/wasi-sdk-$_wasi_sdk_ver.tar.gz
	"
builddir="$srcdir"/wasi-compiler-rt

prepare() {
	default_prepare
	mkdir -p "$builddir"
	mv "$srcdir"/compiler-rt-$pkgver.src "$builddir"/compiler-rt
	mv "$srcdir"/llvm-$pkgver.src "$builddir"/llvm
	mv "$srcdir"/wasi-sdk-wasi-sdk-$_wasi_sdk_ver/wasi-sdk.cmake "$builddir"
	mv "$srcdir"/wasi-sdk-wasi-sdk-$_wasi_sdk_ver/cmake "$builddir"
	mv "$srcdir"/cmake/* "$builddir"/cmake
}

build() {
	export CFLAGS="$CFLAGS -fno-exceptions --sysroot=/usr/share/wasi-sysroot"
	cmake -B build -G Ninja \
		-DCMAKE_BUILD_TYPE=MinSizeRel \
		-DCMAKE_MODULE_PATH="$builddir"/cmake \
		-DCMAKE_TOOLCHAIN_FILE="$builddir"/wasi-sdk.cmake \
		-DCMAKE_C_COMPILER_WORKS=ON \
		-DCOMPILER_RT_BAREMETAL_BUILD=ON \
		-DCOMPILER_RT_INCLUDE_TESTS=OFF \
		-DCOMPILER_RT_HAS_FPIC_FLAG=OFF \
		-DCOMPILER_RT_DEFAULT_TARGET_ONLY=ON \
		-DCOMPILER_RT_OS_DIR=wasi \
		-DWASI_SDK_PREFIX=/usr \
		-DCMAKE_INSTALL_PREFIX=/usr/lib/clang/$pkgver/ \
		compiler-rt/lib/builtins
	cmake --build build
}

package() {
	DESTDIR="$pkgdir" cmake --install build
}
sha512sums="
53ba9c8d5a5c6f36977ca880397502c4d49177cb0d2e7f3cb98c2e256c169b8b7eb7703b2c0b7aa106de5f3d8d52bb2f746625de8d983e8027d9417375d4815f  compiler-rt-14.0.4.src.tar.xz
f15a8f1b9067d9f3fb2837f04bf6137218d0d0fd9dbd51b40a046675ed194c4c51b084643014180b7a72c2475f87f5784bed9f9940c326c2e5e264114dde4e5b  llvm-14.0.4.src.tar.xz
547851faf4083213a9f62a7ffef6b7d75042cbb15ac96e0c5fb254e2e57a8fc73a3ae7e7db19dc224e652d1318a9ecddfe216d3bc5afd0a79dda3b0e09812779  wasi-sdk-15.tar.gz
"
