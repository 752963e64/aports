# Contributor: Jakub Jirutka <jakub@jirutka.cz>
# Maintainer: Jakub Jirutka <jakub@jirutka.cz>
pkgname=meilisearch
pkgver=1.1.1
pkgrel=0
pkgdesc="A lightning-fast search engine that fits into your apps, websites and workflow"
url="https://www.meilisearch.com/"
# ppc64le, riscv64, s390x: fails to build ring crate
# armhf, armv7, x86: unsupported by upstream
arch="all !armhf !armv7 !ppc64le !riscv64 !s390x !x86"
license="MIT"
makedepends="
	cargo
	libgit2-dev
	mimalloc2-dev
	"
pkgusers="meilisearch"
pkggroups="meilisearch"
install="$pkgname.pre-install"
subpackages="$pkgname-openrc"
source="https://github.com/meilisearch/meilisearch/archive/v$pkgver/meilisearch-$pkgver.tar.gz
	syslog.patch
	$pkgname.initd
	$pkgname.confd
	"
options="!check"  # FIXME: tests are broken?

export CARGO_PROFILE_RELEASE_OPT_LEVEL=2

# Disable analytics (telemetry / data collection), mini-dashboard (JS project)
# and specialized tokenizers (they are huge).
_cargo_opts="--frozen --no-default-features"


prepare() {
	default_prepare

	# Rust target triple.
	local target=$(rustc -vV | sed -n 's/host: //p')

	# Build against system-provided mimalloc.
	mkdir -p .cargo
	cat >> .cargo/config.toml <<-EOF
		[target.$target]
		mimalloc = { rustc-link-lib = ["mimalloc"] }
	EOF

	cargo fetch --target="$CTARGET" --locked
}

build() {
	cargo build $_cargo_opts --release
}

check() {
	cargo test $_cargo_opts --workspace
}

package() {
	install -D -m755 target/release/$pkgname -t "$pkgdir"/usr/bin/

	install -D -m755 "$srcdir"/$pkgname.initd "$pkgdir"/etc/init.d/$pkgname
	install -D -m644 "$srcdir"/$pkgname.confd "$pkgdir"/etc/conf.d/$pkgname

	install -d -m755 -o "$pkgusers" -g "$pkggroups" "$pkgdir"/var/lib/$pkgname
}

sha512sums="
22508f10b782c72609d114b5629bc245331c4d5b03306286f25a96ce27c3ce5038b0f1821184bbd3de926ec5884dcaf7d156d3b3206e8cc2db719cf59ae419fa  meilisearch-1.1.1.tar.gz
bacc82d2d4654930cff3173fb09ece051c45adcb288458fce4be1930c80b59cdac5c4efaa81c2997be0f3833a96811a2485a0f1ef318eabffaa4b6b3ae964eac  syslog.patch
daeee18fe0eb46e141082a9bfbd26c973794996efbc8fddc4b2dc71aaeee708839d9975017f8f7813780a14a2b69d0d70f69ae7509999ecea46411dc325c3a8d  meilisearch.initd
da1a1d0aa20e5419ff5766b4c2ff8ccee5666740ff2a5708e844889b38878edcfd1d961004c7e469f0da11375c6c43b7ca8a4d05dc30600bf8fe2e1092fecea0  meilisearch.confd
"
