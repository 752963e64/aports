# Contributor: Eric Molitor <eric@molitor.org>
# Contributor: Jakub Jirutka <jakub@jirutka.cz>
# Maintainer: Rasmus Thomsen <oss@cogitri.dev>
pkgname=lld
pkgver=12.0.1
pkgrel=0
_llvmver=${pkgver%%.*}
pkgdesc="The LLVM Linker"
url="https://llvm.org"
arch="all !mips !mips64 !s390x" #llvm-libunwind disabled for s390x
license="Apache-2.0"
makedepends="
	cmake
	ninja
	libedit-dev
	llvm$_llvmver-dev
	llvm$_llvmver-static
	llvm-libunwind-static
	llvm$_llvmver-test-utils
	llvm-libunwind-dev
	zlib-dev
	xz
	"
checkdepends="gtest gtest-dev bash"
subpackages="$pkgname-static $pkgname-dev"
source="https://github.com/llvm/llvm-project/releases/download/llvmorg-$pkgver/lld-$pkgver.src.tar.xz
https://github.com/llvm/llvm-project/releases/download/llvmorg-$pkgver/llvm-$pkgver.src.tar.xz
"

builddir="$srcdir/$pkgname-$pkgver.src" 
# Tests OOM on 32-bit
case "$CARCH" in
	s390x|x86|armhf|armv7) options="!check" ;;
esac

unpack(){
        cd src
        tar -xf "llvm-$pkgver.src.tar.xz"
        tar -xf "lld-$pkgver.src.tar.xz"
        mv "llvm-$pkgver.src" llvm
        mv "lld-$pkgver.src" lld

}

build() {
	mkdir -p "$builddir"
	cd "$builddir"


	 cmake -G "Unix Makefiles" -S ../llvm -B build\
		-DCMAKE_BUILD_TYPE=MinSizeRel \
		-DCMAKE_VERBOSE_MAKEFILE=OFF \
		-DCMAKE_C_FLAGS_MINSIZEREL_INIT="$CFLAGS" \
		-DLLVM_ENABLE_PROJECTS=lld \
		-DCMAKE_CXX_FLAGS_MINSIZEREL_INIT="$CXXFLAGS" \
		-DCMAKE_EXE_LINKER_FLAGS_MINSIZEREL_INIT="$LDFLAGS -Wl,-z,stack-size=2097152" \
		-DCMAKE_INSTALL_PREFIX=/usr \
		-DCMAKE_SKIP_INSTALL_RPATH=ON \
		-DLLVM_INCLUDE_TESTS=ON
	 cd build
	make lld
}

check() {
	cd "$builddir/build"
	make check-lld



}

package() {
	cd "$builddir"/build
	DESTDIR="$pkgdir" make install
}



sha512sums="4292e45c54f61b8bf8b0a412f1423e062fb7c88ab3d143de3bccf010ea84fcf672ec432068a6adc461f605993d5c4e7e720e9b719d7bf8cbe670115f75e1fb2a  lld-12.0.1.src.tar.xz
ff674afb4c8eea699a4756f1bb463f15098a7fa354c733de83c024f8f0cf238cd5f19ae3ec446831c7109235e293e2bf31d8562567ede163c8ec53af7306ba0f  llvm-12.0.1.src.tar.xz"

