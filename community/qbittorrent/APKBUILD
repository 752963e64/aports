# Contributor: Jan Tatje <jan@jnt.io>
# Contributor: Simon Zeni <simon@bl4ckb0ne.ca>
# Maintainer: psykose <alice@ayaya.dev>
pkgname=qbittorrent
pkgver=4.4.2
pkgrel=2
pkgdesc="qBittorrent client"
url="https://www.qbittorrent.org/"
arch="all !s390x" # qt6-qttools
license="GPL-2.0-or-later"
options="!check" # qBittorrent has no tests
makedepends="
	boost-dev
	cmake
	libexecinfo-dev
	libtorrent-rasterbar-dev
	ninja
	qt6-qtbase-dev
	qt6-qtsvg-dev
	qt6-qttools-dev
	"
subpackages="
	$pkgname-doc
	$pkgname-nox
	$pkgname-nox-openrc:nox_openrc
	$pkgname-nox-doc:nox_doc
	"
source="$pkgname-$pkgver.tar.gz::https://github.com/qbittorrent/qBittorrent/archive/refs/tags/release-$pkgver.tar.gz
	qbittorrent-nox.initd
	qbittorrent-nox.confd
	link-execinfo.patch
	"
builddir="$srcdir/qBittorrent-release-$pkgver"

# secfixes:
#   4.1.6-r3:
#     - CVE-2019-13640

build() {
	cmake -B build-gui -G Ninja \
		-DCMAKE_BUILD_TYPE=Release \
		-DCMAKE_INSTALL_PREFIX=/usr \
		-DCMAKE_INTERPROCEDURAL_OPTIMIZATION=ON \
		-DWEBUI=OFF \
		-DQT6=ON
	cmake --build build-gui

	cmake -B build-nox -G Ninja \
		-DCMAKE_BUILD_TYPE=Release \
		-DCMAKE_INSTALL_PREFIX=/usr \
		-DCMAKE_INTERPROCEDURAL_OPTIMIZATION=ON \
		-DGUI=OFF \
		-DQT6=ON
	cmake --build build-nox
}

package() {
	depends="qt6-qtsvg" # needed for ui icons
	DESTDIR="$pkgdir" cmake --install build-gui
}

nox() {
	install="$pkgname-nox.pre-install"
	pkgdesc="$pkgdesc (webui)"

	install -Dm755 "$builddir"/build-nox/qbittorrent-nox \
		"$subpkgdir"/usr/bin/qbittorrent-nox
}

nox_doc() {
	install -Dm644 "$builddir"/doc/qbittorrent-nox.1 \
		"$subpkgdir"/usr/share/man/man1/qbittorrent-nox.1
	default_doc
}

nox_openrc() {
	depends="openrc"
	pkgdesc="$pkgdesc (webui) (OpenRC init scripts)"
	install_if="openrc ${subpkgname%-openrc}=$pkgver-r$pkgrel"

	install -Dm755 "$srcdir"/$pkgname-nox.initd \
		"$subpkgdir"/etc/init.d/$pkgname-nox
	install -Dm644 "$srcdir"/$pkgname-nox.confd \
		"$subpkgdir"/etc/conf.d/$pkgname-nox
}
sha512sums="
55656fb5fd282a3ed0e703b9b47ec9733a70cf6242cae956a5b2487ef2aeb88a04bf5d37c8fa88554edf95ab0821b76ebebb53e8fc43dc5889f8c730075d6e26  qbittorrent-4.4.2.tar.gz
07d5613daabbbe466f69a40b5903cd677cb253e07404865a66b5f5e7ba2dcd408742c52e3d8c20e114d768a68a7093884d5ac7c6515e4c88833c8da42c29ee03  qbittorrent-nox.initd
6e1e370379f854f5abb56000ee0c5bab040f053b042fe194ae02cf2ddd765c3ddc191a6677ee2036050146f278735fbe66d10239639921faec0399ee609d553d  qbittorrent-nox.confd
dfadae675d9a1b1262aa7d0f848e93dafeb20acff226aac5b88dd105481e9815319f2a71cdfbd46c2901cf4b283e0b14295e85e0c7a2ddfd21e43ea858c028ff  link-execinfo.patch
"
