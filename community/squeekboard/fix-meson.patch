From d19050e06d2ecc5218e50e9ef3a5279afa0daff8 Mon Sep 17 00:00:00 2001
From: Dorota Czaplejewicz <dorota.czaplejewicz@puri.sm>
Date: Mon, 4 Apr 2022 16:56:28 +0000
Subject: [PATCH 1/2] build: Replace missing crates.io dependency with
 Purism-hosted one

---
 Cargo.deps          |  2 +-
 Cargo.deps.online   |  4 ++++
 debian/cargo/config |  1 -
 debian/rules        |  2 +-
 meson.build         | 12 ++++++++----
 meson_options.txt   |  4 ++++
 6 files changed, 18 insertions(+), 7 deletions(-)
 create mode 100644 Cargo.deps.online

diff --git a/Cargo.deps b/Cargo.deps
index 04f99e68..31bc0dc1 100644
--- a/Cargo.deps
+++ b/Cargo.deps
@@ -29,4 +29,4 @@ features = ["v3_22"]
 
 [dependencies.gtk-sys]
 version = "0.9"
-features = ["v3_22"]
+features = ["v3_22"]
\ No newline at end of file
diff --git a/Cargo.deps.online b/Cargo.deps.online
new file mode 100644
index 00000000..df73d805
--- /dev/null
+++ b/Cargo.deps.online
@@ -0,0 +1,4 @@
+# Dependencies which are only used with online, crates.io builds.
+[patch.crates-io]
+# Dependency was yanked, but gio 0.7 needs it.
+fragile = { git = "https://source.puri.sm/dorota.czaplejewicz/fragile.git", tag = "0.3.0" }
\ No newline at end of file
diff --git a/meson.build b/meson.build
index 9928afc5..99e90443 100644
--- a/meson.build
+++ b/meson.build
@@ -96,19 +96,23 @@ cargo_toml_base = configure_file(
     configuration: path_data,
 )
 
-
-cargo_deps = files('Cargo.deps')
+cargo_patch = []
 
 if get_option('newer') == true
     cargo_build_flags += ['--features', 'glib_v0_14']
     cargo_deps = files('Cargo.deps.newer')
+else
+    cargo_deps = files('Cargo.deps')
+    if get_option('online') == true
+        cargo_patch = [files('Cargo.deps.online')]
+    endif
 endif
-    
+
 cat = find_program('cat')
 cargo_toml = custom_target(
     'Cargo.toml',
     output: 'Cargo.toml',
-    command: [cat, cargo_toml_base, cargo_deps],
+    command: [cat, cargo_toml_base, cargo_deps] + cargo_patch,
     capture: true,
 )
 
diff --git a/meson_options.txt b/meson_options.txt
index 16e9ae94..3e62b7be 100644
--- a/meson_options.txt
+++ b/meson_options.txt
@@ -11,6 +11,10 @@ option('newer',
        type: 'boolean', value: false,
        description: 'Build with dependencies newer than those of Byzantium')
 
+option('online',
+       type: 'boolean', value: true,
+       description: 'Pull packages from the internet while building, as opposed to a local regstry.')
+       
 option('strict',
        type: 'boolean', value: true,
        description: 'Turn more warnings into errors')
