# Contributor: Leo <thinkabit.ukim@gmail.com>
# Contributor: Łukasz Jendrysik <scadu@yandex.com>
# Contributor: Sebastian Wicki <gandro@gmx.net>
# Contributor: Sören Tempel <soeren+alpine@soeren-tempel.net>
# Maintainer: Carlo Landmeter <clandmeter@alpinelinux.org>
pkgname=mpd
pkgver=0.23
case $pkgver in
*.*.*) _branch=${pkgver%.*};;
*.*) _branch=$pkgver;;
esac
pkgrel=2
pkgdesc="Music daemon that plays MP3, FLAC, Ogg Vorbis files and Audio CDs"
url="https://musicpd.org"
pkgusers="mpd"
pkggroups="mpd audio"
# s390x: limited by pipewire
arch="all !s390x"
license="GPL-2.0-or-later"
makedepends="
	alsa-lib-dev
	avahi-dev
	boost-dev
	curl-dev
	expat-dev
	faad2-dev
	ffmpeg-dev
	flac-dev
	glib-dev
	gtest-dev
	icu-dev
	jack-dev
	lame-dev
	libao-dev
	libcap
	libcdio-paranoia-dev
	libid3tag-dev
	libmad-dev
	libmodplug-dev
	libmpdclient-dev
	libnfs-dev
	libogg-dev
	libsamplerate-dev
	libshout-dev
	libvorbis-dev
	meson
	opus-dev
	pulseaudio-dev
	py3-attrs
	py3-sphinx
	samba-dev
	soxr-dev
	wavpack-dev
	pipewire-dev
	fmt-dev
	"
checkdepends="gtest"
install="$pkgname.pre-install"
subpackages="$pkgname-doc $pkgname-dbg $pkgname-openrc"
source="https://www.musicpd.org/download/mpd/$_branch/mpd-$pkgver.tar.xz
	stacksize.patch
	mpd.initd
	mpd.confd
	libcdio-paranoia-version.patch
	disable-time-test.patch

	0001-neighbor-smbclient-use-gnu-pure.patch
	0002-neighbor-smbclient-FmtError-instead-of-FormatErrno.patch
	0003-storage-smbclient-add-StoragePlugin.prefixes.patch
	"

# secfixes:
#   0:
#     - CVE-2020-7465
#     - CVE-2020-7466

build() {
	abuild-meson \
		-Dshout=enabled \
		-Dopus=enabled \
		-Dmodplug=enabled \
		-Dnfs=enabled \
		-Dsmbclient=enabled \
		-Dffmpeg=enabled \
		-Dlibmpdclient=enabled \
		-Dcdio_paranoia=enabled \
		-Dzeroconf=avahi \
		-Dtest=true \
		-Ddocumentation=enabled \
		-Dwavpack=enabled \
		-Dpipewire=enabled \
		-Dsnapcast=true \
		. output
	meson compile ${JOBS:+-j ${JOBS}} -C output
}

check() {
	meson test --no-rebuild -v -C output
}

package() {
	DESTDIR="$pkgdir" meson install --no-rebuild -C output

	# mpd attempts to configure real-time scheduling on linux
	# add the capability which allows doing that
	# see: https://www.musicpd.org/doc/html/user.html#real-time-scheduling
	setcap cap_sys_nice+ep "$pkgdir"/usr/bin/mpd

	# provide a config that works by default
	install -d "$pkgdir"/etc
	sed	-e 's:\#user.*:user\t\t"mpd":' \
		-e 's:\#log_file.*:log_file\t\t"syslog":' \
		doc/mpdconf.example > "$pkgdir"/etc/mpd.conf
	install -m755 -D "$srcdir"/$pkgname.initd \
		"$pkgdir"/etc/init.d/$pkgname
	install -m644 -D "$srcdir"/$pkgname.confd \
		"$pkgdir"/etc/conf.d/$pkgname
	install -d -g audio -o mpd -m775 \
		"$pkgdir"/var/run/mpd \
		"$pkgdir"/var/log/mpd \
		"$pkgdir"/var/lib/mpd \
		"$pkgdir"/var/lib/mpd/playlists \
		"$pkgdir"/var/lib/mpd/music
}

sha512sums="
9602a76e08fbbb6e415e6e7e868f9647bcf5eb510a35cf369a64eeaff35d1c0f95b7bea7a8c2d14163994c78ab612ad32226948a4abeb021d23b7fb4c974e004  mpd-0.23.tar.xz
f60f6f3e921d20732c1a4c31a97f28660b43fd649e767d6c39661b6a90145231a79ad3f740ae0d706380b245ad040e98b661a513463c54cea161d1f64fc261e0  stacksize.patch
8547f685adf3cdc7b2aab7bedeed8c72242011c6f1e01750415ac21eba5ecf6b416239f527adbc904f72439c5d476249148cfb89965e33de1be69421e02c18e0  mpd.initd
41b2467f5b03f5c4dd7003cd5f56f6cfc1f67af7a9aa2538d70360f839625222bdd0c4b04c33e8cd52eeecfc354da3ca22f5aaab8aee357a5774aaf3503594e7  mpd.confd
1a8bc5ec04c75c2aa240d607dfb2790e57126299dd5449cd71d3ea1cdf00951d546bc58ecc4003e062c02a82c9879e1ac6e89c3ad4cdefe3adcde217df9c07ad  libcdio-paranoia-version.patch
4352009b1b0f9ffb19c51d476539656f2fe0ab9e34cd4a7ba65c1397d155cc408bb08da96d6ecf8f798a9af615da7662f8d1bf44ab35e9522177da44ba59fbf2  disable-time-test.patch
d805a5b4522e372df37e1258715d840800b2fb1e6b9e02689debd9283ead773e5e4a78c0c34f1ade13fd7beeb06be4333334798fa1545b3e9b51295f8a9c22c8  0001-neighbor-smbclient-use-gnu-pure.patch
c117409bb1580a8fb5247acc92232322a09de15282959f38a696977294bc9aa243957bf7eb7ec5b979fdc4786a7266b6cc2194348ee54ff55f34598f56d8d18e  0002-neighbor-smbclient-FmtError-instead-of-FormatErrno.patch
845380a8909f25d54e5a28b8d0b70708d42791ec2e4beeed23eeb5faabaad1b9f9e283ca4f9a488dc26d92d1b9c8e00d2a4501d5113b971b2e68a84a2e1e330f  0003-storage-smbclient-add-StoragePlugin.prefixes.patch
"
