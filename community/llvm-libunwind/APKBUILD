# Contributor: Eric Molitor <eric@molitor.org>
# Contributor: Jakub Jirutka <jakub@jirutka.cz>
# Maintainer: Rasmus Thomsen <oss@cogitri.dev>
pkgname=llvm-libunwind
# Note: Update together with llvm.
pkgver=12.0.1
_pkgname=libunwind
_llvmver=${pkgver%%.*}
pkgrel=0
pkgdesc="LLVM version of libunwind library"
url="https://llvm.org/"
arch="all !s390x"
license="Apache-2.0"
depends_dev="!libunwind-dev"
makedepends="cmake llvm$_llvmver-dev libedit-dev python3 linux-headers xz"
subpackages="$pkgname-dev"
source="https://github.com/llvm/llvm-project/releases/download/llvmorg-$pkgver/libunwind-$pkgver.src.tar.xz
https://github.com/llvm/llvm-project/releases/download/llvmorg-$pkgver/llvm-$pkgver.src.tar.xz
https://github.com/llvm/llvm-project/releases/download/llvmorg-$pkgver/libcxxabi-$pkgver.src.tar.xz
https://github.com/llvm/llvm-project/releases/download/llvmorg-$pkgver/libcxx-$pkgver.src.tar.xz
musl.patch
ppc.patch
libcxx-ssp-nonshared.patch
"
builddir="$srcdir/$_pkgname-$pkgver.src"
options="!check"

unpack(){
        cd "$srcdir"
        tar -xf "llvm-$pkgver.src.tar.xz"
        tar -xf "libunwind-$pkgver.src.tar.xz"
        tar -xf "libcxx-$pkgver.src.tar.xz"
        tar -xf "libcxxabi-$pkgver.src.tar.xz"
        mv "llvm-$pkgver.src" llvm
        mv "libunwind-$pkgver.src" libunwind
        mv "libcxx-$pkgver.src" libcxx
        mv "libcxxabi-$pkgver.src" libcxxabi

}

prepare(){
        patch libcxx/include/locale musl.patch
        patch libcxx/include/limits ppc.patch
        patch libcxx/CMakeLists.txt libcxx-ssp-nonshared.patch
	#set ssp_nonshared 
	sed -i 's,^# Setup flags.$,add_library_flags(ssp_nonshared),' libunwind/src/CMakeLists.txt
	sed -i 's,^# Setup flags.$,add_library_flags(ssp_nonshared),' libcxxabi/src/CMakeLists.txt
	sed -i 's,#ssp,,' libcxx/CMakeLists.txt
}

build() {
        mkdir -p "$builddir"
        cd "$builddir"

         cmake -G "Unix Makefiles" -S ../llvm -B build\
                -DCMAKE_BUILD_TYPE=MinSizeRel \
                -DCMAKE_VERBOSE_MAKEFILE=OFF \
                -DLIBCXX_HAS_MUSL_LIBC=ON \
                -DCMAKE_C_FLAGS_MINSIZEREL_INIT="$CFLAGS" \
                -DLLVM_ENABLE_PROJECTS="libunwind" \
                -DCMAKE_CXX_FLAGS_MINSIZEREL_INIT="$CXXFLAGS -fpermissive" \
                -DCMAKE_EXE_LINKER_FLAGS_MINSIZEREL_INIT="$LDFLAGS -lssp_nonshared -Wl,-z,stack-size=2097152" \
                -DCMAKE_INSTALL_PREFIX=/usr \
                -DCMAKE_SKIP_INSTALL_RPATH=ON \
                -DLLVM_INCLUDE_TESTS=ON
	 echo $LDFLAGS
         cd build
        make unwind
}


package() {
	make -C build install-unwind DESTDIR="$pkgdir"
	mkdir -p "$pkgdir"/usr/include/mach-o
	cp "$srcdir/libunwind"/include/*.h "$pkgdir"/usr/include/
	cp "$srcdir/"libunwind/include/mach-o/*.h "$pkgdir"/usr/include/mach-o/
}


sha512sums="847b6ba03010a43f4fdbfdc49bf16d18fd18474d01584712e651b11191814bf7c1cf53475021d9ee447ed78413202b4ed97973d7bdd851d3e49f8d06f55a7af4  libunwind-12.0.1.src.tar.xz
ff674afb4c8eea699a4756f1bb463f15098a7fa354c733de83c024f8f0cf238cd5f19ae3ec446831c7109235e293e2bf31d8562567ede163c8ec53af7306ba0f  llvm-12.0.1.src.tar.xz
c7b236e9afe8d6bba297e1eca12ca0e03fbd1b028b9627154186d27eb2e035cd33eddb72511a38d0827de347a487e180c32c1798759c4283b9fbbf338a015bb9  libcxxabi-12.0.1.src.tar.xz
c9f9a546d6a312ff6e7c85a044ce801fe7bfca1c349767b3f3c5ea16656b8906a8078f25de38138c9844c4b2646238fd17d890438cd10391cd9e4a430f9064a0  libcxx-12.0.1.src.tar.xz
80dc4c8bfe3213b3d740c7c7f406350d6c399e1c0f285f69984c70d2cd57ad6fc835e9707361f175aab984fc08da6058b4509848588d195efcbf8db218f8f818  musl.patch
0e03f811f0f4318ccb53f2f42d88f92e75877e73c5e21145e5b54a9b0a586f97e9e01f6b883c9b7a2c0a6719a8d03bae94f9fdec58ef86bc011c374e005490e9  ppc.patch
1cb737ef848325f357dc9099ebe549b97cb2a3a0ede433a04094afc46d4e0f49f4b1f5672b92175070f8f3049fd5dfcf307a5fe87748ceac18e3b02c92c6eb07  libcxx-ssp-nonshared.patch"
