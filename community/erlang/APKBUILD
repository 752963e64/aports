# Contributor: Michael Mason <ms13sp@gmail.com>
# Contributor: Gabriele Santomaggio <g.santomaggio@gmail.com>
# Contributor: Marlus Saraiva <marlus.saraiva@gmail.com>
# Maintainer: Daniel Isaksen <d@duniel.no>
pkgname=erlang
pkgver=22.2.7
pkgrel=0
pkgdesc="General-purpose programming language and runtime environment"
url="https://www.erlang.org/"
license="Apache-2.0"
arch="all !mips !mips64"
depends="$pkgname-kernel $pkgname-stdlib $pkgname-compiler"
makedepends="perl-dev perl zlib-dev ncurses-dev openssl-dev openjdk8
	unixodbc-dev autoconf wxgtk-dev glu-dev"
subpackages="$pkgname-dev
	$pkgname-asn1:_mv_erlang_lib
	$pkgname-common-test:_mv_erlang_lib
	$pkgname-compiler:_mv_erlang_lib
	$pkgname-crypto:_mv_erlang_lib
	$pkgname-debugger:_mv_erlang_lib
	$pkgname-dialyzer:_mv_erlang_lib
	$pkgname-diameter:_mv_erlang_lib
	$pkgname-edoc:_mv_erlang_lib
	$pkgname-eldap:_mv_erlang_lib
	$pkgname-erl-docgen:_mv_erlang_lib
	$pkgname-erl-interface:_mv_erlang_lib
	$pkgname-erts:_mv_erlang_lib
	$pkgname-et:_mv_erlang_lib
	$pkgname-eunit:_mv_erlang_lib
	$pkgname-ftp:_mv_erlang_lib
	$pkgname-hipe:_mv_erlang_lib
	$pkgname-inets:_mv_erlang_lib
	$pkgname-jinterface:_mv_erlang_lib
	$pkgname-kernel:_mv_erlang_lib
	$pkgname-megaco:_mv_erlang_lib
	$pkgname-mnesia:_mv_erlang_lib
	$pkgname-observer:_mv_erlang_lib
	$pkgname-odbc:_mv_erlang_lib
	$pkgname-os-mon:_mv_erlang_lib
	$pkgname-parsetools:_mv_erlang_lib
	$pkgname-public-key:_mv_erlang_lib
	$pkgname-reltool:_mv_erlang_lib
	$pkgname-runtime-tools:_mv_erlang_lib
	$pkgname-sasl:_mv_erlang_lib
	$pkgname-snmp:_mv_erlang_lib
	$pkgname-ssh:_mv_erlang_lib
	$pkgname-ssl:_mv_erlang_lib
	$pkgname-stdlib:_mv_erlang_lib
	$pkgname-syntax-tools:_mv_erlang_lib
	$pkgname-tftp:_mv_erlang_lib
	$pkgname-tools:_mv_erlang_lib
	$pkgname-wx:_mv_erlang_lib
	$pkgname-xmerl:_mv_erlang_lib
	"
source="https://github.com/erlang/otp/archive/OTP-$pkgver.tar.gz
	0005-Do-not-install-nteventlog-and-related-doc-files-on-n.patch
	0010-fix-nteventlog-remove.patch"

builddir="$srcdir/otp-OTP-$pkgver"

build() {
	export CPPFLAGS="-D_BSD_SOURCE $CPPFLAGS"
	export PATH="/usr/lib/jvm/java-1.8-openjdk/bin:$PATH"

	./otp_build autoconf
	./configure \
		--prefix=/usr \
		--sysconfdir=/etc \
		--mandir=/usr/share/man \
		--infodir=/usr/share/info \
		--host="$CHOST" \
		--build="$CBUILD" \
		--enable-threads \
		--enable-shared-zlib \
		--enable-ssl=dynamic-ssl-lib
	make
}

check() {
	ERL_TOP="$builddir" make release_tests
}

package() {
	make DESTDIR="$pkgdir" install
}

_mv_erlang_lib() {
	local lib=$(echo ${subpkgname#$pkgname-} | tr '-' '_')
	case "$lib" in
		asn1)		depends="$depends $pkgname-crypto";;
		common_test)	depends="$depends $pkgname-xmerl";;
		compiler)	depends="$depends $pkgname-syntax-tools $pkgname-parsetools $pkgname-erl-interface";;
		eunit)		depends="$depends $pkgname-common-test";;
		public_key)	depends="$depends $pkgname-asn1";;
		sasl)		depends="$depends $pkgname-inets";;
		snmp)		depends="$depends $pkgname-inets";;
		ssh)		depends="$depends $pkgname-public-key $pkgname-inets";;
		ssl)		depends="$depends $pkgname-public-key $pkgname-inets";;
	esac

	mkdir -p "$subpkgdir"/usr/lib/erlang/lib
	rm -f "$pkgdir"/usr/lib/erlang/lib/$lib-*/src/*.erl
	mv "$pkgdir"/usr/lib/erlang/lib/$lib-* "$subpkgdir"/usr/lib/erlang/lib/
}

dev() {
	set -x
	local i=''
	depends="$pkgname=$pkgver-r$pkgrel $depends_dev"
	pkgdesc="$pkgdesc (development files)"

	cd "$pkgdir"
	local libdirs=usr/
	[ -d lib/ ] && libdirs="lib/ $libdirs"
	for i in usr/include usr/lib/pkgconfig usr/share/aclocal\
			usr/share/gettext usr/bin/*-config		\
			usr/share/vala/vapi usr/share/gir-[0-9]*	\
			usr/share/qt*/mkspecs				\
			usr/lib/qt*/mkspecs				\
			usr/lib/cmake					\
			$(find . -name include -type d)			\
			$(find $libdirs -name '*.[acho]'		\
			-o -name '*.prl' 2>/dev/null); do

		if [ -e "$pkgdir/$i" ] || [ -L "$pkgdir/$i" ]; then
			d="$subpkgdir/${i%/*}"  # dirname $i
			mkdir -p "$d"
			mv "$pkgdir/$i" "$d"
			rmdir "$pkgdir/${i%/*}" 2>/dev/null || true
		fi
	done

	# move *.so links needed when linking the apps to -dev packages
	for i in lib/*.so usr/lib/*.so; do
		if [ -L "$i" ]; then
			mkdir -p "$subpkgdir"/"${i%/*}"
			mv "$i" "$subpkgdir/$i"
		fi
	done
}

# helper script to manually check the dependencies of subpackages
verifydeps() {
	local _p
	for _p in $subpackages; do
		case $_p in
			*:*) _p=${_p%:*};;
			*) continue;;
		esac
		local _subdir="$pkgdir/../$_p"
		local _pkginfo="$pkgdir/../.control.$_p"/.PKGINFO
		msg "$_p"
		grep '^depend ='  $_pkginfo || true
		find "$_subdir" -name '*.app' | while read f; do
			echo "  $_f"
			sed -n '/{runtime_dependencies/,/}/p' $f
		done
	done
}


sha512sums="1746acd526eda37c769b70bba1ad0f73ee1e658d05d0cbbe4063f34c11f8061932b2cde04df725537f5c5b81b537897ada2f0f9b6b18b7554b0f7596c492906b  OTP-22.2.7.tar.gz
6a711e25b55816527c0a793e45dafb9a95b0a20fa537f8e03fb918e0137f1b1f60e414861a7005b8230a72e3e2f5e0caedb054a6c492b6f6f859ddbad47d2175  0005-Do-not-install-nteventlog-and-related-doc-files-on-n.patch
dbbc05908cd4b1a3842ff32afcef8a0621b1ec532e83d70fed4ee9263b3f82afc0d173c7a7c776196c8f54c2ab2bca3c9ce35da676dedd5802dbc23111525577  0010-fix-nteventlog-remove.patch"
