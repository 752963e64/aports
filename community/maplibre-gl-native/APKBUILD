# Contributor: Bart Ribbers <bribbers@disroot.org>
# Maintainer: Bart Ribbers <bribbers@disroot.org>
pkgname=maplibre-gl-native
pkgver=2.0.1
pkgrel=4
pkgdesc="Open-source alternative to Mapbox GL Native"
url="https://maplibre.org/"
arch="all"
license="BSD-2-Clause"
# It searches for Qt6 dependencies but it actually uses Qt5
makedepends="
	cmake
	icu-dev
	qt5-qtbase-dev
	qt6-qtbase-dev
	qt6-qtlocation-dev
	rapidjson-dev
	samurai
	"
source="https://dev.alpinelinux.org/archive/maplibre-gl-native/maplibre-gl-native-$pkgver.tar.xz
	cstdint.patch
	"
options="!check" # No tests
subpackages="$pkgname-dev"
builddir="$srcdir/maplibre-native-qt"

provides="mapbox-gl-native=$pkgver-r$pkgrel"
replaces="mapbox-gl-native"

_disturl="dev.alpinelinux.org:/archive/$pkgname/"

snapshot() {
	clean
	deps
	mkdir -p "$srcdir" && cd "$srcdir"
	git clone https://github.com/maplibre/maplibre-native-qt -b v$pkgver --recursive
	tar cv maplibre-native-qt | xz -T0 -9 -vv - > $SRCDEST/$pkgname-$pkgver.tar.xz
	rsync --progress -La $SRCDEST/$pkgname-$pkgver.tar.xz $_disturl
}

prepare() {
	default_prepare

	# We prefer to build with our system version
	rm -r dependencies/maplibre-gl-native/vendor/mapbox-base/extras/rapidjson
}

build() {
	cmake -B build -G Ninja \
		-DCMAKE_BUILD_TYPE=None \
		-DCMAKE_INSTALL_PREFIX=/usr \
		-DCMAKE_INSTALL_LIBDIR=lib \
		-DBUILD_SHARED_LIBS=TRUE \
		-DQT_VERSION_MAJOR=5 \
		-DMBGL_WITH_WERROR=OFF \
		-DMBGL_WITH_QT=ON
	cmake --build build
}

package() {
	DESTDIR="$pkgdir" cmake --install build
}

sha512sums="
a9eba8197cea1f792169e82aafe20c4b1cdfd6ab48e2b1f7623cacad5bab95a75948fe85e6b1bbe234b3ecad1836c0089777703403cbc56c56c51efe21df9ebe  maplibre-gl-native-2.0.1.tar.xz
60c7d780645899a7874c1b6f607982ab70cb8369e491fe9b3711a2bd1b7415b77200b405b0befa20e58fd2553410174845cf771a35aa049bc5bd4f31c3bf3d3a  cstdint.patch
"
