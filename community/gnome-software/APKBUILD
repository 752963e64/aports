# Contributor: Rasmus Thomsen <oss@cogitri.dev>
# Maintainer: Rasmus Thomsen <oss@cogitri.dev>
pkgname=gnome-software
pkgver=41.3
pkgrel=0
pkgdesc="Software lets you install and update applications and system extensions"
url="https://wiki.gnome.org/Apps/Software"
# s390x, mips64 and riscv64 blocked by polkit
arch="all !s390x !mips64 !riscv64"
license="GPL-2.0-or-later"
depends="gnome-software-plugin-apk"
makedepends="meson appstream-dev gdk-pixbuf-dev libxmlb-dev glib-dev gtk+3.0-dev
	json-glib-dev libsoup-dev gspell-dev polkit-dev gtk-doc ostree-dev
	flatpak-dev libgudev-dev libhandy1-dev gsettings-desktop-schemas-dev"
options="!check" # lots of failing tests
subpackages="$pkgname-lang $pkgname-doc $pkgname-dbg
	$pkgname-dev $pkgname-lib $pkgname-plugin-flatpak:flatpak_plugin"
source="https://download.gnome.org/sources/gnome-software/${pkgver%.*}/gnome-software-$pkgver.tar.xz
	org.gnome.software.gschema.override"

case "$CARCH" in
	x86|x86_64|aarch64|armv7) makedepends="$makedepends fwupd-dev" ;;
esac

build() {
	case "$CARCH" in
		x86|x86_64|aarch64|armv7) conf="-Dfwupd=true" ;;
		*) conf="-Dfwupd=false" ;;
	esac


	abuild-meson \
		-Dvalgrind=false \
		-Dmalcontent=false \
		-Dpackagekit=false \
		-Dexternal_appstream=true \
		$conf \
		. output
	meson compile ${JOBS:+-j ${JOBS}} -C output
}

check() {
	meson test --no-rebuild -v -C output
}

package() {
	DESTDIR="$pkgdir" meson install --no-rebuild -C output
	mkdir -p "$pkgdir"/usr/share/glib-2.0/schemas/
	sed "s|@CARCH@|$CARCH|g" "$srcdir"/org.gnome.software.gschema.override > \
		"$pkgdir"/usr/share/glib-2.0/schemas/org.gnome.software.gschema.override
}

dev() {
	default_dev

	amove usr/lib/gnome-software/libgnomesoftware.so
}

lib() {
	pkgdesc="$pkgdesc (shared library)"
	depends=""

	amove usr/lib/gnome-software/libgnomesoftware.so.*
}

flatpak_plugin() {
	pkgdesc="$pkgdesc (flatpak plugin)"
	install_if="$pkgname=$pkgver-r$pkgrel flatpak"
	depends=""

	amove usr/lib/gnome-software/plugins-16/libgs_plugin_flatpak.so
	amove usr/share/metainfo/org.gnome.Software.Plugin.Flatpak.metainfo.xml
}

sha512sums="
7b19ed7e3b6f8662b6351fbb6eddb45f99cdbf9e6912e11b36301cdfd6f62cb3256da031e6640f9ad397384a23530d11488c78a1af60ce130a99838f97f8a0ed  gnome-software-41.3.tar.xz
07f82ea072ba303d785964841b3b04c963b86b79a7b1cc127b295cc0854f061a4556f6e4af4f780ae0c4de63ddd9e722db2bccd860e0c2abc8ceb6769413281f  org.gnome.software.gschema.override
"
