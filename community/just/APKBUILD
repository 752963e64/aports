# Contributor: Jakub Jirutka <jakub@jirutka.cz>
# Maintainer: Jakub Jirutka <jakub@jirutka.cz>
pkgname=just
pkgver=0.10.0
pkgrel=0
pkgdesc="Just a command runner"
url="https://github.com/casey/just"
arch="x86_64 armv7 armhf aarch64 x86 ppc64le"  # limited by rust/cargo
license="CC0-1.0"
checkdepends="bash fzf"
makedepends="cargo"
subpackages="
	$pkgname-bash-completion
	$pkgname-fish-completion
	$pkgname-zsh-completion
	"
source="https://github.com/casey/just/archive/$pkgver/just-$pkgver.tar.gz
	$pkgname-bump-target-to-2.0.0.patch::https://github.com/casey/just/commit/dbf142369b1b2f0821fc6e096d5e63c3eff56ec2.patch
	tests-fix-exit-status.patch
	minimize-size.patch
	"

build() {
	cargo build --release --locked
}

check() {
	# Skipped tests are somehow broken.
	cargo test --locked -- \
		--skip choose::default \
		--skip edit::editor_precedence \
		--skip choose::multiple_recipes \
		--skip misc::env_var_functions
}

package() {
	cargo install --locked --path . --root="$pkgdir/usr"
	rm "$pkgdir"/usr/.crates*

	install -D -m 644 completions/just.bash \
		"$pkgdir"/usr/share/bash-completion/completions/$pkgname
	install -D -m 644 completions/just.fish \
		"$pkgdir"/usr/share/fish/completions/$pkgname.fish
	install -D -m 644 completions/just.zsh \
		"$pkgdir"/usr/share/zsh/site-functions/_$pkgname
}

sha512sums="
735f9b4d65af2588cd5d18afac28a777774eb1a138a10736393350533a655f37b074a30b75f51a35cb60aa34061060044228d1aff521c681ee3907926a69f55f  just-0.10.0.tar.gz
3447ebb728560debab9ba393c521810a62200576805b42315c9d653cad37b9afb756eb18091dab3ec357ce3e6ebefb299381b06a13ef9becbb59b110837af96f  just-bump-target-to-2.0.0.patch
d8c3be11ab827b09c101b136cabbef2cc61fffffd7647ee1de82f8378ee93ef861c17171bd16fd47e8ffb4eaf40239aee9719cc4c8c0757d7e2fa44de52ccff4  tests-fix-exit-status.patch
413f4c196e88d1d33cd6bc01a5ed920f6f5cde3c71c5c9117541fd40536ed0f90e4b7baf20670e548dfcd9705c608b591294915d7632343d0b3f9fdb33d3e098  minimize-size.patch
"
