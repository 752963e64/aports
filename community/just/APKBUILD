# Contributor: Jakub Jirutka <jakub@jirutka.cz>
# Maintainer: Jakub Jirutka <jakub@jirutka.cz>
pkgname=just
pkgver=1.5.0
pkgrel=0
pkgdesc="Just a command runner"
url="https://github.com/casey/just"
# s390x blocked by nix crate, rust currently broken on riscv64
arch="x86_64 armv7 armhf aarch64 x86 ppc64le"
license="CC0-1.0"
checkdepends="bash fzf"
makedepends="cargo"
subpackages="
	$pkgname-bash-completion
	$pkgname-fish-completion
	$pkgname-zsh-completion
	"
source="https://github.com/casey/just/archive/$pkgver/just-$pkgver.tar.gz
	minimize-size.patch
	"

prepare() {
	default_prepare

	cargo fetch --locked
}

build() {
	cargo build --release --frozen
}

check() {
	# Skipped tests are somehow broken.
	cargo test --frozen -- \
		--skip choose::default \
		--skip edit::editor_precedence \
		--skip choose::multiple_recipes \
		--skip functions::env_var_functions
}

package() {
	cargo install --locked --offline --path . --root="$pkgdir/usr"
	rm "$pkgdir"/usr/.crates*

	install -D -m 644 completions/just.bash \
		"$pkgdir"/usr/share/bash-completion/completions/$pkgname
	install -D -m 644 completions/just.fish \
		"$pkgdir"/usr/share/fish/completions/$pkgname.fish
	install -D -m 644 completions/just.zsh \
		"$pkgdir"/usr/share/zsh/site-functions/_$pkgname
}

sha512sums="
bf52f0584ddb08a96e1617b429e065d4e0f3b378b7a4658617362e7c1b5c577262215a39b1185d3982002caf7939b1a714763c9d75f575bcd28786d087d7f95a  just-1.5.0.tar.gz
ea1840fe173d8f1dfa2387d6eebdccb9abe3567508d9d3fddb488daa203c063248fd5ef9b8bb752d4fe33e39c2610440bc63b5fabf6bbfc38b7d7152dd48bf8a  minimize-size.patch
"
