# Contributor: Rasmus Thomsen <oss@cogitri.dev>
# Contributor: Sergei Lukin <sergej.lukin@gmail.com>
# Contributor: Jiri Horner <laeqten@gmail.com>
# Maintainer: knuxify <knuxify@gmail.com>
pkgname=webkit2gtk-4.1
pkgver=2.38.0
pkgrel=2
pkgdesc="Portable web rendering engine WebKit for GTK+ - GTK+3 libsoup3 version"
url="https://webkitgtk.org/"
arch="all"
license="LGPL-2.0-or-later AND BSD-2-Clause"
depends="bubblewrap xdg-dbus-proxy dbus:org.freedesktop.Secrets"
makedepends="
	bison
	clang
	cmake
	enchant2-dev
	flex
	geoclue-dev
	gnutls-dev
	gobject-introspection-dev
	gperf
	gst-plugins-bad-dev
	gst-plugins-base-dev
	gstreamer-dev
	gtk+3.0-dev
	hyphen-dev
	icu-dev
	lcms2-dev
	libgcrypt-dev
	libjpeg-turbo-dev
	libmanette-dev
	libpng-dev
	libseccomp-dev
	libsecret-dev
	libsoup3-dev
	libwebp-dev
	libwpe-dev
	libwpebackend-fdo-dev
	libxml2-dev
	libxslt-dev
	libxt-dev
	llvm
	mesa-dev
	openjpeg-dev
	pango-dev
	python3
	ruby
	samurai
	sqlite-dev
	woff2-dev
	"
replaces="webkit"
options="!check" # upstream doesn't package them in release tarballs: Tools/Scripts/run-gtk-tests: Command not found
subpackages="$pkgname-dbg $pkgname-lang $pkgname-dev"
source="https://webkitgtk.org/releases/webkitgtk-$pkgver.tar.xz
	xdg-proxy.patch
	dbus-sandbox.patch
	dbus-sandbox-2.patch
	dbus-sandbox-3.patch
	riscv64-asm.patch
	"
builddir="$srcdir/webkitgtk-$pkgver"

case "$CARCH" in
s390x)
	;;
*)
	makedepends="$makedepends lld"
	;;
esac

build() {
	case "$CARCH" in
	armv7)
		# clang fails to build armv7 only due to some NEON related thing.
		# https://github.com/WebKit/WebKit/pull/1233 should fix it
		;;
	s390x)
		export CC=clang
		export CXX=clang++
		;;
	*)
		# the debug symbols become 1/2 the size, and actual webkit becomes
		# smaller too.
		export CC=clang
		export CXX=clang++
		export LDFLAGS="$LDFLAGS -fuse-ld=lld"
		;;
	esac

	case "$CARCH" in
	arm*|aarch64|s390x|riscv64)
		# arm: seemingly broken?
		# s390x/riscv64: no lld
		;;
	*)
		local lto="-DLTO_MODE=thin"
		;;
	esac

	# significantly reduce debug symbol size
	export CFLAGS="$CFLAGS -g1"
	export CXXFLAGS="$CXXFLAGS -g1"

	cmake -B build -G Ninja \
		-DPORT=GTK \
		-DCMAKE_BUILD_TYPE=Release \
		-DCMAKE_SKIP_RPATH=ON \
		-DCMAKE_INSTALL_PREFIX=/usr \
		-DCMAKE_INSTALL_LIBDIR=lib \
		-DENABLE_DOCUMENTATION=OFF \
		-DENABLE_JOURNALD_LOG=OFF \
		-DENABLE_MINIBROWSER=ON \
		-DENABLE_SAMPLING_PROFILER=OFF \
		$lto
	cmake --build build
}

check() {
	ninja -C build check
}

package() {
	DESTDIR="$pkgdir" cmake --install build
	mv "$pkgdir"/usr/bin/WebKitWebDriver "$pkgdir"/usr/bin/WebKitWebDriver-4.1
}

sha512sums="
8380d11eedec3c4eedf3a0f5591fd279ee42b28a38aaa13d7eb88f8a004cbe8aac7dc8f19409440e5c1272ad1555a781f1242bca6c89beed2dc5fd2de5f3d525  webkitgtk-2.38.0.tar.xz
2cc4571c35f8f79369de1c11ff16b548b57c8c990fcad7a4ab35271672f163bbd1483ab07d2e5f9d23dc05a25c058db93672871d95b0c01ff9dce811a4f5831d  xdg-proxy.patch
545b96d24be794b63bee5c79ed76dc9199dc30578f0834478b61f0b86cadf8ce09dd775e4484d642e7a826c032b395c12caf5f13fe2ddbf08c34c94bbc670082  dbus-sandbox.patch
15b755fc01d948df1dc3765d5a4a1b106918738f50d719ba7d4e97f6cdff559be039b30e89633c4f13221a84946f31de7f1dc7e0b3f27c83df60c26a01163389  dbus-sandbox-2.patch
44e7253830746b9cccbf00215bf9727ecd5b6bfe2488add19956e21bab8fb15d9ecf5f7c8ad8a9bd3a635a82865a654fde8bf940f6ea01fa5ee30eac903e1123  dbus-sandbox-3.patch
8a92673cab0c67bc2f8df4c7f263b1e840fbe904ace3137e9b39ee8bf46c7ea83f98c92172020d831f10a01c1c99aaf617f6ef700e32babb19537d2840625f48  riscv64-asm.patch
"
