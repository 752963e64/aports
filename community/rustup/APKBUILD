# Contributor: Rasmus Thomsen <oss@cogitri.dev>
# Maintainer: Rasmus Thomsen <oss@cogitri.dev>
pkgname=rustup
pkgver=1.25.1
pkgrel=0
pkgdesc="The Rust toolchain installer"
url="https://rustup.rs/"
arch="aarch64 x86_64" # limited by upstream only supporting these arches
license="Apache-2.0"
makedepends="cargo perl openssl-dev>3 zlib-dev curl-dev"
options="!check" # Doesn't recognise x86_64-unknown-linux-musl yet
subpackages="
	$pkgname-bash-completion:bashcomp:noarch
	$pkgname-fish-completion:fishcomp:noarch
	$pkgname-zsh-completion:zshcomp:noarch"
source="
	$pkgname-$pkgver.tar.gz::https://github.com/rust-lang/rustup.rs/archive/$pkgver.tar.gz
	dont-copy-rustup-bin.patch"

# It doesn't like our custom triplet
export RUSTUP_OVERRIDE_BUILD_TRIPLE="$CARCH-unknown-linux-musl"
export CARGO_HOME="$srcdir/cargo"

build() {
	cargo build --release --features no-self-update --bin rustup-init
}

check() {
	cargo test --release
}

package() {
	install -d "$pkgdir"/usr/bin
	install -m755 target/release/rustup-init "$pkgdir"/usr/bin/

	ln -s target/release/rustup-init rustup
	./rustup completions zsh > rustup.zsh
	./rustup completions bash > rustup.bash
	./rustup completions fish > rustup.fish
}

bashcomp() {
	pkgdesc="$pkgdesc - bash completion"
	install_if="$pkgname=$pkgver-r$pkgrel bash-completion"

	install -Dm644 "$builddir"/rustup.bash \
		"$subpkgdir"/usr/share/bash-completion/completions/$pkgname
}

fishcomp() {
	pkgdesc="$pkgdesc - fish shell completion"
	install_if="$pkgname=$pkgver-r$pkgrel fish"

	install -Dm644 "$builddir"/rustup.fish \
		"$subpkgdir"/usr/share/fish/completions/$pkgname.fish
}

zshcomp() {
	pkgdesc="$pkgdesc -zsh completion"
	depends=""
	install_if="$pkgname=$pkgver-r$pkgrel zsh"

	install -Dm644 "$builddir"/rustup.zsh \
		"$subpkgdir"/usr/share/zsh/site-functions/_$pkgname
}
sha512sums="
a77cb34ba0c2e7577c8acbd474197aabaa84e3b64b3c42f1d0c328df55c6accbe412aba9a787f0ea2f0654f085475455c9c488b2b6de34ad8889a2716d1e8d0c  rustup-1.25.1.tar.gz
1db6d3833327d8c6329bd8a0ed4704b0dd0c6e34e1b3753ab2d34506f5e318129571116612a2bcc58d12f553b466a91302966e40ed2e2b661d2b0ab6c8eaa51a  dont-copy-rustup-bin.patch
"
