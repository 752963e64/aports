# Contributor: Bart Ribbers <bribbers@disroot.org>
# Maintainer: Bart Ribbers <bribbers@disroot.org>
pkgname=mautrix-telegram
pkgver=0.8.2
pkgrel=0
pkgdesc="A Matrix-Telegram hybrid puppeting/relaybot bridge"
url="https://github.com/tulir/mautrix-telegram"
arch="noarch"
license="AGPL-3.0-or-later"
depends="python3 py3-aiohttp py3-mautrix py3-ruamel.yaml py3-magic py3-sqlalchemy py3-alembic py3-commonmark py3-telethon py3-telethon-session-sqlalchemy"
makedepends="py3-setuptools"
checkdepends="py3-pytest py3-pytest-runner py3-pytest-mock py3-pytest-asyncio"
install="$pkgname.pre-install $pkgname.post-upgrade"
subpackages="$pkgname-openrc"
source="https://github.com/tulir/mautrix-telegram/archive/v$pkgver/mautrix-telegram-v$pkgver.tar.gz
	mautrix-telegram.initd
	mautrix-telegram.confd
	default-log-dir.patch
	0001-update-telethon.patch
	0002-update-mautrix.patch
	"

build() {
	python3 setup.py build
}

check() {
	pytest
}

package() {
	python3 setup.py install --prefix=/usr --root="$pkgdir"

	# Remove installed tests
	local _site_packages=$(python3 -c "import site; print(site.getsitepackages()[0])")
	rm -r "$pkgdir/$_site_packages"/tests/

	install -Dm644 mautrix_telegram/example-config.yaml "$pkgdir"/etc/mautrix-telegram/example-config.yaml
	install -Dm755 "$srcdir"/mautrix-telegram.initd "$pkgdir"/etc/init.d/mautrix-telegram
	install -Dm644 "$srcdir"/mautrix-telegram.confd "$pkgdir"/etc/conf.d/mautrix-telegram

	mkdir -p "$pkgdir"/usr/share/mautrix-telegram
	mv \
		"$pkgdir"/usr/alembic \
		"$pkgdir"/usr/alembic.ini \
		"$pkgdir"/usr/share/mautrix-telegram/
}
sha512sums="4604201b7079a568f1d2a3f55f6ccde53930c651e9c5a78d3721c551fa4e480af6333166123ee27dd38f114a1eb163ae65c585d42ebdb1cd18f227d22e5f12b6  mautrix-telegram-v0.8.2.tar.gz
394e50290a212e0f68a9b4d53dfa181df3cc0494f01c88d701db018bc1ec454f0f92fd56b750c6229ffaf0d1b6832f9f2177a3a1444b9a3b92d23ad3194b566c  mautrix-telegram.initd
7b3c15dd2d0671c4c777bcf4f2e905d9a0b639a54828313ac9db1a9793fde3d092e92f18aa896bff94b9a81db3df74b3de65661c6879cb648d36f5cec2437df0  mautrix-telegram.confd
7e75b46226c928f3aa64b13a3042eae7da164006b262f40ff5bbfdda9e91c80c2189a009735539d2349a638ad11c6ce0bf4bd93db12f485cb4906553283512c3  default-log-dir.patch
3a7d093ed60a5e282edc536f66f5c61f0c5c57619eb6572d1396a261563d3f70d2d1c1570fb58b86ee8b0c3cbb3843ed3c72e582cf311dfc07819d3b32719433  0001-update-telethon.patch
c6731cfff0cdc96b9a9cc48478e825ff855ffaffd3e3095c25a844e779e6289d053d7175ed5917ca413073f02da414d65b45d26aaad3641a6ab2694850735b2d  0002-update-mautrix.patch"
