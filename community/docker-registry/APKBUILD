# Contributor: Christian Kampka <christian@kampka.net>
# Maintainer:
pkgname=docker-registry
pkgver=2.8.1
pkgrel=7
pkgdesc="An implementation of the Docker Registry HTTP API V2 for use with docker 1.6+"
url="https://github.com/distribution/distribution"
arch="all !riscv64" # undefined syscall
license="Apache-2.0"
makedepends="git go"
install="$pkgname.pre-install"
pkgusers="docker-registry"
pkggroups="docker-registry"
subpackages="$pkgname-openrc"
source="$pkgname-$pkgver.tar.gz::$url/archive/v$pkgver.tar.gz
	docker-registry.initd
	config-example.patch"
builddir="$srcdir/src/github.com/docker/distribution"
options="net"

export GOPATH="$srcdir"
export GOCACHE="$srcdir/go-cache"
export GOTMPDIR="$srcdir"
export GOMODCACHE="$srcdir/go"

prepare() {
	mkdir -p "${builddir%/*}"
	mv "$srcdir"/distribution-$pkgver "$builddir"

	default_prepare
}

build() {
	export GO111MODULE=off

	make clean binaries \
		DISTRIBUTION_DIR="$builddir" \
		VERSION="$pkgver"
}

check() {
	./bin/registry --version
}

package() {
	install -D -m 755 bin/registry \
		"$pkgdir"/usr/bin/$pkgname

	install -D -m 644 cmd/registry/config-example.yml \
		"$pkgdir"/etc/$pkgname/config.yml

	install -D -m 644 LICENSE \
		"$pkgdir"/usr/share/licenses/$pkgname

	install -D -m 755 "$srcdir"/$pkgname.initd \
		"$pkgdir"/etc/init.d/$pkgname

	install -d -m 750 -o $pkgusers -g $pkggroups \
		"$pkgdir"/var/lib/$pkgname
}

sha512sums="
b9c8525051458ff4bf4592ca3ddba83c4325e88c6812ddb28c1567e331c1571f112e3b646ca970f0fe420f3b1d61d00f7151450d7b9948a08733606255731266  docker-registry-2.8.1.tar.gz
3a79bb2568eb40a33de53f8ddf450efff415eddacb139937ef9c2d243a61466f46673785b2b0579aec54aae5d9d76c00e3bbf355e2b7842e0456ec5cf0c2b990  docker-registry.initd
5a38f4d3f0ee5cd00c0a5ced744eb5b29b839da5921adea26c5de3eb88b6b2626a7ba29b1ab931e5f8fbfafbed8c94cb972a58737ec0c0a69cf515c32139e387  config-example.patch
"
