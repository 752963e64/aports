# Contributor: Christian Kampka <christian@kampka.net>
# Maintainer:
pkgname=docker-registry
pkgver=2.8.1
pkgrel=7
pkgdesc="An implementation of the Docker Registry HTTP API V2 for use with docker 1.6+"
url="https://github.com/distribution/distribution"
# riscv64: undefined syscall
arch="all !riscv64"
license="Apache-2.0"
makedepends="git go"
install="$pkgname.pre-install"
pkgusers="docker-registry"
pkggroups="docker-registry"
subpackages="$pkgname-openrc"
source="$pkgname-$pkgver.tar.gz::https://github.com/distribution/distribution/archive/v$pkgver.tar.gz
	config-example.patch
	$pkgname.initd
	$pkgname.confd
	$pkgname.logrotate
	"
builddir="$srcdir/src/github.com/docker/distribution"
options="net"

export GOPATH="$srcdir"
export GOCACHE="$srcdir/go-cache"
export GOTMPDIR="$srcdir"
export GOMODCACHE="$srcdir/go"

prepare() {
	mkdir -p "${builddir%/*}"
	mv "$srcdir"/distribution-$pkgver "$builddir"

	default_prepare
}

build() {
	export GO111MODULE=off

	make clean binaries \
		DISTRIBUTION_DIR="$builddir" \
		VERSION="$pkgver"
}

check() {
	./bin/registry --version
}

package() {
	install -D -m755 bin/registry "$pkgdir"/usr/bin/$pkgname

	install -D -m640 -o $pkgusers -g $pkggroups \
		cmd/registry/config-example.yml "$pkgdir"/etc/$pkgname/config.yml

	install -D -m755 "$srcdir"/$pkgname.initd "$pkgdir"/etc/init.d/$pkgname
	install -D -m644 "$srcdir"/$pkgname.confd "$pkgdir"/etc/conf.d/$pkgname
	install -D -m644 "$srcdir"/$pkgname.logrotate "$pkgdir"/etc/logrotate.d/$pkgname

	install -d -m750 -o $pkgusers -g $pkggroups "$pkgdir"/var/lib/$pkgname
}

sha512sums="
b9c8525051458ff4bf4592ca3ddba83c4325e88c6812ddb28c1567e331c1571f112e3b646ca970f0fe420f3b1d61d00f7151450d7b9948a08733606255731266  docker-registry-2.8.1.tar.gz
60ee85a50515431ede4a185fb23042cadd22de528e7c27ed6ddb7e43ac209a4bc88c2d570bb928b0dc547f2d5f84a18b7d267e2146154ee21659e9e6305f7b1d  config-example.patch
3f606a2b7af02f295126513fba015e7f6ad61b11eb039b7ed38ee18ec248bdb7174c5195800a1fe7df182939f7762d40dabecaec1dc5c88dc0e593e33be3ddc9  docker-registry.initd
d700d812e3bd8b593dea94dd6ed908876ef3d3c1005900b656baa4cc532d2647090603b929b160c8f10d0be032194e5511cfded1dcd20a4b8749588c27a0915d  docker-registry.confd
979643f6b9a3e12f692dc37f964fddff66f4e08cd74a1094a4be1230e67f83e703207e5420135cebb29aa13ff20a984395168046fd902392ad45d8e3eadcaa0e  docker-registry.logrotate
"
