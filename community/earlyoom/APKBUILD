# Contributor: Jakub Jirutka <jakub@jirutka.cz>
# Maintainer: Jakub Jirutka <jakub@jirutka.cz>
pkgname=earlyoom
pkgver=1.7
pkgrel=1
pkgdesc="Early OOM Daemon for Linux"
url="https://github.com/rfjakob/earlyoom"
arch="all"
license="MIT"
checkdepends="cppcheck go psutils"
makedepends="cmd:setcap"
subpackages="$pkgname-openrc"
source="https://github.com/rfjakob/earlyoom/archive/v$pkgver/earlyoom-$pkgver.tar.gz
	$pkgname.initd
	$pkgname.confd
	"
# FIXME: tests fail on builder, but pass locally
options="!check"

build() {
	make VERSION="v$pkgver"
}

check() {
	GO111MODULE=off make test
}

package() {
	make install DESTDIR="$pkgdir" PREFIX=/usr

	cd "$pkgdir"

	# Set needed capabilities (see earlyoom.service.in) so we can start
	# earlyoom as an unprivileged user.
	setcap 'cap_kill,cap_ipc_lock,cap_setpcap=+ep' usr/bin/earlyoom

	# Remove systemd stuff.
	rm -rf etc

	install -D -m755 "$srcdir"/$pkgname.initd etc/init.d/$pkgname
	install -D -m644 "$srcdir"/$pkgname.confd etc/conf.d/$pkgname
}

sha512sums="
5732632c38d9b511aaa81845b3d8f8afe737aa6498dca7e31accaf18bfcf271ba436946aa06a514a34c953f99343f9b197d8a2b8751e16d336aeb084944f3602  earlyoom-1.7.tar.gz
1f786e20143e7e71efbc18f54b7c0012dc1f24477fa8d03975df26b9cd27737af742e6dcde0216e14db7e5df3f2cd06b8662fc1c202925e5f7ba10d8fc9bd213  earlyoom.initd
434239f296d57d53cdf71e7621ae76ce67f145aa30c639ccd39a8988479707d8f040142816c6a7a664defdf98a8266538dff85bafb0ff7916f9dc4a50f7018de  earlyoom.confd
"
