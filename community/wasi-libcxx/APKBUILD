# Contributor: psykose <alice@ayaya.dev>
# Contributor: Alex Yam <alex@alexyam.com>
# Maintainer: psykose <alice@ayaya.dev>
pkgname=wasi-libcxx
# match llvm version
pkgver=14.0.4
_llvmver="${pkgver%%.*}"
_wasi_sdk_ver=15
pkgrel=0
pkgdesc="WASI LLVM C++ standard library"
subpackages="wasi-libcxxabi:_libcxxabi"
url="https://libcxx.llvm.org/"
arch="all"
license="Apache-2.0 WITH LLVM-exception"
makedepends="
	clang
	cmake
	libxml2-dev
	llvm$_llvmver-dev
	python3-dev
	samurai
	wasi-libc
	zlib-dev
	"
source="https://github.com/llvm/llvm-project/releases/download/llvmorg-$pkgver/libcxx-$pkgver.src.tar.xz
	https://github.com/llvm/llvm-project/releases/download/llvmorg-$pkgver/libcxxabi-$pkgver.src.tar.xz
	https://github.com/llvm/llvm-project/releases/download/llvmorg-$pkgver/llvm-$pkgver.src.tar.xz
	https://github.com/WebAssembly/wasi-sdk/archive/refs/tags/wasi-sdk-$_wasi_sdk_ver.tar.gz
	"
builddir="$srcdir"/wasi-libcxx
# TODO: check, needs to somehow pass wasi sysroot include to lit..
options="!check"

prepare() {
	default_prepare
	mkdir -p "$builddir"
	for s in libcxx libcxxabi llvm; do
		mv "$srcdir"/$s-$pkgver.src "$builddir"/$s
	done
	mv "$srcdir"/wasi-sdk-wasi-sdk-$_wasi_sdk_ver/wasi-sdk.cmake "$builddir"
	mv "$srcdir"/wasi-sdk-wasi-sdk-$_wasi_sdk_ver/cmake "$builddir"
	mv "$srcdir"/cmake/* "$builddir"/cmake
}

build() {
	export CFLAGS="$CFLAGS -fno-exceptions --sysroot=/usr/share/wasi-sysroot"
	export CXXFLAGS="$CXXFLAGS -fno-exceptions --sysroot=/usr/share/wasi-sysroot"

	cmake -B build-libcxx -G Ninja \
		-DCMAKE_BUILD_TYPE=MinSizeRel \
		-DCMAKE_MODULE_PATH="$builddir"/cmake \
		-DCMAKE_TOOLCHAIN_FILE="$builddir"/wasi-sdk.cmake \
		-DCMAKE_CXX_COMPILER_WORKS=ON \
		-DCMAKE_C_COMPILER_WORKS=ON \
		-DCMAKE_STAGING_PREFIX=/usr/share/wasi-sysroot \
		-DLIBCXX_ABI_VERSION=2 \
		-DLIBCXX_BUILD_EXTERNAL_THREAD_LIBRARY=OFF \
		-DLIBCXX_CXX_ABI=libcxxabi \
		-DLIBCXX_CXX_ABI_INCLUDE_PATHS=libcxxabi/include \
		-DLIBCXX_ENABLE_EXCEPTIONS=OFF \
		-DLIBCXX_ENABLE_EXPERIMENTAL_LIBRARY=OFF \
		-DLIBCXX_ENABLE_FILESYSTEM=OFF \
		-DLIBCXX_ENABLE_SHARED=OFF \
		-DLIBCXX_ENABLE_THREADS=OFF \
		-DLIBCXX_HAS_EXTERNAL_THREAD_API=OFF \
		-DLIBCXX_HAS_MUSL_LIBC=ON \
		-DLIBCXX_HAS_PTHREAD_API=OFF \
		-DLIBCXX_HAS_WIN32_THREAD_API=OFF \
		-DLIBCXX_INCLUDE_TESTS="$(want_check && echo ON || echo OFF)" \
		-DLIBCXX_LIBDIR_SUFFIX=/wasm32-wasi \
		-DLIBCXX_STANDALONE_BUILD=ON \
		-DWASI_SDK_PREFIX=/usr \
		libcxx
	cmake --build build-libcxx

	cmake -B build-libcxxabi -G Ninja \
		-DCMAKE_BUILD_TYPE=MinSizeRel \
		-DCMAKE_MODULE_PATH="$builddir"/cmake \
		-DCMAKE_TOOLCHAIN_FILE="$builddir"/wasi-sdk.cmake \
		-DCMAKE_CXX_COMPILER_WORKS=ON \
		-DCMAKE_C_COMPILER_WORKS=ON \
		-DCMAKE_STAGING_PREFIX=/usr/share/wasi-sysroot \
		-DCXX_SUPPORTS_CXX11=ON \
		-DLIBCXXABI_BUILD_EXTERNAL_THREAD_LIBRARY=OFF \
		-DLIBCXXABI_ENABLE_EXCEPTIONS=OFF \
		-DLIBCXXABI_ENABLE_PIC=OFF \
		-DLIBCXXABI_ENABLE_SHARED=OFF \
		-DLIBCXXABI_ENABLE_THREADS=OFF \
		-DLIBCXXABI_HAS_EXTERNAL_THREAD_API=OFF \
		-DLIBCXXABI_HAS_PTHREAD_API=OFF \
		-DLIBCXXABI_HAS_WIN32_THREAD_API=OFF \
		-DLIBCXXABI_INCLUDE_TESTS="$(want_check && echo ON || echo OFF)" \
		-DLIBCXXABI_LIBCXX_INCLUDES="$builddir"/build-libcxx/include/c++/v1 \
		-DLIBCXXABI_LIBCXX_PATH=libcxx \
		-DLIBCXXABI_LIBDIR_SUFFIX=/wasm32-wasi \
		-DLIBCXXABI_SILENT_TERMINATE:BOOL=ON \
		-DLIBCXXABI_STANDALONE_BUILD=ON \
		-DUNIX=ON \
		-DWASI_SDK_PREFIX=/usr \
		libcxxabi
	cmake --build build-libcxxabi
}

package() {
	DESTDIR="$pkgdir" cmake --install build-libcxx
}

_libcxxabi() {
	pkgdesc="WASI Low level support for the LLVM C++ standard library."
	DESTDIR="$subpkgdir" cmake --install "$builddir"/build-libcxxabi
}

sha512sums="
f1ca46abbf416cf9a591c6c89ac88564cb54e1f7bfb24277e0af1e356b10dd3f1336932e5ff0db259187d9cea5b39852aa6a6f2e29b865ab19b90a40ccf2fc29  libcxx-14.0.4.src.tar.xz
bb312b01d5665d35806f44660cd7a8a061f2b6500f9f6587375290a495f109714a71bc43b964df3f138e036c85dfe4db24a68fd27720e310f8ec169f51802507  libcxxabi-14.0.4.src.tar.xz
f15a8f1b9067d9f3fb2837f04bf6137218d0d0fd9dbd51b40a046675ed194c4c51b084643014180b7a72c2475f87f5784bed9f9940c326c2e5e264114dde4e5b  llvm-14.0.4.src.tar.xz
547851faf4083213a9f62a7ffef6b7d75042cbb15ac96e0c5fb254e2e57a8fc73a3ae7e7db19dc224e652d1318a9ecddfe216d3bc5afd0a79dda3b0e09812779  wasi-sdk-15.tar.gz
"
