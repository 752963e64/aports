# Contributor: Bart Ribbers <bribbers@disroot.org>
# Maintainer: Bart Ribbers <bribbers@disroot.org>
pkgname=pocketsphinx
pkgver=5.0.2
pkgrel=0
pkgdesc="Python bindings for CMU Sphinxbase and Pocketsphinx libraries"
url="https://github.com/cmusphinx/pocketsphinx"
# s390x is broken and unsupported
arch="all !s390x"
license="BSD-2-Clause"
makedepends="
	alsa-lib-dev
	cmake
	cython
	doxygen
	pulseaudio-dev
	py3-gpep517
	py3-scikit-build
	py3-setuptools
	py3-wheel
	python3-dev
	samurai
	swig
	"
checkdepends="py3-pytest"
#subpackages="py3-$pkgname::py3 py3-$pkgname-pyc $pkgname-doc"
subpackages="py3-$pkgname-pyc py3-$pkgname:py3 $pkgname-libs $pkgname-doc"
source="https://pypi.python.org/packages/source/p/pocketsphinx/pocketsphinx-$pkgver.tar.gz"
# PyPi release package doesn't include the tests even though they exist
# https://github.com/bambocher/pocketsphinx-python/issues/55
#options="!check" # No tests
builddir="$srcdir/pocketsphinx-$pkgver"

build() {
	cmake -B build -G Ninja \
		-DCMAKE_BUILD_TYPE=MinSizeRel \
		-DCMAKE_INSTALL_PREFIX=/usr \
		-DCMAKE_INSTALL_LIBDIR=lib \
		-DBUILD_SHARED_LIBS=true
	cmake --build build
	gpep517 build-wheel \
		--wheel-dir .dist \
		--output-fd 3 3>&1 >&2
}

check() {
	python3 -m venv --clear --without-pip --system-site-packages .testenv
	.testenv/bin/python3 -m installer .dist/*.whl
	# endpointer_test segfaults
	.testenv/bin/python3 -m pytest \
		--deselect cython/test/endpointer_test.py \
		--deselect cython/test/lm_test.py \
		--ignore cython/test/vad_test.py
}

package() {
	DESTDIR="$pkgdir" cmake --install build
	python3 -m installer -d "$pkgdir" \
		.dist/*.whl
}

py3() {
	amove usr/lib/python*
}

sha512sums="
9ff72bc5a89323f6169b72b6fd6d561bf4577bc20b68dc5b11ffc534e4c11273b1908506b198af83ffbd9dde6105282d877ef8532f719ec9433a7f1880bc1ebb  pocketsphinx-5.0.2.tar.gz
"
