# Contributor: omni <omni+alpine@hack.org>
# Maintainer: omni <omni+alpine@hack.org>
pkgname=maturin
pkgver=0.10.2
pkgrel=0
pkgdesc="Build and publish crates with pyo3, rust-cpython and cffi bindings"
url="https://github.com/PyO3/maturin"
arch="aarch64 x86 x86_64" # limited by rust, ppc64le by ring crate
# TODO: sort arm* wheel issues
license="Apache-2.0 MIT"
makedepends="cargo dbus-dev"
checkdepends="py3-virtualenv py3-pyo py3-cffi libffi-dev python3-dev"
subpackages="$pkgname-doc"
source="$pkgname-$pkgver.tar.gz::https://github.com/PyO3/maturin/archive/v$pkgver.tar.gz
	use-sysconfig-ext_suffix.patch
	target_triple.patch
	disable-no_extensions_module-test.patch
	tests-common-errors.patch"

build() {
	cargo build --release --locked --all-features
}

check() {
	# enable interpreter "python" hack
	mkdir "$builddir"/pythonbindir
	ln -s /usr/bin/python3 "$builddir"/pythonbindir/python
	export PATH="$PATH:$builddir/pythonbindir"

	cargo test --release --locked
}

package() {
	install -Dm0755 target/release/$pkgname -t "$pkgdir"/usr/bin
	install -Dm0644 license-apache "$pkgdir"/usr/share/licenses/$pkgname/license-apache
	install -Dm0644 license-mit "$pkgdir"/usr/share/licenses/$pkgname/license-mit
}

sha512sums="17a7e1299f0d47bb2bf66804514c5dc4f203216b138f61689d2caad2297c87c793e9caa05aff111a183739f6e016ec762f6d6350208eedb3862fb30c937d34ad  maturin-0.10.2.tar.gz
39a60c64aa3f2a2539912452dc250c13637a77af62592ab3e7f2ce19d1e29ea23df02134c625b84da570cdbed6f6d70a22c44e28653fe8014f9b3817e1ac15cc  use-sysconfig-ext_suffix.patch
92a70ac88160d2cea02817d0149c92e51dda3230d531b4bd444009a9cbc4c813e6c69e727017d4777a8e6cffc20bd1956fd39e923e0a9ea7bea059ba84599a1b  target_triple.patch
e2f5b07ed63a498fd46ef2f098c6b3235d44a3736768a4bf622078188795f4f8db8fafdaef5f9c953efc8b52e4f1af286e8390e13a2c4884e515b4011f49a76d  disable-no_extensions_module-test.patch
27e2528083eb757b5ce7d2922bf520ecf16240ed2cf65488c21e5ace768f3ee0c8de87b96dfd4f77e00b642141a5d1ef01f9a399314992c2b055e9b84dae3711  tests-common-errors.patch"
