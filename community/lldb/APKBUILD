# Contributor: Bart≈Çomiej Piotrowski <bpiotrowski@alpinelinux.org>
# Maintainer: Rasmus Thomsen <oss@cogitri.dev>
pkgname=lldb
# Note: Update together with llvm.
pkgver=12.0.1
pkgrel=0
_vermajor=${pkgver%%.*}
pkgdesc="Next generation, high-performance debugger"
# riscv64 build failure https://build.alpinelinux.org/buildlogs/build-edge-riscv64/community/lldb/lldb-11.1.0-r2.log
arch="all !x86 !riscv64 !mips64"
_vermajor=${pkgver%%.*}
pkgdesc="Next generation, high-performance debugger"
arch="all !x86"
url="https://llvm.org/"
license="Apache-2.0"
makedepends="
	clang-dev>=$_vermajor
	clang-static>=$_vermajor
	cmake
	doxygen
	libedit-dev
	libffi-dev
	libxml2-dev
	linux-headers
	llvm-dev>=$_vermajor
	llvm-static>=$_vermajor
	ncurses-dev
	ninja
	python3-dev
	swig
	xz
	"
subpackages="$pkgname-dev py3-$pkgname:py3"
source="https://github.com/llvm/llvm-project/releases/download/llvmorg-$pkgver/lldb-$pkgver.src.tar.xz
https://github.com/llvm/llvm-project/releases/download/llvmorg-$pkgver/llvm-$pkgver.src.tar.xz
musl.patch
fix-embedded_interpreter.patch
	"
builddir="$srcdir/$pkgname-$pkgver.src"
options="!check" #Not working

unpack(){
        cd "$srcdir"
        tar -xf "llvm-$pkgver.src.tar.xz"
	tar -xf "lldb-$pkgver.src.tar.xz"
        mv "llvm-$pkgver.src" llvm
        mv "lldb-$pkgver.src" lldb
}

prepare(){
	cd "$srcdir"
	patch lldb/source/Interpreter/embedded_interpreter.py fix-embedded_interpreter.patch
	patch lldb/source/Plugins/Process/Linux/Procfs.h musl.patch
	#Musl fix
	sed -i 's|__ptrace_request|int|g' lldb/source/Plugins/Process/Linux/NativeProcessLinux.cpp
}

build() {
	mkdir -p "$builddir"
	cd "$builddir"

	CC=clang CXX=clang++ cmake -G "Unix Makefiles" -S ../lldb -B build -Wno-dev \
		-DCMAKE_BUILD_TYPE=MinSizeRel \
		-DCMAKE_C_FLAGS_MINSIZEREL_INIT="$CFLAGS" \
		-DCMAKE_CXX_FLAGS_MINSIZEREL_INIT="$CXXFLAGS" \
		-DCMAKE_EXE_LINKER_FLAGS_MINSIZEREL_INIT="$LDFLAGS" \
		-DCMAKE_INSTALL_PREFIX=/usr \
		-DLLVM_ENABLE_PROJECTS="lldb" \
		-DLLVM_LINK_LLVM_DYLIB=ON \
		-DLLDB_DISABLE_LIBEDIT=ON \
		-DLLDB_TEST_C_COMPILER=clang \
		-DLLDB_TEST_CXX_COMPILER=clang++ \
		-DClang_DIR="/usr/lib/clang/$pkgver/include" \
		-DLLVM_DIR="/usr/lib/llvm$_vermajor/lib" \
		-DPYTHON_EXECUTABLE=/usr/bin/python3
	cmake --build build
}

package() {
	DESTDIR="$pkgdir" cmake --install build
	cd build
	make lldb
}

check(){
	cd "$builddir/build"
	make check-lldb
}

package() {
	cd "$builddir/build"
	DESTDIR="$pkgdir" make install
}

py3() {
	pkgdesc="Python3 module for LLDB"
	depends="$pkgname python3 py3-six"
	replaces="py-lldb"

	local sitedir=$(python3 -c "import site; print(site.getsitepackages()[0])")

	mkdir -p "$subpkgdir"/$sitedir

	mv "$pkgdir"/"$sitedir"/* "$subpkgdir"/"$sitedir"
	rm -rf "$pkgdir"/"$sitedir"

	# Remove bundled module.
	rm "$subpkgdir"/"$sitedir"/six.py

	python3 -m compileall -fq "$subpkgdir"/"$sitedir"
}

sha512sums="df3c8e088bf69fb843cd7365fd2df4cefb72c9a313511fb0d0fa3e06e7d12cada35a1d621ec4312c99799e68ff76955423993ce0310c58f74ccd5151984f38ee  lldb-12.0.1.src.tar.xz
ff674afb4c8eea699a4756f1bb463f15098a7fa354c733de83c024f8f0cf238cd5f19ae3ec446831c7109235e293e2bf31d8562567ede163c8ec53af7306ba0f  llvm-12.0.1.src.tar.xz
3c611fa5d45b6cb3f2925a31deeb8a34c295277aedcd55c22851d373897acd376fa92f4ef953c96a25c8dae4c93b6a88de0918550672141d324a3813d8283d48  fix-embedded_interpreter.patch
caa976d1913a122940415352a1524ac0daea380b19105ff6ec0d282325796707a0656d62a44570261c87f34ed046708b171a24bb0a068dac9c3d1d6125bb5007  musl.patch"
