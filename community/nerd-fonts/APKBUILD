# Contributor: Jakub Jirutka <jakub@jirutka.cz>
# Maintainer: Jakub Jirutka <jakub@jirutka.cz>

# NOTE: There is also aport nerd-fonts-stable.
pkgname=nerd-fonts
pkgver=2.3.3
pkgrel=0
pkgdesc="Iconic font aggregator, collection and patcher"
url="https://nerdfonts.com"
arch="noarch !s390x"  # blocked by fontforge
license="MIT"
_depends_patcher="
	fontforge
	py3-fontforge
	python3
	"
makedepends="
	$_depends_patcher
	bash
	findutils
	"
install="$pkgname.post-upgrade"
subpackages="
	$pkgname-patcher
	font-nerd-fonts-symbols-1000em:_symbols_1000em
	font-nerd-fonts-symbols-2048em:_symbols_2048em
	"
source="$pkgname-$pkgver.tar.gz::https://github.com/ryanoasis/nerd-fonts/archive/refs/tags/v$pkgver.tar.gz"
options="!check"  # no tests provided

_fontsdir="usr/share/fonts/nerd-fonts"

prepare() {
	default_prepare

	# We're gonna regenerate them.
	rm -rf patched-fonts/*

	sed -Ei \
		-e 's|/usr/bin/env python\b|/usr/bin/python3|' \
		-e "s|^(version\s*=\s*).*|\1\"$pkgver\"|" \
		font-patcher
}

build() {
	cd bin/scripts

	# NOTE: We build them from source because prebuilt fonts in the
	#  upstream's repository are broken (see e.g. nerd-fonts#581).
	./gotta-patch-em-all-font-patcher\!.sh NerdFontsSymbols
}

package() {
	mkdir -p "$pkgdir"
}

patcher() {
	pkgdesc="Nerd Fonts Patcher tool"
	depends="$_depends_patcher"
	local datadir="$subpkgdir/usr/share/$pkgname"

	cd "$builddir"

	mkdir -p "$datadir"/src
	install -m755 font-patcher -t "$datadir"/
	cp -r src/glyphs "$datadir"/src/

	mkdir -p "$subpkgdir"/usr/bin
	ln -s ../share/$pkgname/font-patcher "$subpkgdir"/usr/bin/
}

# NOTE: It seems that upstream's huge 10-nerd-font-symbols.conf config is not
#  needed for the font fallback to work, except for some broken applications...?
_symbols_1000em() {
	pkgdesc="Symbols Nerd Font (1000-em)"
	depends="fontconfig mkfontscale"
	# Omitting version to allow installing both variants.
	provides="${subpkgname%-*}"
	# NOTE: Tbh, I have no idea which variant should be preferred.
	#  https://github.com/ryanoasis/nerd-fonts/discussions/872
	provider_priority=100  # highest

	cd "$builddir"
	rm patched-fonts/NerdFontsSymbolsOnly/complete/Symbols-1000-em*Windows\ Compatible.ttf
	install -D -m644 patched-fonts/NerdFontsSymbolsOnly/complete/Symbols-1000-em*.ttf \
		-t "$subpkgdir/$_fontsdir/"
}

_symbols_2048em() {
	pkgdesc="Symbols Nerd Font (2048-em)"
	depends="fontconfig mkfontscale"
	provides="${subpkgname%-*}"
	provider_priority=10  # lowest

	cd "$builddir"
	rm patched-fonts/NerdFontsSymbolsOnly/complete/Symbols-2048-em*Windows\ Compatible.ttf
	install -D -m644 patched-fonts/NerdFontsSymbolsOnly/complete/Symbols-2048-em*.ttf \
		-t "$subpkgdir/$_fontsdir/"
}

sha512sums="
89cbd6f6c230b4d58d3d5933577e69c3a803d10a3139f9a793b2eadb67e5237d5fd74b0c2983a7ad4fab359795eb521cf94fd1a63c6a2f7d75feebe04d7f69c0  nerd-fonts-2.3.3.tar.gz
"
