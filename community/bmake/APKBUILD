# Maintainer: SÃ¶ren Tempel <soeren+alpine@soeren-tempel.net>
pkgname=bmake
pkgver=20201222
pkgrel=0
pkgdesc="Portable version of the NetBSD make build tool"
url="http://www.crufty.net/help/sjg/bmake.html"
arch="all"
license="BSD-2-Clause"
subpackages="$pkgname-doc"
source="http://www.crufty.net/ftp/pub/sjg/bmake-$pkgver.tar.gz
	install-sh.patch
	separate-tests.patch
	strerror-ENAMETOOLONG.patch"
builddir="$srcdir/$pkgname"

# Reset MAKEFLAGS since it might contain options not supported
# by bmake. This is, for instance, the case on the builders.
export MAKEFLAGS="-j${JOBS:-1}"

prepare() {
	default_prepare

	# FIXME: Disable tests failing on musl.
	sed -i unit-tests/Makefile \
		-e "/deptgt-delete_on_error/d" \
		-e "/varmod-localtime/d"
}

build() {
	sh ./boot-strap --with-default-sys-path=/usr/share/mk op=build
}

check() {
	sh ./boot-strap op=test
}

package() {
	sh ./boot-strap --prefix=/usr --with-mksrc=/usr/share/mk \
			--install-destdir="$pkgdir" op=install

	rm -rf "$pkgdir"/usr/share/man/cat1
	install -Dm644 bmake.1 \
		"$pkgdir"/usr/share/man/man1/bmake.1

	mkdir -p "$pkgdir"/usr/share/doc/$pkgname/
	install -m644 README ChangeLog \
		"$pkgdir"/usr/share/doc/$pkgname/
}

sha512sums="ddf1152adf99b350ae1ff1dd473319cd7c277c696f29b3ccba9080ecb9da0013f334b183c46a6e0a34708071a8f4f89d813264436e1946ebdc1923e6fe7440d9  bmake-20201222.tar.gz
0de9022a2991c5ef02c09ab592a3e2d218cd0bbf58e54f21bc7694110f3dd9e4589bf2b3d241fd167fb220b425007863f20e71e141b4f65bf92d305ba94209da  install-sh.patch
04217b04aca4252f54c836e982d95106a09166370f84fa672c418d1b1799adb9697f5ac9eb10a6ee3a8527e39196a37ad92bb5945733407bf9ec1a7f223183bb  separate-tests.patch
ba881b621b0f2b673dbd5dd4bf72334031bb8bc71283334c98ad711c3b9c0395b2a05ba92a79cbca54d0073aec4bee27393f049468163a4e02fbe86bc509e611  strerror-ENAMETOOLONG.patch"
