# Contributor: Leo <thinkabit.ukim@gmail.com>
# Maintainer: Michał Polański <michal@polanski.me>
pkgname=seatd
pkgver=0.6.2
pkgrel=1
pkgdesc="Minimal seat management daemon"
url="https://sr.ht/~kennylevinsen/seatd/"
license="MIT"
arch="all !ppc64le !mips64" # build failure
options="suid"
pkggroups="seat"
install="$pkgname.pre-install"
makedepends="meson scdoc elogind-dev linux-headers"
subpackages="libseat:libs libseat-dev $pkgname-doc $pkgname-openrc"
source="$pkgname-$pkgver.tar.gz::https://git.sr.ht/~kennylevinsen/seatd/archive/$pkgver.tar.gz
	$pkgname.initd
	$pkgname.confd
	"

# secfixes:
#   0.6.2-r0:
#     - CVE-2021-41387

build() {
	abuild-meson \
		-Dlibseat-logind=elogind \
		-Dman-pages=enabled \
		. output

	meson compile ${JOBS:+-j ${JOBS}} -C output
}

check() {
	meson test --no-rebuild -v -C output
}

package() {
	DESTDIR="$pkgdir" meson install --no-rebuild -C output
	chmod u+s "$pkgdir"/usr/bin/seatd-launch

	install -Dm755 "$srcdir"/seatd.initd "$pkgdir"/etc/init.d/seatd
	install -Dm644 "$srcdir"/seatd.confd "$pkgdir"/etc/conf.d/seatd
}

libs() {
	default_libs
	pkgdesc="Universal seat management library"
}

dev() {
	default_dev
	pkgdesc="Universal seat management library (development files)"
}

sha512sums="
47e3aec819f43e72913be1cac2c0db26287f1ef8ecc738845d3591b3e2b4fee3441ac50ea45ac75a5da774e5305a18a02b8375f76f71644c8c07e95bcad52762  seatd-0.6.2.tar.gz
b9f986024e00a828a2164d5f68c9d1c9d639e6bfbf0fdf59dd6f470fb8fa2a35089160f80d4ab9f8a84b2628fbcc82bfe6f67ea2f9fbe40ee8a256bf04c778e6  seatd.initd
1e00d22ce431c334117dfd1ad322333b8d2faf5c15929503add91950fa973b79bda593f01fb06f05e1f0dc9c665948ebcbd2238b9d45dfafdef04ae8504ab350  seatd.confd
"
