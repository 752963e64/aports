# Contributor: Carlo Landmeter <clandmeter@alpinelinux.org>
# Contributor: Chloe Kudryavtsev <toast@toast.cafe>
# Maintainer: Drew DeVault <sir@cmpwn.com>
pkgname=minio
_pkgver="RELEASE.2022-07-17T15-43-14Z"
pkgver=${_pkgver#*.}
pkgver=${pkgver%T*}
pkgver=0.${pkgver//-}
pkgrel=7
pkgdesc="An open source object storage server compatible with Amazon S3"
url="https://minio.io/"
# armhf, armv7, x86: test failures
# riscv64: fails to build cpuinfo module
arch="all !x86 !armv7 !armhf" # test failures
license="AGPL-3.0-or-later"
makedepends="go"
pkgusers="minio"
pkggroups="minio"
install="$pkgname.pre-install"
subpackages="$pkgname-openrc"
source="https://github.com/minio/minio/archive/$_pkgver/$pkgname-$pkgver.tar.gz
	$pkgname.initd
	$pkgname.confd
	"
builddir="$srcdir/$pkgname-$_pkgver"
options="net"

# secfixes:
#   0.20200423-r0:
#     - CVE-2020-11012

export GOCACHE="$srcdir/go-cache"
export GOTMPDIR="$srcdir"
export GOMODCACHE="$srcdir/go"
export CGO_ENABLED=0

build() {
	local ldflags=$(go run buildscripts/gen-ldflags.go 2> /dev/null)
	go build -tags kqueue --ldflags "$ldflags" -o bin/minio
}

check() {
	# cmd: disk usage errors, like same as pkg/disk
	# pkg/disk: doesn't know what btrfs is
	# pkg/s3select: fails on 32bit systems
	# pkg/event/target: fails on aarch64
	# pkg/sys: fails on aarch64
	# cmd/http: fails on aarch64, suspect ipv6 problem
	# pkg/dsync: fails on armv7
	go test -tags kqueue $(go list ./... | grep -v \
		-e 'cmd$' \
		-e pkg/disk \
		-e pkg/s3select \
		-e pkg/event/target \
		-e pkg/sys \
		-e cmd/http \
		-e pkg/dsync
		)
}

package() {
	install -Dm755 "$builddir"/bin/minio -t "$pkgdir"/usr/bin/
	install -Dm755 "$srcdir"/$pkgname.initd "$pkgdir"/etc/init.d/$pkgname

	# This file might contain secrets.
	install -Dm640 "$srcdir"/$pkgname.confd "$pkgdir"/etc/conf.d/$pkgname
}

cleanup_srcdir() {
	go clean -modcache
	default_cleanup_srcdir
}

sha512sums="
6933328ce26587d3b3df65b9f0fa12020d48e30474c76bd7b40d7d319b70327d79f6b0b03c151087507571c456b9eca6e29b13850d47e412eddc66641fea0aad  minio-0.20220717.tar.gz
dd9b726c1e7656631055cbe7a984fd8e3b429ac86907f65672070daf842ec33f607368202a883bb4d80db2b55669d2863a0f34e0e90497b881a5e7e45e49b57d  minio.initd
ed9790fbadfb38e4d660eb1befd87e803d70dec04d936e8cd26def4a9c21240bb7cae8750ae3395aa4761e6738b9e346c86ba57761cfde30efe46d2cb459a7e4  minio.confd
"
