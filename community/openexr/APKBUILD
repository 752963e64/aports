# Contributor: SÃ¶ren Tempel <soeren+alpine@soeren-tempel.net>
# Contributor: Holger Jaekel <holger.jaekel@gmx.de>
# Maintainer: Mark Riedesel <mark+alpine@klowner.com>
pkgname=openexr
pkgver=2.5.7
pkgrel=0
pkgdesc="A high dynamic-range image file format library"
url="https://www.openexr.com/"
# mips64 blocked by py3-numpy
arch="all !mips64"
license="BSD-3-Clause"
makedepends="
	boost-dev
	boost-python3
	chrpath
	cmake
	py3-numpy-dev
	python3-dev
	zlib-dev
	"
subpackages="
	$pkgname-doc
	$pkgname-tools
	py3-$pkgname-dev:py3dev
	py3-$pkgname:py3
	$pkgname-dev
	"
source="$pkgname-$pkgver.tar.gz::https://github.com/openexr/openexr/archive/v$pkgver.tar.gz"

# secfixes:
#   2.5.4-r0:
#     - CVE-2021-20296
#     - CVE-2021-3474
#     - CVE-2021-3475
#     - CVE-2021-3476
#     - CVE-2021-3477
#     - CVE-2021-3478
#     - CVE-2021-3479
#   2.5.2-r0:
#     - CVE-2020-15304
#     - CVE-2020-15305
#     - CVE-2020-15306
#   2.4.1-r0:
#     - CVE-2020-11758
#     - CVE-2020-11759
#     - CVE-2020-11760
#     - CVE-2020-11761
#     - CVE-2020-11762
#     - CVE-2020-11763
#     - CVE-2020-11764
#     - CVE-2020-11765
#   2.4.0-r0:
#     - CVE-2017-12596
#   2.2.1-r0:
#     - CVE-2017-9110
#     - CVE-2017-9111
#     - CVE-2017-9112
#     - CVE-2017-9113
#     - CVE-2017-9114
#     - CVE-2017-9115
#     - CVE-2017-9116

build() {
	cmake -B build \
		-DCMAKE_INSTALL_PREFIX=/usr \
		-DCMAKE_INSTALL_LIBDIR=lib \
		-DBUILD_SHARED_LIBS=True \
		-DCMAKE_BUILD_TYPE=None \
		-DCMAKE_CXX_FLAGS="$CXXFLAGS" \
		-DCMAKE_C_FLAGS="$CFLAGS" \
		$CMAKE_CROSSOPTS
	cmake --build build
}

check() {
	cd build

	_exclude_tests="OpenEXR.IlmImf"
	case "$CARCH" in
		x86) _exclude_tests="($_exclude_tests|IlmBase.Imath)" ;;
	esac

	CTEST_OUTPUT_ON_FAILURE=TRUE ctest -E $_exclude_tests
}

package() {
	DESTDIR="$pkgdir" cmake --install build
}

py3dev() {
	pkgdesc="$pkgdesc (Python3 bindings for the Imath vector/matrix classes) (development files)"

	depends="openexr-dev=$pkgver-r$pkgrel"
	amove /usr/include/OpenEXR/Py*
	amove /usr/lib/cmake/PyIlmBase
	amove /usr/lib/pkgconfig/PyIlmBase.pc
	cd $pkgdir
	# move *.so links needed when linking the apps to -dev packages
	for i in lib/libPy*.so usr/lib/libPy*.so; do
		if [ -L "$i" ]; then
			mkdir -p "$subpkgdir"/"${i%/*}"
			mv "$i" "$subpkgdir/$i"
		fi
	done
}

py3() {
	pkgdesc="$pkgdesc (Python3 bindings for the Imath vector/matrix classes)"

	# Install missing python module
	_pythonpath=$(python3 -c "from sysconfig import get_path; print(get_path('platlib'))")
	amove $_pythonpath
	amove usr/lib/*Python*
	install -Dm755 $builddir/build/python3*/imathnumpy.so -t "$subpkgdir"/$_pythonpath
	chrpath -d $subpkgdir/$_pythonpath/imathnumpy.so
	rm -rf $pkgdir/usr/lib/python*
}

tools() {
	amove usr/bin
}

sha512sums="
e44edfa2dcfff2fe372ed2ba07b39a472e549025978de178eff26be641767d22d1a3b543fb7672d9b7b2e9f4c308667f785829ed6d9032a2b42f2ffa0163de40  openexr-2.5.7.tar.gz
"
