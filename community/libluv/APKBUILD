# Contributor: Leo <thinkabit.ukim@gmail.com>
# Maintainer:
pkgname=libluv
pkgver=1.44.2.1
_pkgver=${pkgver%.*}-${pkgver##*.}
pkgrel=1
pkgdesc="Bare libuv bindings for lua"
url="https://github.com/luvit/luv"
# riscv64 blocked by luajit
arch="all !riscv64"
license="Apache-2.0"
makedepends="
	cmake
	libuv-dev
	lua-compat53-dev
	luajit-dev
	ninja
	"
subpackages="$pkgname-dev"
source="https://github.com/luvit/luv/archive/$_pkgver/libluv-$_pkgver.tar.gz
	cmake-use-pkgconfig.patch
	disable-udp-test.patch
	"
builddir="$srcdir/luv-$_pkgver"

build() {
	cmake -B build -G Ninja \
		-DCMAKE_BUILD_TYPE=MinSizeRel \
		-DCMAKE_INSTALL_PREFIX=/usr \
		-DCMAKE_VERBOSE_MAKEFILE=ON \
		-DWITH_SHARED_LIBUV=ON \
		-DLUA_BUILD_TYPE=System \
		-DLUA_COMPAT53_DIR="/usr/include/lua5.1" \
		-DBUILD_MODULE=OFF \
		-DBUILD_SHARED_LIBS=ON \
		-DBUILD_STATIC_LIBS=OFF
	cmake --build build
}

check() {
	LUA_CPATH="build/lib?.so;;" luajit tests/run.lua
}

package() {
	DESTDIR="$pkgdir" cmake --install build
}

sha512sums="
efcdc636ab636fc3b63f847da922da3110ebc2ca2a97328a5e074f558429778cac71a0f0d58a38a0e3e967dc1785bc502deb0ca1a2fcc4ade8f50e5dd1c5701d  libluv-1.44.2-1.tar.gz
ba68d920e11d107febe458fbe4887288c8915fc3a56c4742bb577650b4e74e0428a364e1321b68ee47f17a157e1bd304a8777bd294a8f2baefcaf541fdf5170b  cmake-use-pkgconfig.patch
de720e872a45aaa9d104b7646f5aee63e44d5ccfcd4b74c804a71c762dd5fe9e9f735bb82aa45e1d4631bf065f6a407fd09fbed7fc29e02e8aa756077fb71d94  disable-udp-test.patch
"
