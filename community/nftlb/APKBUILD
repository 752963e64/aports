# Contributor: Jakub Jirutka <jakub@jirutka.cz>
# Maintainer: Jakub Jirutka <jakub@jirutka.cz>
pkgname=nftlb
pkgver=0.7
pkgrel=0
pkgdesc="nftables load balancer"
url="https://github.com/zevenet/nftlb"
arch="all"
license="AGPL-3.0"
checkdepends="bash"
makedepends="autoconf automake jansson-dev libev-dev libmnl-dev libtool nftables-dev"
subpackages="$pkgname-openrc"
source="https://github.com/zevenet/nftlb/archive/v$pkgver/$pkgname-$pkgver.tar.gz
	$pkgname.initd
	$pkgname.confd
	musl-fixes.patch
	"

prepare() {
	autoreconf -fi
	default_prepare
}

build() {
	./configure \
		--build=$CBUILD \
		--host=$CHOST \
		--prefix=/usr \
		--sysconfdir=/etc \
		--localstatedir=/var
	make
}

check() {
	# NOTE: It's not safe to run the provided tests on the builder.
	./src/nftlb --help 2>/dev/null || ./src/nftlb --help
}

package() {
	make install DESTDIR="$pkgdir"

	install -m 0755 -D "$srcdir"/$pkgname.initd "$pkgdir"/etc/init.d/$pkgname
	install -m 0644 -D "$srcdir"/$pkgname.confd "$pkgdir"/etc/conf.d/$pkgname
}

sha512sums="
5214c9fe2dd6a4908d69af4fd7e3806895a015057e69421d1c280c53ca3196a694a2ad9f383f417f82d987c62b062a2d0cede1af95127daf9b998e5a79dd3aae  nftlb-0.7.tar.gz
3e15dc73b21412d1504892ee1e550a00c895671069a32e9c80a38a7c68bc8988c44519bfb15f288e42a96047febfeb38eeffc534381d644f87ede859b23efe71  nftlb.initd
9a4384fe295203a80489ea2a61f0c4b9b8b2ac1be51c506b4ab5c3c9e76818a0cd18f6b372323ea84dcd0437e1224cd9be339c9463c3c8042e6c3e74e73ae360  nftlb.confd
7979b90acd1149e1de1f5149107bba5542d8e4efac9df7b9f85d9e878ca2cbf1de54f08093893cbc56519db5471601b6ec056cae0f0dddd2a7d94bed46d2689b  musl-fixes.patch
"
