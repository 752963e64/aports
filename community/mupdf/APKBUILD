# Contributor: SÃ¶ren Tempel <soeren+alpine@soeren-tempel.net>
# Contributor: Michael Zhou <zhoumichaely@gmail.com>
# Maintainer: Daniel Sabogal <dsabogalcc@gmail.com>
pkgname=mupdf
pkgver=1.20.0
pkgrel=3
pkgdesc="Lightweight PDF and XPS viewer"
url="https://mupdf.com"
arch="all"
license="AGPL-3.0-or-later"
makedepends="
	cmd:desktop-file-install
	freetype-dev
	glu-dev
	gumbo-parser-dev
	harfbuzz-dev
	jbig2dec-dev
	jpeg-dev
	libx11-dev
	libxext-dev
	libxi-dev
	libxrandr-dev
	mesa-dev
	mujs-dev
	openjpeg-dev
	readline-dev
	zlib-dev
	"
subpackages="
	$pkgname-doc
	$pkgname-dev
	$pkgname-libs
	$pkgname-x11:_x11
	$pkgname-gl:_gl
	$pkgname-tools:_tools
	"
source="https://mupdf.com/downloads/archive/mupdf-$pkgver-source.tar.lz
	shared-lib.patch
	mupdf.pc.in
	mupdf.desktop
	mupdf-gl.desktop
	"
builddir="$srcdir/$pkgname-$pkgver-source"
options="!check"

# secfixes:
#   1.18.0-r1:
#     - CVE-2021-3407
#   1.17.0-r3:
#     - CVE-2020-26519
#   1.13-r0:
#     - CVE-2018-1000051
#     - CVE-2018-6544
#     - CVE-2018-6192
#     - CVE-2018-6187
#     - CVE-2018-5686
#     - CVE-2017-17858
#   1.11-r1:
#     - CVE-2017-6060
#   1.10a-r2:
#     - CVE-2017-5991
#   1.10a-r1:
#     - CVE-2017-5896

# Needs freeglut2-art fork.
_make_flags="
	build=release
	shared=yes
	USE_SYSTEM_LIBS=yes
	USE_SYSTEM_MUJS=yes
	USE_SYSTEM_GLUT=no
	"

prepare() {
	default_prepare

	local dir; for dir in $(ls thirdparty | grep -v -e extract -e freeglut -e lcms2); do
		rm -rf thirdparty/$dir
	done

	sed "s/@@VERSION@@/$pkgver/" "$srcdir"/$pkgname.pc.in > $pkgname.pc
}

build() {
	make $_make_flags verbose=yes CURL_LIBS="-lcurl -lpthread" libs apps
}

package() {
	make $_make_flags prefix=/usr DESTDIR="$pkgdir" install

	install -D -m644 $pkgname.pc -t "$pkgdir"/usr/lib/pkgconfig/

	cd "$pkgdir"

	mv usr/lib/libmupdf.so usr/lib/libmupdf.so.$pkgver
	ln -s libmupdf.so.$pkgver usr/lib/libmupdf.so
	ldconfig -n usr/lib
}

libs() {
	replaces="$pkgname<1.20.0-r3"  # backward compatibility (Alpine <3.17)
	default_libs
}

_x11() {
	pkgdesc="$pkgdesc with X11 backend"
	depends=""

	amove usr/bin/mupdf-x11
	ln -s mupdf-x11 "$subpkgdir"/usr/bin/mupdf

	desktop-file-install --dir="$subpkgdir/usr/share/applications" "$srcdir"/mupdf.desktop

	install -D -m644 "$builddir"/docs/logo/mupdf-logo.svg \
		"$subpkgdir"/usr/share/icons/hicolor/scalable/apps/mupdf.svg
}

_gl() {
	pkgdesc="$pkgdesc with OpenGL backend"
	depends=""

	amove usr/bin/mupdf-gl

	desktop-file-install --dir="$subpkgdir/usr/share/applications" "$srcdir"/mupdf-gl.desktop

	install -D -m644 "$builddir"/docs/logo/mupdf-logo.svg \
		"$subpkgdir"/usr/share/icons/hicolor/scalable/apps/mupdf-gl.svg
}

_tools() {
	pkgdesc="Tools for a lightweight PDF and XPS viewer"
	depends=""

	amove usr/bin/mutool
	amove usr/bin/muraster
}

sha512sums="
c5920addb249753aab1e4eac197edca6a5e2bd4dd2b472a629994426048993e65c3f4d34ccc9620b7b6bcd917fb06f36017c02afc2ec060c90087a786d9d5d4c  mupdf-1.20.0-source.tar.lz
dbfed45c3dbee21e6ac75896f475dd1df51f452997087ac41c29db2990830ce814784195d94dcc3e695255c2f52476200aea5fc78a32b7057547c7c855b494a7  shared-lib.patch
3135f8736fd9e7127a860967c83731af417f96133f8d0fd8ba7ae65985445dc095b84dc91d4a612eae017aefdc60608ca9e1f69867249f9ffa6896e996749d63  mupdf.pc.in
67c2d04a0bbe694d1ce1a9c81701c1dab6f452409ebb9a68d5ef90392021b956ffcad1a89f87970a87ee6a1aa514395e17f05c09a16725eb99fcc0ed365059d8  mupdf.desktop
759b27ceadbeedea84e2c75c749281ab872d1d51e05de7974da47d65162ffb5aa679cdf12208018c9a8d0aad38eed55e996d78b6bdeb1eb58008271bf4801619  mupdf-gl.desktop
"
