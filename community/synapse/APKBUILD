# Contributor: Leo <thinkabit.ukim@gmail.com>
# Maintainer: Leo <thinkabit.ukim@gmail.com>
pkgname=synapse
pkgver=1.23.0
pkgrel=0
pkgdesc="Matrix reference homeserver"
options="!check" # Requires 'py3-hiredis' which needs a rebuild
url="https://github.com/matrix-org/synapse"
arch="noarch !s390x" # Tests fail
license="Apache-2.0"
depends="
	python3
	py3-eliot
	py3-txacme
	py3-jsonschema
	py3-frozendict
	py3-canonicaljson
	py3-pynacl
	py3-idna
	py3-service_identity
	py3-twisted
	py3-openssl
	py3-yaml
	py3-asn1
	py3-asn1-modules
	py3-daemonize
	py3-bcrypt
	py3-pillow
	py3-sortedcontainers
	py3-msgpack
	py3-phonenumbers
	py3-six
	py3-attrs
	py3-netaddr
	py3-jinja2
	py3-pymacaroons
	py3-prometheus-client
	py3-treq
	py3-lxml
	py3-psycopg2
	py3-signedjson
	py3-bleach
	py3-typing-extensions
	py3-authlib
	py3-jwt
	"
makedepends="py3-setuptools"
checkdepends="py3-mock py3-parameterized py3-hiredis"
pkgusers="synapse"
pkggroups="synapse"
install="$pkgname.pre-install $pkgname.post-install"
subpackages="$pkgname-openrc"
source="$pkgname-$pkgver.tar.gz::https://github.com/matrix-org/synapse/archive/v$pkgver.tar.gz
	relax-prometheus.patch
	synapse.initd
	synapse.confd
	"

# secfixes:
#   1.21.1-r0:
#     - CVE-2020-26891
#   1.20.0-r0:
#     - CVE-2020-26890

build() {
	python3 setup.py build
}

check() {
	PYTHONPATH="." trial tests
}

package() {
	python3 setup.py install --prefix=/usr --root="$pkgdir"

	install -d -g synapse -o synapse -m775 \
		"$pkgdir"/etc/synapse \
		"$pkgdir"/var/lib/synapse

	cp -a synapse/res "$pkgdir"/var/lib/synapse
	chown -R synapse:synapse "$pkgdir"/var/lib/synapse/res

	install -Dm755 "$srcdir"/synapse.initd "$pkgdir"/etc/init.d/synapse
	install -Dm644 "$srcdir"/synapse.confd "$pkgdir"/etc/conf.d/synapse
}

sha512sums="5ebb65ca84816b0117cdff96a24d0b8c9bc7676817d42516b2aa3b0cea70d4a00d88e7ef525f3eece168bf26091b05c88a6f3a2545073994778d6a00e40126f5  synapse-1.23.0.tar.gz
6096dcad8d88bddbe55b8722c33dba7276150691d8b538b78ed222b54f004717f3c401d918410054555e53901213ee5327be0953bc633c00d365b7053b5c5f3c  relax-prometheus.patch
4fa4a7bdd80e3b1af0f546723a64cec3b6014c5d52cfb296c41e831f73f72489bd90a3938831c0fd25cdcb03b6e27b54dfd222e325fb30525c39f5c6996687ff  synapse.initd
7c022f0e00c8ac363d6d2e003b6389fb06a3934f68390ebac156cb46bc1366585e6b6cda07b15176bc62a00f5bf21bfda153ff5418b07331257a7075102a6f83  synapse.confd"
