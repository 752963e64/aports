# Maintainer: Steve Holweg <skytep@gmail.com>
# Contributor: Baptiste Jonglez <baptiste--aur@jonglez.org>
pkgname=kea
pkgver=1.5.0
pkgrel=3
pkgdesc="High-performance, extensible DHCP server engine from ISC, supporting both DHCPv4 and DHCPv6"
url="http://kea.isc.org"
arch="all !armhf !armv7"
license="MPL2"
depends=""
makedepends="botan-dev log4cplus-dev boost-dev postgresql-dev mariadb-dev"
subpackages="
	$pkgname-doc
	$pkgname-dev
	$pkgname-admin::noarch
	$pkgname-ctrl-agent:ctrlagent
	$pkgname-dhcp-ddns:dhcpddns
	$pkgname-dhcp4
	$pkgname-dhcp6
	$pkgname-keactrl::noarch
	$pkgname-utils
	"
source="https://ftp.isc.org/isc/$pkgname/$pkgver/$pkgname-$pkgver.tar.gz
	fix-scripts-include-path.patch
	kea.initd.in
	"
validpgpkeys="BE0E9748B718253A28BB89FFF1B11BF05CF02E57" # Internet Systems Consortium, Inc. (Signing key, 2017-2018) <codesign@isc.org>

build() {
	# Complete build for dev and doc

	./configure \
		--build=$CBUILD \
		--host=$CHOST \
		--prefix=/usr \
		--sysconfdir=/etc \
		--localstatedir=/var \
		--libexecdir=/usr/lib \
		--with-mysql \
		--with-pgsql
	make
}

check() {
	# Disabled, databases are required for the test to pass
	#make check

	./src/bin/dhcp4/kea-dhcp4 -v
}

package() {
	make DESTDIR="$pkgdir" install
}

admin() {
	pkgdesc="$pkgdesc (Databases administration tools)"
	depends="$pkgname=$pkgver-r$pkgrel"

	amove ./usr/sbin/kea-admin
	amove ./usr/share/kea/
}

ctrlagent() {
	amove usr/sbin/kea-ctrl-agent
	amove ./etc/kea/kea-ctrl-agent.conf

	_install_initd kea-ctrl-agent
}

dhcpddns() {
	pkgdesc="$pkgdesc (DDNS Server)"

	amove ./usr/sbin/kea-dhcp-ddns
	amove ./etc/kea/kea-dhcp-ddns.conf

	_install_initd kea-dhcp-ddns
}

dhcp4() {
	pkgdesc="$pkgdesc (DHCP4 Server)"

	amove ./usr/sbin/kea-dhcp4
	amove ./etc/kea/kea-dhcp4.conf

	_install_initd kea-dhcp4
}

dhcp6() {
	pkgdesc="$pkgdesc (DHCP6 Server)"

	amove ./usr/sbin/kea-dhcp6
	amove ./etc/kea/kea-dhcp6.conf

	_install_initd kea-dhcp6
}

keactrl() {
	pkgdesc="$pkgdesc (Kea process manager)"

	amove ./usr/sbin/keactrl
	amove ./etc/kea/keactrl.conf
}

utils() {
	pkgdesc="$pkgdesc (Optional Utils)"

	amove ./usr/sbin/perfdhcp
	amove ./usr/sbin/kea-lfc
	amove ./usr/bin/kea-msg-compiler
}

_install_initd() {
	local name="$1"

	install -Dm755 "$srcdir"/kea.initd.in "$subpkgdir"/etc/init.d/$name
	sed -i "s|@@NAME@@|$name|g" "$subpkgdir"/etc/init.d/$name
}

sha512sums="6d6b7407831311ebe37abce382ce77c664015ddbe3e73ec78153a00b301f98af5be52e26ad4febf5ca1e478d2c1844db4c988b241d2700d758e90b077f176ad8  kea-1.5.0.tar.gz
293d523b59de8531ae0ecc1be863d9c47b940eb32017f769b212150250c86672bc0473b096eaa07ad6b682259b754a2f387a6ff2abec14a2fb8968f34585b0d5  fix-scripts-include-path.patch
94378a20f92ce03863dfc7be207faa06ab2bd207224e7beb00b89a0e81209a7bf0de102699a2bece78a415750c6efd3589aa045160ad561752ee8a390ab379f9  kea.initd.in"
