# Contributor: Sean McAvoy <seanmcavoy@gmail.com>
# Maintainer: Sean McAvoy <seanmcavoy@gmail.com>
pkgname=greetd
pkgver=0.7.0
pkgrel=1
pkgdesc="Minimal and flexible login manager daemon"
url="https://git.sr.ht/~kennylevinsen/greetd"
arch="all !mips64 !s390x !riscv64" # blocked by cargo
license="GPL-3.0-only"
makedepends="cargo linux-pam-dev scdoc"
install="$pkgname.pre-install"
pkgusers="greetd"
pkggroups="greetd"
subpackages="$pkgname-doc $pkgname-openrc $pkgname-agreety:agreety"
source="$pkgname-$pkgver.tar.gz::https://git.sr.ht/~kennylevinsen/greetd/archive/$pkgver.tar.gz
	greetd.pam
	greetd.initd
	greetd.confd
	001-change-greetd-runas.patch
	"

build() {
	RUSTFLAGS="--remap-path-prefix=$(pwd)=/build/" cargo build --release --locked
	cd man
	for i in *.scd
	do
		scdoc < "$i" > "${i%.*}"
	done

}

check() {
	RUSTFLAGS="--remap-path-prefix=$(pwd)=/build/" cargo check
}

agreety() {
	pkgdesc="Simple, text-based greeter"
	amove usr/bin/agreety
}


package() {
	install -Dm755 target/release/greetd "$pkgdir"/usr/sbin/greetd
	install -Dm755 target/release/agreety "$pkgdir"/usr/bin/agreety

	install -Dm644 config.toml "$pkgdir"/etc/greetd/config.toml
	install -Dm644 "$srcdir"/$pkgname.pam "$pkgdir"/etc/pam.d/$pkgname

	install -Dm755 "$srcdir"/$pkgname.initd "$pkgdir"/etc/init.d/$pkgname
	install -Dm644 "$srcdir"/$pkgname.confd "$pkgdir"/etc/conf.d/$pkgname

	cd man
	for s in 1 5 7
	do
		for i in *-"$s"
		do
			install -Dm644 "$i" "$pkgdir"/usr/share/man/man"$s"/${i%-*}."$s"
		done
	done
}

sha512sums="
93bec412f8bb15b8d1d82ef7bd0802aef7b72d02c1f38a601318428207f2ba1bc522519f4d8ecb7f24f9b67a111ee7b5e0744040be5e18f320cbeeacb51e1ca8  greetd-0.7.0.tar.gz
7e52d2404f9ae393721a471b7b113effa969404253f730c1360001923742a1b84e131db33d988399dae93a788db33dc1bb40e22272cd6a31c0e94cfceb47ed8a  greetd.pam
b3a035901fa2ec5a1652e9c9660d204f074b68311508464976cdf70925f2614c8eb0866563f2b09257bd5b79cb149e12abe723abce4911ce6668d4f1bc4582ba  greetd.initd
f6c5d5755fb8cca3d45d6879557fb7fc85c40879bc570e6c9aac462ce9133a2fa0a03cbac1e598f8162a9136d3e6020cea808e16e1797f4d37d4cf7dfc94c11c  greetd.confd
90a8b0e836fa29dd143ba08b0f9824403acddda2c964217e999aef2272ad7acda2da2b914ee35db7a365423cc0fccfb61521df7b6519fa9e5b6356ff1ae8b801  001-change-greetd-runas.patch
"
