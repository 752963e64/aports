# Contributor: Henrik Riomar <henrik.riomar@gmail.com>
# Maintainer: Henrik Riomar <henrik.riomar@gmail.com>
pkgname=py3-pkcs11
_pkgname=python-pkcs11
pkgver=0.7.0
pkgrel=0
pkgdesc="PKCS#11/Cryptoki support for Python"
url="https://github.com/danni/python-pkcs11"
arch="all"
license="MIT"
checkdepends="
	py3-cached-property
	py3-oscrypto
	py3-pytest
	softhsm
	"
makedepends="
	cython
	py3-setuptools_scm
	python3-dev
	"
depends="
	py3-asn1crypto
	py3-cryptography
	python3
	"
source="
	https://github.com/danni/python-pkcs11/archive/v$pkgver/$_pkgname-$pkgver.tar.gz
	0001-skip-3-failing-tests-save-for-later-investigation.patch
	"
builddir="$srcdir/$_pkgname-$pkgver"

build() {
	export SETUPTOOLS_SCM_PRETEND_VERSION=$pkgver
	python3 setup.py build
}

check() {
	# setup softhsm for tests
	tokendir=$(mktemp -d "$builddir/token.XXXXXX")
	conffile=$(mktemp "$builddir/conf.XXXXXX")
	cat > "$conffile" << EOF
directories.tokendir = $tokendir
objectstore.backend = file
EOF
	export SOFTHSM2_CONF=$conffile
	softhsm2-util --init-token --free --label pytest --pin 1234 --so-pin 987654321

	export PKCS11_TOKEN_LABEL=pytest
	export PKCS11_TOKEN_PIN=1234
	export PKCS11_TOKEN_SO_PIN=987654321

	export PKCS11_MODULE=/usr/lib/softhsm/libsofthsm2.so

	# do test installation
	export SETUPTOOLS_SCM_PRETEND_VERSION=$pkgver
	python3 setup.py install --root="$builddir"/test_install --skip-build
	PYTHONPATH="$(echo "$builddir"/test_install/usr/lib/python3*/site-packages)"
	export PYTHONPATH

	# run tests
	pytest-3 --import-mode=append
}

package() {
	export SETUPTOOLS_SCM_PRETEND_VERSION=$pkgver
	python3 setup.py install --prefix=/usr --root="$pkgdir"
}

sha512sums="
af8b300ab012226fbb0427f763f65151e9a1cb5605d62331c88d820c269bfabf7222af542212577e2e4e6c06b4f1c20c1852e53c4bcb25e30846fcda2788ac5f  python-pkcs11-0.7.0.tar.gz
da491660f7e6def3634850bc893ce2a87be7f8289109907dd4570a528d52a2e5fc59d6b980c91fe3d52e2c5a4734e791a7ffc8e04192ab899ed824566bd48988  0001-skip-3-failing-tests-save-for-later-investigation.patch
"
