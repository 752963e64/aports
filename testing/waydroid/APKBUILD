# Contributor: Bart Ribbers <bribbers@disroot.org>
# Maintainer: Bart Ribbers <bribbers@disroot.org>
pkgname=waydroid
pkgver=0_git20210906
pkgrel=0
_commit="c766c33ca6f63c00cff28b9057b6775c73b8795f"
_pkgver_images_system="17.1-20210907"
_pkgver_images_vendor="17.1-20210907"
pkgdesc="A container-based approach to boot a full Android system on a regular Linux system"
url="https://github.com/waydroid/waydroid"
# Only x86, armv7, x86_64 and aarch64 supported upstream
arch="noarch !armhf !riscv64 !ppc64le !s390x"
license="GPL-3.0-only"
depends="
	$pkgname-image
	gbinder-python
	lxc
	py3-requests
	python3
	"
install="
	$pkgname.post-install
	$pkgname.post-upgrade
	"
subpackages="$pkgname-openrc $pkgname-image"
source="https://github.com/waydroid/waydroid/archive/$_commit/waydroid-$_commit.tar.gz
	gbinder.conf
	waydroid-container.initd
	waydroid-container.confd
	waydroid-session.desktop

	https://sourceforge.net/projects/waydroid/files/images/system/lineage/waydroid_x86_64/lineage-$_pkgver_images_system-VANILLA-waydroid_x86_64-system.zip
	https://sourceforge.net/projects/waydroid/files/images/system/lineage/waydroid_arm64/lineage-$_pkgver_images_system-VANILLA-waydroid_arm64-system.zip
	https://sourceforge.net/projects/waydroid/files/images/system/lineage/waydroid_x86/lineage-$_pkgver_images_system-VANILLA-waydroid_x86-system.zip
	https://sourceforge.net/projects/waydroid/files/images/system/lineage/waydroid_arm/lineage-$_pkgver_images_system-VANILLA-waydroid_arm-system.zip

	https://sourceforge.net/projects/waydroid/files/images/vendor/waydroid_arm64/lineage-$_pkgver_images_vendor-MAINLINE-waydroid_arm64-vendor.zip
	https://sourceforge.net/projects/waydroid/files/images/vendor/waydroid_x86_64/lineage-$_pkgver_images_vendor-MAINLINE-waydroid_x86_64-vendor.zip
	https://sourceforge.net/projects/waydroid/files/images/vendor/waydroid_x86/lineage-$_pkgver_images_vendor-MAINLINE-waydroid_x86-vendor.zip
	https://sourceforge.net/projects/waydroid/files/images/vendor/waydroid_arm/lineage-$_pkgver_images_vendor-MAINLINE-waydroid_arm-vendor.zip
	"
options="!check" # No tests
builddir="$srcdir/$pkgname-$_commit"

case "$CARCH" in
	aarch64) _imgarch="arm64" ;;
	armv7) _imgarch="arm" ;;
	*) _imgarch="$CARCH" ;;
esac

unpack() {
	# Overwriting because we don't need the Waydroid images unpacked

	gunzip -c "$srcdir/waydroid-$_commit.tar.gz" | tar -C "$srcdir" -x
}

package() {
	install -dm755 "$pkgdir"/usr/lib/waydroid
	install -dm755 "$pkgdir"/usr/bin
	cp -r tools data "$pkgdir"/usr/lib/waydroid/
	cp waydroid.py "$pkgdir"/usr/lib/waydroid/
	ln -s /usr/lib/waydroid/waydroid.py "$pkgdir"/usr/bin/waydroid

	install -Dm644 -t "$pkgdir"/etc "$srcdir"/gbinder.conf
	install -Dm644 -t "$pkgdir"/etc/gbinder.d gbinder/anbox.conf
	install -Dm644 -t "$pkgdir"/etc/xdg/autostart "$srcdir"/waydroid-session.desktop

	install -Dm755 "$srcdir"/waydroid-container.initd "$pkgdir"/etc/init.d/waydroid-container
	install -Dm644 "$srcdir"/waydroid-container.confd "$pkgdir"/etc/conf.d/waydroid-container
}

image() {
	pkgdesc="$pkgdesc (Android image)"
	depends=""
	install -dm755 "$subpkgdir"/usr/share/waydroid-extra/images

	unzip -n \
			-q "$srcdir"/lineage-$_pkgver_images_system-VANILLA-waydroid_$_imgarch-system.zip \
			-d "$subpkgdir"/usr/share/waydroid-extra/images
	unzip -n \
			-q "$srcdir"/lineage-$_pkgver_images_vendor-MAINLINE-waydroid_$_imgarch-vendor.zip \
			-d "$subpkgdir"/usr/share/waydroid-extra/images
}

sha512sums="
11aabcc88b8dc4142a3f8986647b7266e7502a96c5fa3cdd2912d8f46a719010709fb3a859cf04088c7465ad7d268cc8af1ac16ade894f6d2eebce7d2cb5a1b8  waydroid-c766c33ca6f63c00cff28b9057b6775c73b8795f.tar.gz
5619d1196144cb9eb02ae3cff44b910ff7f040657b262ddd25060e7c5e6834937b6593b7e9cacd43e1c19e47990d61b6a88fc8f668113815fe95da6a7445c3f4  gbinder.conf
37ba7a520229e43e2d45e50cc45edd6d8874b546b0e273eaf4a38922346140c833da5813363d002eda9e83fdc98b351f08141c808d21c854ada357e32c1d7395  waydroid-container.initd
b841282b96110ec59a7aa539db0737327b09549d55c78dc4b2c3b28b4a6ad1facf015b3175cb6d3a38f13e47aa6314ef3dc1514a4e60dd653a97409ec54ba706  waydroid-container.confd
56dc332d66c3eb3af08887eb2f4b8235419ff87a4e4632108cdde39cf274bc88b9e95c650a7d407d05a72f1ce2edf5d465a06b7e526113d9c9ae3817a6ed1f78  waydroid-session.desktop
ebf81c62978e0fd45fb50786a3bcbdc6d401991dd727a9b2537e05fb15ab0c12fa51cc45794f0a871367e0afa3c607e07247b8f7b53b4b3d803162f88fc38311  lineage-17.1-20210907-VANILLA-waydroid_x86_64-system.zip
d3ea11c2c926ce77d4c23d853aaf685536ea04b06251cb524569d8be8d8d8c46ca5d2c460ebd615732fc494848b28dd6855d2356346a94c0b2b368e95f720123  lineage-17.1-20210907-VANILLA-waydroid_arm64-system.zip
c30a81cf8c12ba145ef2723feeece11f1767cb70e784870e94b1da557445681fb727ff33733c558253341427d0d227a8a9bc5bb9bb488b99dfd8d7b019e658df  lineage-17.1-20210907-VANILLA-waydroid_x86-system.zip
0ec1defb6e628dd39d51695dd28d473cbff03b74828cf96915159978ec452214060f3f95b9e643974650b9bf3c83eea4ae63cdf17ad464620b82c26236d7aebf  lineage-17.1-20210907-VANILLA-waydroid_arm-system.zip
b7e8f45c0f90ecf3ca9cdfecce3265a3a0f188f71eecb541d5430409ab83d12cc9d6a2459af22b691c155b85215c479d93f32df3a0be9e1d86d21dbb43e9df0a  lineage-17.1-20210907-MAINLINE-waydroid_arm64-vendor.zip
a60bd3a89f13b86aed3190da4970d9d0f61fd300a21666ca58c0d0ff7a686a9c95c88e1122efd357010b4252bf9701bee798fb43af04747be7b88f89cba04b8b  lineage-17.1-20210907-MAINLINE-waydroid_x86_64-vendor.zip
b130ad73f38046ade6bd10ed74b7cd251c200aa8a5b786966a05a0e751bbec0469dd9312afc2e66823f6d7aeb3988cb29464857afc602745ace55bdba9535f15  lineage-17.1-20210907-MAINLINE-waydroid_x86-vendor.zip
c29445631294cd8ef09667746fef399b14c7cf38eb6f042c74e3808cfcf42e31b77a5d677ded5a7d39f1c42a2e6147b156479185424df6dc791605a0d6d1d35c  lineage-17.1-20210907-MAINLINE-waydroid_arm-vendor.zip
"
