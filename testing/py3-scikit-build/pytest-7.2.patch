Patch-Source: https://github.com/scikit-build/scikit-build/commit/8f848eaa50c2196619e145f4a1ea6ba3a84b7134
From 8f848eaa50c2196619e145f4a1ea6ba3a84b7134 Mon Sep 17 00:00:00 2001
From: Henry Schreiner <henryschreineriii@gmail.com>
Date: Tue, 22 Nov 2022 15:46:45 -0500
Subject: [PATCH] tests: support pytest 7.2+

Signed-off-by: Henry Schreiner <henryschreineriii@gmail.com>
---
 requirements-dev.txt     | 2 +-
 tests/__init__.py        | 6 ++++--
 tests/test_hello_cpp.py  | 6 +++---
 tests/test_hello_pure.py | 2 +-
 tests/test_skbuild.py    | 4 ++--
 5 files changed, 11 insertions(+), 9 deletions(-)

diff --git a/requirements-dev.txt b/requirements-dev.txt
index 58685314..e210f6ef 100644
--- a/requirements-dev.txt
+++ b/requirements-dev.txt
@@ -4,7 +4,7 @@ coverage>=4.2
 cython>=0.25.1
 flake8>=3.0.4
 path.py>=11.5.0
-pytest>=6.0.0,<7.2.0
+pytest>=6.0.0
 pytest-cov>=2.7.1
 pytest-mock>=1.10.4
 pytest-runner>=5.1
diff --git a/tests/__init__.py b/tests/__init__.py
index d8cd7f90..5076a179 100644
--- a/tests/__init__.py
+++ b/tests/__init__.py
@@ -247,7 +247,7 @@ def write_test_cmakelist_no_languages(_self, _languages):
         yield
 
 
-def project_setup_py_test(project, setup_args, tmp_dir=None, verbose_git=True, disable_languages_test=False):
+def project_setup_py_test(project, setup_args, tmp_dir=None, verbose_git=True, disable_languages_test=False, ret=False):
     def dec(fun):
         @functools.wraps(fun)
         def wrapped(*iargs, **ikwargs):
@@ -260,7 +260,9 @@ def wrapped(*iargs, **ikwargs):
             with execute_setup_py(wrapped.tmp_dir, wrapped.setup_args, disable_languages_test=disable_languages_test):
                 result2 = fun(*iargs, **ikwargs)
 
-            return wrapped.tmp_dir, result2
+            if ret:
+                return wrapped.tmp_dir, result2
+            return None
 
         wrapped.project = project
         wrapped.setup_args = setup_args
diff --git a/tests/test_hello_cpp.py b/tests/test_hello_cpp.py
index 03fe841a..5a040bb2 100644
--- a/tests/test_hello_cpp.py
+++ b/tests/test_hello_cpp.py
@@ -21,7 +21,7 @@
 def test_hello_builds():
     with push_dir():
 
-        @project_setup_py_test("hello-cpp", ["build"])
+        @project_setup_py_test("hello-cpp", ["build"], ret=True)
         def run():
             pass
 
@@ -84,7 +84,7 @@ def test_hello_wheel():
 
     expected_distribution_name = "hello-1.2.3"
 
-    @project_setup_py_test("hello-cpp", ["bdist_wheel"])
+    @project_setup_py_test("hello-cpp", ["bdist_wheel"], ret=True)
     def build_wheel():
         whls = glob.glob("dist/*.whl")
         assert len(whls) == 1
@@ -113,7 +113,7 @@ def test_hello_clean(dry_run, capfd):
 
         dry_run = dry_run == "with-dry-run"
 
-        @project_setup_py_test("hello-cpp", ["build"])
+        @project_setup_py_test("hello-cpp", ["build"], ret=True)
         def run_build():
             pass
 
diff --git a/tests/test_hello_pure.py b/tests/test_hello_pure.py
index e27553ca..26e4836f 100644
--- a/tests/test_hello_pure.py
+++ b/tests/test_hello_pure.py
@@ -58,7 +58,7 @@ def test_hello_pure_wheel():
 def test_hello_clean(capfd):
     with push_dir():
 
-        @project_setup_py_test("hello-pure", ["build"], disable_languages_test=True)
+        @project_setup_py_test("hello-pure", ["build"], disable_languages_test=True, ret=True)
         def run_build():
             pass
 
diff --git a/tests/test_skbuild.py b/tests/test_skbuild.py
index 5a1c7756..6fdd49a7 100644
--- a/tests/test_skbuild.py
+++ b/tests/test_skbuild.py
@@ -84,7 +84,7 @@ def test_generator(generator, expected_make_program):
     if this_platform not in generator_platform[generator]:
         pytest.skip(f"{generator} generator is available only on {this_platform.title()}")
 
-    @project_setup_py_test("hello-cpp", ["build"])
+    @project_setup_py_test("hello-cpp", ["build"], ret=True)
     def run_build():
         pass
 
@@ -160,7 +160,7 @@ def test_toolset():
     if arch == "64bit":
         vs_generator += " Win64"
 
-    @project_setup_py_test("hello-cpp", ["build", "-G", vs_generator])
+    @project_setup_py_test("hello-cpp", ["build", "-G", vs_generator], ret=True)
     def run_build():
         pass
 
