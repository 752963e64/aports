# Contributor: Will Sinatra <wpsinatra@gmail.com>
# Maintainer: Will Sinatra <wpsinatra@gmail.com>
pkgname=chez-scheme
# XXX: Upgrades require rebuilding testing/idris2.
pkgver=9.5.8
pkgrel=0
pkgdesc="Cisco R6RS Scheme Compiler"
url="https://github.com/cisco/ChezScheme"
# upstream only supports x86/x86_64/armhf. The latter is broken atm.
#  armhf:   https://github.com/cisco/ChezScheme/issues/622
#  aarch64: https://github.com/cisco/ChezScheme/issues/545
#  riscv64: https://github.com/cisco/ChezScheme/issues/601
arch="x86 x86_64"
license="Apache-2.0"
makedepends="util-linux-dev ncurses-dev libx11-dev"
subpackages="$pkgname-doc"
source="https://github.com/cisco/ChezScheme/releases/download/v$pkgver/csv$pkgver.tar.gz
	x86_64bit-time_t.patch"
builddir="$srcdir"/csv$pkgver

build() {
	case "$CARCH" in
		x86)    _host=ti3le   ;;
		x86_64) _host=ta6le   ;;
		armhf)  _host=arm32le ;;
	esac

	case "$CARCH" in
		x86)    conf="--threads" ;;
		x86_64) conf="--threads" ;;
		armhf)  conf=""          ;;
	esac

	./configure \
		--installprefix=/usr \
		--temproot=$pkgdir \
		--installschemename="chez" \
		--installscriptname="chez-script" \
		--machine=$_host \
		$conf
	make
}

check() {
	make test
}

package() {
	make install DESTDIR="$pkgdir"
}

sha512sums="
80a4e9f61ddb254bef1a249af1d32f918df88390946fbe6eeb62c3510c760bf899285be1aba70eda9b54bcb0c6fef3fe7deace648993cd9cece2d08cf0ade9c0  csv9.5.8.tar.gz
e3ca092032fbc17e3bb946d5a8909665916941474efdd04b9a8918d5432ce7f3340b6de55658399be24428778b916a181ba8c9d34d29afc998f804a4ff3a2e69  x86_64bit-time_t.patch
"
