# Contributor: Tom Lebreux <me@tomlebreux.com>
# Maintainer: Tom Lebreux <me@tomlebreux.com>
pkgname=navidrome
pkgver=0.41.1
_gitsha="43bb075"
pkgrel=0
pkgdesc="Modern Music Server and Streamer compatible with Subsonic/Airsonic"
url="https://navidrome.org/"
arch="all"
license="GPL-3.0-or-later"
options="chmod-clean"
depends="ffmpeg"
makedepends="go npm taglib-dev zlib-dev"
install="$pkgname.pre-install"
subpackages="$pkgname-openrc"
pkgusers="navidrome"
pkggroups="navidrome"
source="
	$pkgname-$pkgver.tar.gz::https://github.com/navidrome/navidrome/archive/refs/tags/v$pkgver.tar.gz
	navidrome.initd
	navidrome.confd
	navidrome.toml
	"

export GOPATH="$srcdir"

build() {
	make setup
	# Prevents crash due to allocation failure
	echo 'node-options=--max_old_space_size=3072' > ./ui/.npmrc
	cd ./ui/
	npm run build
	cd ..

	CGO_ENABLED=1 go build \
		-trimpath \
		-ldflags="
			-X github.com/navidrome/navidrome/consts.gitSha=$_gitsha
			-X github.com/navidrome/navidrome/consts.gitTag=v$pkgver" \
		-tags=embed,netgo
}

check() {
	make testall
}

package() {
	install -Dm755 navidrome "$pkgdir"/usr/bin/navidrome

	install -Dm644 "$srcdir"/navidrome.toml \
		"$pkgdir"/etc/navidrome/navidrome.toml

	install -Dm755 "$srcdir"/$pkgname.initd \
		"$pkgdir"/etc/init.d/$pkgname
	install -Dm644 "$srcdir"/$pkgname.confd \
		"$pkgdir"/etc/conf.d/$pkgname

	install -dm755 -o navidrome -g navidrome \
		"$pkgdir"/var/log/navidrome \
		"$pkgdir"/var/lib/navidrome/data \
		"$pkgdir"/var/lib/navidrome/music
}

sha512sums="179b9af6c3925844330231f7a9d28e511e62e84475af76f92985373011fab04e525f9e0b3da88894d0f13a03f88fb83e8da67481ff4d370d9d433e3b6fcbb16f  navidrome-0.41.1.tar.gz
f19eb1203b211a75560c89c75a6bb8087a118a5e073f15785b8486a48f06f7e155f61d288e25f35237658922c396f019ea873d710594f726e51a1bd2dd110ea2  navidrome.initd
c25d08fbe561922344836ca4a345163b7de377fd7f699aeca7a36fd2ec8a16e185c697971d552d02f56f03c9515a4f3d5a516103d1662a157411a41fe956780d  navidrome.confd
e3f3e8f56e10dc56a7995a7d1542713730202e68ba065b1024802cccfef36d330be4ab8a779c3f57987652f9b8cff8a1e88a04d91af278f1dfbed5d4a120ddb6  navidrome.toml"
