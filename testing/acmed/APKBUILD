# Contributor: Patrycja Rosa <alpine@ptrcnull.me>
# Maintainer: Patrycja Rosa <alpine@ptrcnull.me>
pkgname=acmed
pkgver=0.19.0
pkgrel=1
pkgdesc="ACME (RFC 8555) client daemon"
url="https://github.com/breard-r/acmed"
# s390x, riscv64: blocked by cargo
arch="all !s390x !riscv64"
license="MIT"
pkgusers="acmed"
pkggroups="acmed"
makedepends="cargo openssl-dev"
subpackages="$pkgname-doc $pkgname-openrc $pkgname-tacd $pkgname-tacd-doc:tacd_doc"
install="acmed.pre-install"
source="https://github.com/breard-r/acmed/archive/refs/tags/v$pkgver/acmed-$pkgver.tar.gz
	Cargo.lock
	acmed.confd
	acmed.initd
	remove-libc-time_t.patch
	"

prepare() {
	default_prepare
	mv "$srcdir"/Cargo.lock "$builddir"
	cargo fetch --locked
}

build() {
	cargo build --release --frozen
}

check() {
	cargo test --frozen
}

package() {
	install -Dm755 -t "$pkgdir"/usr/bin \
		target/release/acmed \
		target/release/tacd

	install -Dm644 -t "$pkgdir"/etc/acmed \
		acmed/config/*
	install -d -o acmed -g acmed "$pkgdir"/var/lib/acmed

	install -Dm644 -t "$pkgdir"/usr/share/man/man8 \
		man/en/acmed.8
	install -Dm644 -t "$pkgdir"/usr/share/man/man5 \
		man/en/acmed.toml.5

	install -Dm755 "$srcdir"/acmed.initd "$pkgdir"/etc/init.d/acmed
	install -Dm644 "$srcdir"/acmed.confd "$pkgdir"/etc/conf.d/acmed
}

tacd() {
	pkgdesc="Standalone tls-alpn-01 challenge validation server"

	amove /usr/bin/tacd
}

tacd_doc() {
	install -Dm644 -t "$pkgdir"/usr/share/man/man8 \
		"$builddir"/man/en/tacd.8

	default_doc
	pkgdesc="Standalone tls-alpn-01 challenge validation server (documentation)"
	install_if="docs $pkgname-tacd=$pkgver-r$pkgrel"
}

sha512sums="
d11c5a7bd32a065d7799cdde8bfea9fe070eeae7b33003a55a28b1f50daaf1be34f0d6c8a902274c9be2b26b21c8af0e6690dec7750cc85a9db313c3fce49f1d  acmed-0.19.0.tar.gz
1a4d91c93ca6badac96955d49395b5d18ad28fc155df31b1ec3cf1ec5ca5273444cca52c9ff7fd23bb744e2e54de8e3006945daf5c1e085671547d3f8ea55e92  Cargo.lock
23440890f61045df3fe3acbf1d54548eb0102d3871e536698efb7e6d2a238984a556a4294ad1588b53d79ebb5029c6268f8779634d8bebd0a611898b1c8187ff  acmed.confd
91192fd4a5da625ee6462e61aab991acac8644ec4317ecf289a17b424b93a0c615e74eec1b8b41baa42dc97c2e31846b4df3dfc19b22a504b4f01cb335c71843  acmed.initd
a519771345e4844bc0c803d0c85f89f521e5256b83bf6180aa1d54ed2b9f6823c516c467fa1ba53cb9f8ef7b771262f479e2bc6333c890944f1893301f83e930  remove-libc-time_t.patch
"
