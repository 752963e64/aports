# Contributor: ungleich <foss@ungleich.ch>
# Contributor: Francesco Colista <fcolista@alpinelinux.org>
# Contributor: TBK <alpine@jjtc.eu>
# Maintainer: ungleich <foss@ungleich.ch>
pkgname=cri-o
pkgver=1.20.0
pkgrel=3
pkgdesc="OCI-based implementation of Kubernetes Container Runtime Interface"
url="https://github.com/cri-o/cri-o/"
arch="all !mips !mips64" # limited by go
license="Apache-2.0"
options="net chmod-clean !check" # Most tests will fail if not ran as root
depends="
	cni-plugins
	conmon
	conntrack-tools
	containers-common
	iproute2
	iptables
	runc
	"
makedepends="
	bash
	btrfs-progs-dev 
	eudev-dev
	glib-dev
	go
	go-md2man
	gpgme-dev
	libseccomp-dev
	libselinux-dev
	lvm2-dev
	ostree-dev
	tzdata
	"
checkdepends="bats cri-tools jq parallel sudo"
subpackages="
	$pkgname-doc
	$pkgname-bash-completion
	$pkgname-zsh-completion
	$pkgname-fish-completion
	$pkgname-contrib-cni:contrib_cni:noarch
	$pkgname-openrc
	"
source="https://github.com/cri-o/cri-o/archive/v$pkgver/cri-o-$pkgver.tar.gz
	crio.initd
	crio.logrotated
	cni-plugins-path.patch
	fix-test.patch
	"

build() {
	export GOPATH="$srcdir" 
	export GOBIN="$GOPATH/bin"
	# https://github.com/cri-o/cri-o/blob/master/install.md#build-tags
	make BUILDTAGS="seccomp selinux containers_image_openpgp containers_image_ostree_stub"
}

check() {
	make localintegration
}

package() {
	make DESTDIR="$pkgdir" PREFIX="$pkgdir/usr" CRICTL_CONFIG_DIR="$pkgdir/etc/crio" install

	# Remove systemd files
	rm -rf "$pkgname"/usr/lib/systemd
	
	install -Dm755 "$srcdir"/crio.initd "$pkgdir"/etc/init.d/crio
	install -D -m644 "$srcdir"/crio.logrotated "$pkgdir"/etc/logrotate.d/crio
#	install -Dm644 "crio.conf" "$pkgdir/etc/crio/crio.conf"
	install -Dm644 crio-umount.conf "$pkgdir/etc/crio/crio-umount.conf"

	# Suppress cri-o log error messages triggered if these do not exist
	mkdir -p  "$pkgdir"/etc/crio/crio.conf.d/
	mkdir -p  "$pkgdir"/etc/containers/oci/hooks.d
	mkdir -p  "$pkgdir"/usr/share/containers/oci/hooks.d
}

contrib_cni() {
	pkgdesc="$pkgname contrib cni config files package"
	mkdir -p "$subpkgdir"/etc/cni/net.d
	cp "$builddir"/contrib/cni/*.conf "$subpkgdir"/etc/cni/net.d
}

sha512sums="9bc718d0f2e082947f592e3a26f75a8a05116defecff7270f058e47ca0d0ba0a2a581ee155df15d5466e6dff8049bd52abc883577d7b917a0342d2133649d46c  cri-o-1.20.0.tar.gz
29561e95398975748236217bbd9df64997f6e3de6c0555d007306bd0535895a648368385a13079eb7d52c06249a91980523a73b6563e86d0575d9cd9c3fa4ee9  crio.initd
1115228546a696eeebeb6d4b3e5c3152af0c99a2559097fc5829d8b416d979c457b4b1789e0120054babf57f585d3f63cbe49949d40417ae7aab613184bf4516  crio.logrotated
0a567dfa431ab1e53f2a351689be8d588a60cc5fcdbda403ec4f8b6ab9b1c18ad425f6c47f9a5ab1491e3a61a269dc4efa6a59e91e7521fa2b6bb165074aa8e0  cni-plugins-path.patch
26ed10b478feb19cb11f5916b24301943f9e316fdd62d53ec310bb05ffcf4213ceece1340d2486461557abb04074e85002b11b6347fddaaa45ad7439e907a5a7  fix-test.patch"
