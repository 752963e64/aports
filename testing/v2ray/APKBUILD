# Contributor: nibon7 <nibon7@163.com>
# Maintainer: nibon7 <nibon7@163.com>
pkgname=v2ray
pkgver=4.34.0
pkgrel=0
pkgdesc="A platform for building proxies to bypass network restrictions"
url="https://github.com/v2fly/v2ray-core"
arch="all"
license="MIT"
options="chmod-clean"
makedepends="go"
subpackages="$pkgname-openrc"
source="https://github.com/v2fly/v2ray-core/archive/v$pkgver/v2ray-core-$pkgver.tar.gz
	v2ray.initd
	"

builddir="$srcdir"/$pkgname-core-$pkgver

export CGO_ENABLED=0

build() {
	local ldflags="
		-X v2ray.com/core.codename=$pkgname
		-X v2ray.com/core.version=$pkgver
		-X v2ray.com/core.build=$(date -u +%Y-%m-%dT%H:%M:%S%z)
		-s -w -buildid=
		"
	go build -trimpath -ldflags "$ldflags" -o v2ray ./main
	go build -trimpath -ldflags "$ldflags" -tags confonly -o v2ctl \
		./infra/control/main
}

check() {
	local pkgs="./..."
	# proxy/vmess/{,aead,encoding}, testing/sceanarios: fails in alpine-gitlab-ci environment, but not on real machines
	# app/router/command fails on armv7
	case "$CARCH" in
	armv7) pkgs=$(go list ./... | grep -v \
		-e 'proxy/vmess$' \
		-e 'proxy/vmess/aead$' \
		-e 'proxy/vmess/encoding$' \
		-e 'testing/scenarios$' \
		-e 'app/router/command$' \
		);;
	*) pkgs=$(go list ./... | grep -v \
		-e 'proxy/vmess$' \
		-e 'proxy/vmess/aead$' \
		-e 'proxy/vmess/encoding$' \
		-e 'testing/scenarios$' \
		);;
	esac
	go test $pkgs
}

package() {
	install -Dm755 -d "$pkgdir"/etc/$pkgname
	install -m644 release/config/*.json -t "$pkgdir"/etc/$pkgname

	install -Dm755 -d "$pkgdir"/usr/share/$pkgname
	install -m644 release/config/*.dat -t "$pkgdir"/usr/share/$pkgname

	install -Dm755 v2ray "$pkgdir"/usr/bin/v2ray
	install -Dm755 v2ctl "$pkgdir"/usr/bin/v2ctl

	install -Dm755 "$srcdir"/$pkgname.initd "$pkgdir"/etc/init.d/$pkgname
}

sha512sums="82a6f13bcaf61ec30b54d0f09ebff23d830bf2261731652179b739b758b4f116c5fef9890acf5832f75a5af8940ab9e8db198b5b4a1bc804736ff5b3d5d5d112  v2ray-core-4.34.0.tar.gz
f22cd2ef4182a003a4e0f94a550e5805c6c30d608d9e655c98e850b5fd8b3785c30df9a8e07c2d5460e6dac9088316f901018a89143e47c9da168e3aee3b94ca  v2ray.initd"
