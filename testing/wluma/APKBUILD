# Contributor: Jakub Jirutka <jakub@jirutka.cz>
# Maintainer: Jakub Jirutka <jakub@jirutka.cz>
pkgname=wluma
pkgver=4.1.2
pkgrel=0
pkgdesc="Automatic brightness adjustment based on screen contents and ALS"
url="https://github.com/maximbaz/wluma"
# riscv64, s390x: blocked by rust/cargo
# arm*, x86: fails to build due to crappy v4l crate
arch="aarch64 ppc64le x86_64"
license="ISC"
makedepends="
	cargo
	cargo-patch
	clang
	eudev-dev
	v4l-utils-dev
	wayland-dev
	vulkan-loader-dev
	"
install="$pkgname.post-install"
source="https://github.com/maximbaz/wluma/archive/$pkgver/wluma-$pkgver.tar.gz
	cargo.patch

	v4l-01-fix-string-pointer-cast.cargo-patch
	v4l-02-fix-wrong-_IOC_TYPE-on-musl.cargo-patch
	"

# wayland-client/use_system_lib - link to libwayland-client.so instead of using Rust impl.
_cargo_opts="--frozen --features wayland-client/use_system_lib"

prepare() {
	default_prepare

	# Optimize binary for size.
	cat >> Cargo.toml <<-EOF

		[profile.release]
		codegen-units = 1
		lto = true
		opt-level = "s"
		panic = "abort"
	EOF

	cargo patch
	cargo fetch --locked
}

build() {
	cargo build $_cargo_opts --release
}

check() {
	cargo test $_cargo_opts
}

package() {
	install -D -m755 target/release/wluma -t "$pkgdir"/usr/bin/
	install -D -m644 90-wluma-backlight.rules -t "$pkgdir"/lib/udev/rules.d/
}

sha512sums="
d9e16f0af0961678c9f59fd692f50e517cf0f5791d16c50314ee909cab81b468c921850d50f264199cf4b52388d3e30797d7cc82ab22d71f26ee3e5705157992  wluma-4.1.2.tar.gz
15fec05d782ca07b1702c8f12a20913ee794e5e234cfbedbf6d73e4d7811e21563ab771d889d2401961d9879103d67cd63b4f637fca196776c7fa5a60fc3d0d3  cargo.patch
cd9e718a2950b71039e2be15c004f5236667fab2025766759e56f46454e24d845b863d400f8655bd2a40e1a4b2366307e263eff714db85062dab8c68df10a838  v4l-01-fix-string-pointer-cast.cargo-patch
b19d53e00859005d2a91cc6d0d99450e753bbce3b5843e26d0153ddbe38835346dea580988573bd1c7230effe5a260889bc3b82b71dfba2a6d9106253f62dc0e  v4l-02-fix-wrong-_IOC_TYPE-on-musl.cargo-patch
"
