# Contributor: Jakub Jirutka <jakub@jirutka.cz>
# Maintainer: Jakub Jirutka <jakub@jirutka.cz>
pkgname=wluma
pkgver=4.1.0
pkgrel=0
pkgdesc="Automatic brightness adjustment based on screen contents and ALS"
url="https://github.com/maximbaz/wluma"
# riscv64, s390x: blocked by rust/cargo
# arm*, x86: fails to build due to crappy v4l crate
arch="aarch64 ppc64le x86_64"
license="ISC"
makedepends="
	cargo
	cargo-patch
	clang
	eudev-dev
	v4l-utils-dev
	wayland-dev
	"
install="$pkgname.post-install"
source="https://github.com/maximbaz/wluma/archive/$pkgver/wluma-$pkgver.tar.gz
	cargo-patch-v4l.patch

	v4l-01-fix-string-pointer-cast.cargo-patch
	v4l-02-fix-wrong-_IOC_TYPE-on-musl.cargo-patch
	"

prepare() {
	default_prepare

	# Optimize binary for size.
	cat >> Cargo.toml <<-EOF

		[profile.release]
		codegen-units = 1
		lto = true
		opt-level = "s"
		panic = "abort"
	EOF

	cargo patch
	cargo fetch --locked
}

build() {
	cargo build --frozen --release
}

check() {
	cargo test --frozen
}

package() {
	install -D -m755 target/release/wluma -t "$pkgdir"/usr/bin/
	install -D -m644 90-wluma-backlight.rules -t "$pkgdir"/lib/udev/rules.d/
}

sha512sums="
c677cb4c8974be3bab3ac88c0f3e37dc74c93190a09c76ad97f064e8d845cf5949dc58587bb64804fda6f30b31976072ecc18ceb60a488edd1e7cb58cad1d0e6  wluma-4.1.0.tar.gz
bea9f2c0118ea0a35631846dad1fdfa821a100bc376fb7c324266b8f30218acd154bd2544379fc1ef5fc9560caa8ba7fbbb1cb7539b7840fdf979fdcd225deb1  cargo-patch-v4l.patch
cd9e718a2950b71039e2be15c004f5236667fab2025766759e56f46454e24d845b863d400f8655bd2a40e1a4b2366307e263eff714db85062dab8c68df10a838  v4l-01-fix-string-pointer-cast.cargo-patch
b19d53e00859005d2a91cc6d0d99450e753bbce3b5843e26d0153ddbe38835346dea580988573bd1c7230effe5a260889bc3b82b71dfba2a6d9106253f62dc0e  v4l-02-fix-wrong-_IOC_TYPE-on-musl.cargo-patch
"
