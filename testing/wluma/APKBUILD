# Contributor: Jakub Jirutka <jakub@jirutka.cz>
# Maintainer: Jakub Jirutka <jakub@jirutka.cz>
pkgname=wluma
pkgver=4.1.2
pkgrel=0
pkgdesc="Automatic brightness adjustment based on screen contents and ALS"
url="https://github.com/maximbaz/wluma"
# riscv64, s390x: blocked by rust/cargo
# arm*, x86: fails to build due to crappy v4l crate
arch="aarch64 ppc64le x86_64"
license="ISC"
makedepends="
	cargo
	clang
	eudev-dev
	v4l-utils-dev
	wayland-dev
	vulkan-loader-dev
	"
install="$pkgname.post-install"
_libv4l_gitrev=d7ac716f6065a0e1aa47ef673387603d6eacc4f0
source="https://github.com/maximbaz/wluma/archive/$pkgver/wluma-$pkgver.tar.gz
	https://github.com/raymanfx/libv4l-rs/archive/$_libv4l_gitrev/libv4l-rs-$_libv4l_gitrev.tar.gz
	libv4l-rs-01-fix-string-pointer-cast.patch
	libv4l-rs-02-fix-wrong-_IOC_TYPE-on-musl.patch
	cargo.patch
	"

# wayland-client/use_system_lib - link to libwayland-client.so instead of using Rust impl.
_cargo_opts="--frozen --features wayland-client/use_system_lib"

prepare() {
	mv ../libv4l-rs-$_libv4l_gitrev "$builddir"/libv4l-rs

	default_prepare

	# Optimize binary for size.
	cat >> Cargo.toml <<-EOF

		[profile.release]
		codegen-units = 1
		lto = true
		opt-level = "s"
		panic = "abort"
	EOF

	cargo fetch --locked
}

build() {
	cargo build $_cargo_opts --release
}

check() {
	cargo test $_cargo_opts
}

package() {
	install -D -m755 target/release/wluma -t "$pkgdir"/usr/bin/
	install -D -m644 90-wluma-backlight.rules -t "$pkgdir"/lib/udev/rules.d/
}

sha512sums="
d9e16f0af0961678c9f59fd692f50e517cf0f5791d16c50314ee909cab81b468c921850d50f264199cf4b52388d3e30797d7cc82ab22d71f26ee3e5705157992  wluma-4.1.2.tar.gz
7b60a001e695b7b7281807c2d96ad640d1072093a97279299f3051bfae6eed32e23ddc72dbcd0a06416cd5e8497012b13a0c3dac43ae7ec1b79cc77c3f1e2599  libv4l-rs-d7ac716f6065a0e1aa47ef673387603d6eacc4f0.tar.gz
828075e7bec0317c137ce0d68424d209cdf62ff24c55e813f4449401de884643bd9e6114acbf92f002459f4a95d4d672bab4eba03216351319b7f0366b3006f3  libv4l-rs-01-fix-string-pointer-cast.patch
62d81304209f072cb63073b306e6b61fbd0e7cd0c1cde75f1c24e792385c437e1c6737ec3713b9f71bae0c9b37ad47b08605b5c4af6d6ebf78d5fc9a9628fea5  libv4l-rs-02-fix-wrong-_IOC_TYPE-on-musl.patch
60023fe3afa25d6a4d6a4d5b1c50f40a1e36ee36dbdb539612628a884f068cff507926ba0375a0a76af865d31c1f63a838083ffbe622cfbee7015ca20ebbfcd2  cargo.patch
"
