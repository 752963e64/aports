# Contributor: Mark Pashmfouroush <mark@markpash.me>
# Maintainer: Mark Pashmfouroush <mark@markpash.me>
pkgname=coredns
pkgver=1.8.6
pkgrel=1
pkgdesc="fast and flexible DNS server"
url="https://github.com/coredns/coredns"
license="Apache-2.0"
arch="all"
options="net"
makedepends="go libcap"
install="$pkgname.pre-install"
subpackages="$pkgname-openrc"
source="
	$pkgname-$pkgver.tar.gz::https://github.com/coredns/coredns/archive/v$pkgver.tar.gz
	coredns.confd
	coredns.initd
	plugin.cfg.enabled
	"

prepare() {
	default_prepare
	cp $srcdir/plugin.cfg.enabled $builddir/plugin.cfg
}

build() {
	make
}

check() {
	cd "$builddir"/request; go test ./...
	cd "$builddir"/core; go test ./...
	cd "$builddir"/coremain; go test ./...
	cd "$builddir"/plugin; go test ./...
}

package() {
	install -Dm755 coredns "$pkgdir"/usr/bin/coredns
	setcap cap_net_bind_service=+ep "$pkgdir"/usr/bin/coredns

	install -Dm755 "$srcdir"/coredns.initd "$pkgdir"/etc/init.d/coredns
	install -Dm644 "$srcdir"/coredns.confd "$pkgdir"/etc/conf.d/coredns
	install -d "$pkgdir"/etc/coredns
}

sha512sums="
589e05aaec71acd242aae69a68dacb2575fe9c436d7a318adbc963a3302a6e343a0c1a0966c9fb7819cec38bd91e3b4036e65b3080b5016514c24f26caad737e  coredns-1.8.6.tar.gz
2ff396033c570f45b5880556a8724b05356276db451cf6e6cfb477f64f4b863801a891940f72c0b1c8268bae176094d02890d27146901f296e4e8d9b703934d2  coredns.confd
bf41d970e37396c64d466d1b20902ec8166965ca9aee92efce33744c457037f3f4974cd6a0c2ee1745fda0e309356a79cdae53551ab9d2211f384fabc0a7ff38  coredns.initd
fd6193c9b1ff9788a604f068d13f4f146cf6ccce8a8554fab884b4a862210d636f77839167c80d87b035e2191f302269c6facd5911b51c633beb32b6345ac1d6  plugin.cfg.enabled
"
