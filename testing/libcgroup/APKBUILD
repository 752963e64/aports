# Contributor: psykose <alice@ayaya.dev>
# Maintainer: psykose <alice@ayaya.dev>
pkgname=libcgroup
# TODO: stable 2.0 does not build
pkgver=2.0_git20220304
_gitrev=b275d89b489234f3dc2eef9784873a7903508a5c
pkgrel=0
_gtest=ec44c6c1675c25b9827aacd08c02433cccde7780
_tests=2aa90061eccb7dbd3d3ce7f6cdf2e087cf8a95a2
pkgdesc="cgroup library"
url="https://github.com/libcgroup/libcgroup"
arch="all"
license="LGPL-2.1-only"
makedepends="
	autoconf
	automake
	bsd-compat-headers
	byacc
	flex
	fts-dev
	libtool
	linux-headers
	linux-pam-dev
	"
subpackages="$pkgname-doc $pkgname-static $pkgname-pam $pkgname-dev cgroup-tools:_tools"
source="$pkgname-$_gitrev.tar.gz::https://github.com/libcgroup/libcgroup/archive/$_gitrev.tar.gz
	gtest-$_gtest.tar.gz::https://github.com/google/googletest/archive/$_gtest.tar.gz
	libcgroup-tests-$_tests.tar.gz::https://github.com/libcgroup/libcgroup-tests/archive/$_tests.tar.gz
	"
builddir="$srcdir/$pkgname-$_gitrev"
# tests seem to fail for no reason
# cgexec suid
options="!check suid"

prepare() {
	default_prepare
	mv "$srcdir"/googletest-$_gtest/* \
		"$builddir"/googletest
	mv "$srcdir"/libcgroup-tests-$_tests/* \
		"$builddir"/tests
	autoreconf -fi
}

build() {
	./configure \
		--build=$CBUILD \
		--host=$CHOST \
		--prefix=/usr \
		--sysconfdir=/etc \
		--mandir=/usr/share/man \
		--localstatedir=/var \
		--enable-pam-module-dir=/lib/security
	make
}

check() {
	make check
}

package() {
	make DESTDIR="$pkgdir" install
	# the .so is the one that is used
	rm "$pkgdir"/lib/security/pam_cgroup.a
}

pam() {
	pkgdesc="$pkgdesc (pam module)"
	amove lib/security
}

_tools() {
	pkgdesc="$pkgdesc (tools)"
	amove usr/bin usr/sbin
}

sha512sums="
12fad5c60bf424d5f4e2f024d20038c15e6e57a55486c8c82f1d2619cd71d3b49fe9c39c177e09d48d7741106792781b0fce7667ab0835b9a0b81201372f4ad1  libcgroup-b275d89b489234f3dc2eef9784873a7903508a5c.tar.gz
dd55ab745c43c5c953d8cebd2fb44b4bb2cb87c95194965bffd0bd8219332d5f073c22947c8a8b1e2652805dff1cff4b93fe69645d4c0d635f98ae2cf54af14a  gtest-ec44c6c1675c25b9827aacd08c02433cccde7780.tar.gz
d36ecc45f78897e20a9bb4f6c5bb47092d39c7b3a2fb9f57919307703d6dd74433957ffab378efad7226763919bf512212b08bdaf7ceb15f3bdfaf06a4bcabb2  libcgroup-tests-2aa90061eccb7dbd3d3ce7f6cdf2e087cf8a95a2.tar.gz
"
