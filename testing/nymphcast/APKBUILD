# Contributor: Bart Ribbers <bribbers@disroot.org>
# Maintainer: Bart Ribbers <bribbers@disroot.org>
pkgname=nymphcast
pkgver=0_git20200310
pkgrel=1
_commit="0b494a446b3c215ca60dafa2678703b3f5f6e392"
arch="all !armv7" # Assembly failure
url="http://nyanko.ws/product_nymphcast.php"
pkgdesc="Audio and video casting system with support for custom applications"
license="BSD-3-Clause"
depends="avahi"
depends_dev="nymphrpc-dev"
makedepends="$depends_dev sdl2-dev sdl2_image-dev ffmpeg-dev openssl-dev"
source="$pkgname-$_commit.tar.gz::https://github.com/MayaPosch/NymphCast/archive/$_commit.tar.gz
	nymphcast.initd
	"
subpackages="$pkgname-server $pkgname-server-openrc $pkgname-dev"
options="!check" # No tests
builddir="$srcdir/NymphCast-$_commit"

build() {
	make -C "$builddir"/src/server
	make -C "$builddir"/src/client_lib
}

package() {
	cd "$builddir"/src/client_lib
	mkdir -p "$pkgdir"/usr/lib
	mv lib/*.so* "$pkgdir"/usr/lib/
	install -Dm644 nymphcast_client.h "$pkgdir"/usr/include/nymphcast_client.h

	install -Dm755 "$srcdir"/nymphcast.initd "$pkgdir"/etc/init.d/nymphcast
}

server() {
	pkgdesc="$pkgdesc (server)"

	cd "$builddir"/src/server

	install -Dm755 bin/nymphcast_server "$subpkgdir"/usr/bin/nymphcast_server
	for i in *.ini; do
		install -Dm644 "$i" "$subpkgdir"/etc/nymphcast/"$i"
	done

	install -d \
		"$subpkgdir"/usr/share/nymphcast
	cp -r apps "$subpkgdir"/usr/share/nymphcast/
	for file in *.jpg; do
		install -Dm644 "$file" "$subpkgdir"/usr/share/nymphcast/wallpapers/$file
	done

	install -Dm644 avahi/nymphcast.service "$subpkgdir"/etc/avahi/services/nymphcast.service
}

sha512sums="14d79b6b34e3e05fc6ec56a2f8a8f0601be6342baa645062e663e0e6d115b1895f342ed3ceee2157339e95ce78e3de13156585ba77635e91fde09f90b032845b  nymphcast-0b494a446b3c215ca60dafa2678703b3f5f6e392.tar.gz
1ab3f0dad11bca5790a2a637bc624c6b80990d09990a9f5ef3a4537c9c04abf40924633c571ffa86758886d5f21253bb5d0369b17b01f90dcc39b3e609caa405  nymphcast.initd"
