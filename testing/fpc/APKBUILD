# Contributor: Leo <thinkabit.ukim@gmail.com>
# Maintainer: Leo <thinkabit.ukim@gmail.com>
pkgname=fpc
pkgver=3.2.0
pkgrel=0
pkgdesc="Free Pascal Compiler"
url="http://freepascal.org"
arch="x86_64"
license="GPL-2.0-or-later AND LGPL-2.1-or-later"
makedepends="ncurses-dev zlib-dev expat-dev rpm2cpio libarchive-tools"
subpackages="$pkgname-doc"
source="
	fpcbuild-$pkgver.tar.gz::https://downloads.sourceforge.net/sourceforge/freepascal/fpcbuild-$pkgver.tar.gz
	fpc-$pkgver.rpm::https://downloads.sourceforge.net/sourceforge/freepascal/Linux/$pkgver/fpc-$pkgver-1.x86_64.rpm
	"
builddir="$srcdir/fpcbuild-$pkgver"

prepare() {
	default_prepare

	# Extract a working version of fpc into $builddir/rpm to compile fpc itself
	mkdir -p "$builddir"/rpm
	cd "$builddir"/rpm
	rpm2cpio "$srcdir/fpc-$pkgver.rpm" | bsdtar -xf -

	# Overwite the symlink from the rpm package with a relative symlink
	# that allows us to execute without having to install to /usr/lib64
	ln -sf ../lib64/fpc/$pkgver/ppcx64 usr/bin

	sed -i s,/lib64/ld-linux-x86-64.so.2,/lib/ld-musl-x86_64.so.1, \
		$builddir/fpcsrc/compiler/systems/t_linux.pas
}

build() {
	cd fpcsrc/compiler
	$builddir/rpm/usr/bin/fpcmake -Tall
	cd ../
	FPC=$builddir/rpm/usr/bin/fpc make build NOGDB=1
}

package() {
	FPC="$builddir"/rpm/usr/bin/fpc make install \
		NOGDB=1 \
		PREFIX="$pkgdir"/usr \
		INSTALL_MANDIR="$pkgdir"/usr/share/man

	# Create the same symlinkk we dealt with in the above
	ln -s /usr/lib/fpc/$pkgver/ppcx64 "$pkgdir"/usr/bin

	# Install configuration
	mkdir -p "$pkgdir"/etc
	"$pkgdir"/usr/lib/fpc/$pkgver/samplecfg "$pkgdir"/usr/lib/fpc/$pkgver "$pkgdir"/etc

	find "$pkgdir"/etc/ -type f -exec sed -i "s|"$pkgdir"||g" {} \;
}


sha512sums="a584f0bc908b380cb3da6bc624ba5de7de803a79dfec33c03f10b468939d4f0d5d7d9ad85ce65e49babd7437e8dba920cb62ac694a4449fc9151ef8ce8e68252  fpcbuild-3.2.0.tar.gz
2b76034533c0dd81f3f75558b0375afd68870f919b3488636bbfccb2c3cf92bf1ddc2178e608d32184e684b7a53f101cf4f289041f7db36419ada5f6cb42f13c  fpc-3.2.0.rpm"
