# Contributor: Carlo Landmeter <clandmeter@gmail.com>
# Contributor: Francesco Colista <fcolista@alpinelinux.org>
# Maintainer: Leonardo Arena <larena@alpinelinux.org>
pkgname=incus
pkgver=0.5.1
pkgrel=2
pkgdesc="Powerful system container and virtual machine manager"
url="https://github.com/lxc/incus"
arch="all"
license="Apache-2.0"
depends="acl
	attr
	ca-certificates
	cgmanager
	dbus
	dnsmasq
	lxc
	iproute2
	iptables
	netcat-openbsd
	nftables
	rsync
	squashfs-tools
	shadow-uidmap
	tar
	xz
	"
makedepends="acl-dev
	autoconf
	automake
	cowsql-dev
	raft-cowsql-dev
	eudev-dev
	gettext-dev
	go
	intltool
	libcap-dev
	libtool
	libuv-dev
	linux-headers
	lxc-dev
	lz4-dev
	sqlite-dev
	tcl-dev
	"
subpackages="$pkgname-client
	$pkgname-agent
	$pkgname-user
	$pkgname-openrc
	$pkgname-utils
	$pkgname-bash-completion:bashcomp:noarch
	$pkgname-vm:vm:noarch
	"
install="$pkgname.pre-install"
options="!check" # FIXME: several tests failing
source="$pkgname-$pkgver.tar.gz::https://github.com/lxc/incus/archive/refs/tags/v$pkgver.tar.gz
	incusd.confd
	incusd.initd
	$pkgname-agent.initd
	$pkgname-user.initd
	"

_tools="fuidshift
	generate
	incus
	incus-benchmark
	incus-migrate
	lxc-to-incus
	lxd-to-incus
	sysinfo
	"
_project="github.com/lxc/incus"

export GOFLAGS="$GOFLAGS -tags=libsqlite3"
export GOCACHE="${GOCACHE:-"$srcdir/go-cache"}"
export GOTMPDIR="${GOTMPDIR:-"$srcdir"}"
export GOMODCACHE="${GOMODCACHE:-"$srcdir/go"}"
export GOPATH="$srcdir"

build() {
	export CGO_CFLAGS="-I/usr/include/raft -I/usr/include/cowsql"
	export CGO_LDFLAGS="$LDFLAGS -lintl"
	export CGO_LDFLAGS_ALLOW="(-Wl,-wrap,pthread_create)|(-Wl,-z,now)"

	make
}

package() {
	for daemon in incusd incus-agent incus-user; do
		install -Dm755 "$srcdir"/bin/$daemon "$pkgdir"/usr/sbin/$daemon
	done

	for tool in $_tools; do
		install -Dm755 "$srcdir"/bin/$tool "$pkgdir"/usr/bin/$tool
	done

	for init in incusd incus-agent incus-user; do
		install -Dm755 "$srcdir"/$init.initd \
		"$pkgdir"/etc/init.d/$init
	done
	install -Dm644 "$srcdir"/incusd.confd \
		"$pkgdir"/etc/conf.d/incusd

	install -Dm644 "$builddir"/scripts/bash/incus \
		"$pkgdir"/usr/share/bash-completion/completions/incus-client

	install -Dm755 "$builddir"/scripts/empty-incus.sh \
		"$pkgdir"/usr/bin/empty-incus.sh
}

agent() {
	pkgdesc="Incus agent"
	install -d "$subpkgdir"/usr/bin "$subpkgdir"/etc/init.d
	amove usr/sbin/incus-agent
	amove etc/init.d/incus-agent
}

client() {
	pkgdesc="Incus CLI client"
	install -d "$subpkgdir"/usr/bin
	amove usr/bin/incus
}

user() {
	pkgdesc="Incus user project daemon"
	install -d "$subpkgdir"/usr/bin "$subpkgdir"/etc/init.d
	amove usr/sbin/incus-user
	amove etc/init.d/incus-user
}

utils() {
	pkgdesc="Incus utilities and scripts"
	depends="$pkgname py3-lxc"

	amove usr/bin
}

vm() {
	pkgdesc="Install packages required to run VMs under LXD"
	depends="qemu-system-x86_64
		qemu-chardev-spice
		qemu-hw-usb-redirect
		qemu-hw-display-virtio-vga
		qemu-img
		qemu-ui-spice-core
		lxd-scripts
		ovmf
		sgdisk
		util-linux-misc
		virtiofsd
		"
	install -d "$subpkgdir"
}

openrc() {
	provides=$pkgname-lts-openrc=$pkgver-r$pkgrel
	default_openrc
}

check() {
	LXD_OFFLINE=true make check
}

sha512sums="
4305d56c2c2b103b7608aa3aa2175f184a3d77b9d19f4c896d4ae27b9d27e64c253645ccb8e6809bab802887771e30b916b1a00171e9c69284919d868409b727  incus-0.5.1.tar.gz
09057320fe4e84f1a2adb9b1dbe39d86be74d9b705827faf2b1c47cffeecb551babfc086d6b1bb1702950067852e4a7139b87413b0fa94edc0fbac42d1d898df  incusd.confd
bd33768c461aa9d38afd4f18eac4c67e61bb41f7b53f5dad42246d1ca38c4481dc534eb5a4fca8ae6c3a6ac5e4e8b092a38bd147a6db169b40d1fdf33327de9d  incusd.initd
4c3668e7b31d0d85fb6a268d8a09a00eb22233aa9da897835e45fd61d79d22c6dec930865599ef1bcf3179eb68db554e42037803182eeb4886e86eb1e5cd2dd9  incus-agent.initd
0b2e76c41cfcb130ebd3fc15513b7f4b278acbd529e644d978805e33678195967d73ff4f74211f87ea413796c04c8d38fb6b62ac6e38d99c47a0871b8acf86b6  incus-user.initd
"
