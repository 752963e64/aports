# Contributor: Bart Ribbers <bribbers@disroot.org>
# Maintainer: Bart Ribbers <bribbers@disroot.org>
pkgname=calamares
pkgver=3.2.28.2
pkgrel=0
# ppc64le, s390x, mips, mips64 blocked by qt5-qtwebengine
# armhf blocked by qt5-qtdeclarative
arch="all !ppc64le !s390x !mips !mips64 !armhf"
url="https://calamares.io/"
pkgdesc="Distribution-independent installer framework"
license="GPL-3.0-or-later AND LGPL-2.1-only"
depends="
	ckbcomp
	musl-locales
	os-prober
	python3
	"
depends_dev="
	cmake
	kcoreaddons-dev
	qt5-qttools-dev
	yaml-cpp-dev
	"
makedepends="$depends_dev
	extra-cmake-modules
	kconfig-dev
	kcrash-dev
	ki18n-dev
	kpackage-dev
	kparts-dev
	kpmcore-dev
	kservice-dev
	kwidgetsaddons-dev
	libatasmart-dev
	libpwquality-dev
	plasma-framework-dev
	polkit-qt-1-dev
	qt5-qtbase-dev
	qt5-qtdeclarative-dev
	qt5-qtsvg-dev
	qt5-qtwebengine-dev
	"
# required for several modules
makedepends="$makedepends
	boost-dev
	boost-python3
	parted-dev
	python3-dev
	"
checkdepends="xvfb-run tzdata"
source="https://github.com/calamares/calamares/archive/v$pkgver/calamares-$pkgver.tar.gz
	alpine-initramfs.patch
	modules-load.conf
	fix-up-arm-detection.patch
	"
subpackages="$pkgname-dev $pkgname-doc $pkgname-lang"

# Modules to build:
# https://github.com/calamares/calamares/tree/master/src/modules
_modules="
	bootloader
	displaymanager
	finished
	fsresizer
	fstab
	grubcfg
	hostinfo
	hwclock
	interactiveterminal
	keyboard
	keyboardq
	locale
	localeq
	luksbootkeyfile
	luksopenswaphookcfg
	machineid
	mkinitfs
	mount
	netinstall
	networkcfg
	notesqml
	oemid
	packagechooser
	packages
	partition
	plasmalnf
	plymouthcfg
	preservefiles
	rawfs
	removeuser
	services-openrc
	shellprocess
	summary	
	umount
	unpackfs
	users
	webview
	welcome
	welcomeq
	"

for i in $_modules; do
	subpackages="$pkgname-mod-$i:_module $subpackages"
done

# Check if $1 is in $_modules
is_module_enabled() {
	local i
	for i in $_modules; do
		[ "$i" = "$1" ] && return 0
	done
	return 1
}

prepare() {
	default_prepare

	local i
	cd "$builddir/src/modules"

	# Fill $_skip_modules, list disabled modules
	msg "Disabled modules:"
	for i in *; do
		if ! [ -d "$i" ] || is_module_enabled "$i"; then
			continue
		fi
		_skip_modules="$_skip_modules $i"
		echo " - $i"
	done

	# List enabled modules
	msg "Enabled modules:"
	for i in $_modules; do
		echo " - $i"
	done	
}

build() {
	cmake -B build \
		-DCMAKE_BUILD_TYPE=None \
		-DCMAKE_INSTALL_PREFIX=/usr \
		-DCMAKE_INSTALL_LIBDIR=lib \
		-DINSTALL_CONFIG=ON \
		-DSKIP_MODULES="$_skip_modules"
	cmake --build build
}

check() {
	cd build
	# libcalamaresnetworktest requires network access
	CTEST_OUTPUT_ON_FAILURE=TRUE xvfb-run ctest -E "libcalamaresnetworktest"
}

_module() {
	local module=${subpkgname##calamares-mod-}
	local path="usr/lib/calamares/modules"

	mkdir -p "$subpkgdir/$path"
	mv "$pkgdir/$path/$module" "$subpkgdir/$path/$module"

	# Module-specific dependencies
	case "$module" in
		unpackfs)
			depends="$depends rsync"
			install="$install $subpkgname.post-install"
			install -Dm644 "$srcdir"/modules-load.conf \
				"$subpkgdir"/usr/lib/modules-load.d/calamares.conf
			;;
		mkinitfs) depends="$depends mkinitfs" ;;
		locale) depends="$depends tzdata" ;;
	esac
}

package() {
	DESTDIR="$pkgdir" cmake --build build --target install	
}

sha512sums="1278143ed29d393a846d5ee11935bfa1788b494320eb5aa20fc44ff3394d4b78b9c44bc4ac321f0d9f19897f2fbf1d1e01f8cc6147a90bf015a131831e727767  calamares-3.2.28.2.tar.gz
b6a632736176cbbe3209ab2b5a94c34c9206bcd072896a5cd74e4f3a8decccc26228d704a72aa3c99677f83c2a3b13b4590ba0a51c29cc26e5a1cd82f33a38b1  alpine-initramfs.patch
c56ad3b92901abdb41cffaeceeff9a6c8dae3882aacf9a4b654a8898f1e26eeadda3ac3ac799b127b176cc31d397652f27a07bcdfbf7f4ede3c6826d08f7bd7d  modules-load.conf
d63a5ccd4e608468f4986d2b7195336eea6ab9f8aa77f40c33519744dff41b0d935be709f24a8e7abb368bbcee8f61d3bdb3873124841072ad72c85101ad532b  fix-up-arm-detection.patch"
