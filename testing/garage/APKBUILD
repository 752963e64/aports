# Contributor: Jakub Jirutka <jakub@jirutka.cz>
# Maintainer: Jakub Jirutka <jakub@jirutka.cz>
pkgname=garage
pkgver=0.7.3
pkgrel=0
pkgdesc="Lightweight S3-compatible distributed object store"
url="https://garagehq.deuxfleurs.fr"
# armhf, armv7: fails to build (std::bad_alloc)
# ppc64le, s390x: fails to build ring crate
# riscv64: would take eternity to build
# x86: LLVM out of memory on CI
arch="all !armhf !armv7 !ppc64le !riscv64 !s390x !x86"
license="AGPL-3.0"
makedepends="
	cargo
	libsodium-dev
	protoc
	zstd-dev
	"
checkdepends="openssl-dev"
pkgusers="garage"
pkggroups="garage"
install="$pkgname.pre-install"
subpackages="$pkgname-openrc"
source="https://github.com/deuxfleurs-org/garage/archive/v$pkgver/garage-$pkgver.tar.gz
	use-system-zstd.patch
	uncolor-log-output.patch
	garage.toml
	$pkgname.initd
	$pkgname.confd
	$pkgname.logrotate
	"

export CARGO_PROFILE_RELEASE_CODEGEN_UNITS=1
export CARGO_PROFILE_RELEASE_DEBUG="false"
export CARGO_PROFILE_RELEASE_LTO="true"
export CARGO_PROFILE_RELEASE_OPT_LEVEL=2
export CARGO_PROFILE_RELEASE_PANIC="abort"

export SODIUM_USE_PKG_CONFIG=1
export GIT_VERSION="v$pkgver"  # version used in --version

prepare() {
	cargo fetch --locked

	default_prepare

	# Don't run k2v tests; k2v is still experimental and not built by
	# default.
	sed -i '/mod k2v/d' src/garage/tests/lib.rs

	cargo fetch  # update after patching Cargo.toml
}

build() {
	cargo build --frozen --release
}

check() {
	cargo test --workspace --frozen
}

package() {
	install -D -m755 target/release/$pkgname -t "$pkgdir"/usr/bin/

	install -D -m755 "$srcdir"/$pkgname.initd "$pkgdir"/etc/init.d/$pkgname
	install -D -m644 "$srcdir"/$pkgname.confd "$pkgdir"/etc/conf.d/$pkgname
	install -D -m640 -o garage -g garage "$srcdir"/garage.toml -t "$pkgdir"/etc/

	install -d -m700 -o garage -g garage "$pkgdir"/var/lib/$pkgname
}

sha512sums="
47f49fab66f5e5bb0bbbffcebc5157727baf155a4be581959213d9521d48bb422af2afd6477e2e0fa41958319a300f884d35a6f0f05dbd54aea135f0f0341c2d  garage-0.7.3.tar.gz
0b1802c3e8964b61fd3f41ee15aa2631c1fcf90d6105ae4c5184c740ce11dd6ed956b1b613b882494e9437077e5bd006f55c643a87dfb89cfdf0ddf58ca28243  use-system-zstd.patch
5cb9a8ce2490bd3974bdeae6aee51feda62953960feba619febbff6cb83b689613a381aeb7260de39f66a7a3fc867440c32e4f8da445aee83938f1b805992e2a  uncolor-log-output.patch
c0717e2737750306e2acdd159f09cb1a83de7ec23b7229711bace6b033e04b5ffd8afea2e98d035eac887d0bfbb8468e4d2f7c07a2275612975f83c42608629a  garage.toml
3d766bbe526714e9607a8906c960330f36711df088366d99706ac3bed8845fa23a5333c3ddf527a4f1ff587a597623d07a8cc32a0b6489908c5319e3ee6340aa  garage.initd
c9e788a4c70f64b2d0487fd0fd60af9a20e48417864e90dd0f0a706333be3dfb78f361a235d05e76f1b89b490b9d0eef4da52c240c4b6965b0534217f416b910  garage.confd
510cb76f7714450311f3dea90d2ca05a54c078f1d184b54e354847c5fb2b82906587044165f3c2470a7913624165918387f104d48ea9a97548597627cf9564e4  garage.logrotate
"
