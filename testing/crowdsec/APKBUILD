# Contributor: Nicolas Lorin <androw95220@gmail.com>
# Maintainer: Nicolas Lorin <androw95220@gmail.com>
pkgname=crowdsec
pkgver=1.4.2
pkgrel=0
pkgdesc="behavior detection engine, coupled with a global IP reputation network"
url="https://crowdsec.net/"
# riscv64: missing yq, binutils-gold
arch="all !riscv64"
license="MIT"
depends="tzdata yq"
makedepends="go jq bash gettext binutils-gold coreutils"
options="!check" # no test suite identified
source="$pkgname-$pkgver.tar.gz::https://github.com/crowdsecurity/crowdsec/archive/refs/tags/v$pkgver.tar.gz"

export GOCACHE="${GOCACHE:-"$srcdir/go-cache"}"
export GOTMPDIR="${GOTMPDIR:-"$srcdir"}"
export GOMODCACHE="${GOMODCACHE:-"$srcdir/go"}"

build() {
	make BUILD_VERSION=v$pkgver build
}

package() {
	mkdir -p $pkgdir/usr/bin/
	install -m 755 -D ./cmd/crowdsec/crowdsec $pkgdir/usr/bin/crowdsec
	install -m 755 -D ./cmd/crowdsec-cli/cscli $pkgdir/usr/bin/cscli

	mkdir -p $pkgdir/var/lib/crowdsec/data/
	touch $pkgdir/var/lib/crowdsec/data/crowdsec.db
	chmod 640 $pkgdir/var/lib/crowdsec/data/crowdsec.db

	mkdir -p $pkgdir/etc/crowdsec/
	mkdir -p $pkgdir/etc/crowdsec/hub/
	mkdir -p $pkgdir/etc/crowdsec/patterns/
	install -m 644 -D ./config/config.yaml $pkgdir/etc/crowdsec/
	install -m 644 -D ./config/dev.yaml $pkgdir/etc/crowdsec/
	install -m 644 -D ./config/user.yaml $pkgdir/etc/crowdsec/
	install -m 644 -D ./config/acquis.yaml $pkgdir/etc/crowdsec/
	install -m 644 -D ./config/profiles.yaml $pkgdir/etc/crowdsec/
	install -m 644 -D ./config/simulation.yaml $pkgdir/etc/crowdsec/
	install -m 640 -D ./config/local_api_credentials.yaml $pkgdir/etc/crowdsec/
	install -m 640 -D ./config/online_api_credentials.yaml $pkgdir/etc/crowdsec/
	install -m 644 -D ./config/patterns/* $pkgdir/etc/crowdsec/patterns/
}

sha512sums="
35e85a1da4a7adf05b669827713b984411e60b2d530bacfd40a2fe4000bdaea5766e87fdeafc474c6c1dae44138b77275844943246d3b5f006b8066bffa3bf10  crowdsec-1.4.2.tar.gz
"
