From fa58b9d538bab5c87fc2040e561b3eca31acbe39 Mon Sep 17 00:00:00 2001
From: Justin Ethier <justin.ethier@gmail.com>
Date: Sun, 8 Aug 2021 21:47:31 -0400
Subject: [PATCH] `fxbit-set?` properly handles negative `i`

---
 srfi/143.sld | 9 +++++++--
 1 file changed, 7 insertions(+), 2 deletions(-)

diff --git a/srfi/143.sld b/srfi/143.sld
index d94a216a..b147e0fa 100644
--- a/srfi/143.sld
+++ b/srfi/143.sld
@@ -50,7 +50,7 @@
     fxarithmetic-shift 
     fxarithmetic-shift-left fxarithmetic-shift-right
     fxbit-count 
-    fxif fxbit-set? fxcopy-bit
+    fxif fxcopy-bit
     fxfirst-set-bit 
     fxbit-field
     mask
@@ -170,7 +170,12 @@
       (fxior (fxand mask n0)
              (fxand (fxnot mask) n1)))
 
-    (define-c fxbit-set?
+    (define (fxbit-set? index i)
+      (or (%fxbit-set? index i)
+          (and (negative? i)
+               (>= index (fxlength i)))))
+
+    (define-c %fxbit-set?
        "(void* data, int argc, closure _, object k, object index, object i)"
        " Cyc_check_fixnum(data, index);
          Cyc_check_fixnum(data, i);
