# Contributor: Jakub Jirutka <jakub@jirutka.cz>
# Maintainer: Jakub Jirutka <jakub@jirutka.cz>
pkgname=rezolus
pkgver=2.11.1
pkgrel=0
pkgdesc="Systems performance telemetry"
url="https://github.com/twitter/rezolus/"
arch="x86_64 x86 armv7 armhf aarch64 ppc64le"  # limited by rust/cargo
license="Apache-2.0"
makedepends="cargo openssl-dev"
install="$pkgname.pre-install"
subpackages="$pkgname-openrc $pkgname-doc"
source="https://github.com/twitter/rezolus/archive/v$pkgver/rezolus-$pkgver.tar.gz
	minimize-size.patch
	remove-ntp-sampler.patch
	remove-http-sampler.patch
	config.toml
	$pkgname.initd
	$pkgname.confd
	$pkgname.logrotate
	"

build() {
	cargo build --release --locked
}

check() {
	cargo test --release --locked
}

package() {
	cargo install --locked --path . --root="$pkgdir/usr"
	rm "$pkgdir"/usr/.crates*

	install -Dm 644 "$srcdir"/config.toml "$pkgdir"/etc/rezolus.toml

	install -Dm 755 "$srcdir"/$pkgname.initd "$pkgdir"/etc/init.d/$pkgname
	install -Dm 644 "$srcdir"/$pkgname.confd "$pkgdir"/etc/conf.d/$pkgname
	install -Dm 644 "$srcdir"/$pkgname.logrotate "$pkgdir"/etc/logrotate.d/$pkgname

	install -Dm 644 configs/example.toml "$pkgdir"/usr/share/doc/$pkgname/full-config.toml
}

sha512sums="8ffe293cb197e0b2a6f5ba4bf7bdf7f77528f30785e64e15774241279309e881a6898b8f1bae7b6bfdc2f7dcd3e54793b249673aa0e25bcdbdb50f100fa3864d  rezolus-2.11.1.tar.gz
952e03a6b41fc57727099c9a913632f967f7355d89cf0553c36ea9f959bcc934bcc1daba6d8dd22e9a40b95e6a1ca62f41f61f724b3399b9b78022565ea015e6  minimize-size.patch
6c93aaa6e68d0e6dc8cf904efa1a40bb3c4d9ea73ce4ce13640058d78104679dda9f5c5b89e95b8ad149d997f420e785b3085b3fa9317e4152ef7d6dadc39d1e  remove-ntp-sampler.patch
bfc805dd2cf268549d8d9f3c98dd6a66152f6088eabcdcee5afabaa0dc03743b1dd936f97f6d6b36f8da081cd8915191156ca0b20ba2d92c3b6742cfd02cdfb1  remove-http-sampler.patch
35b883ab2c01a00019064cb7cb9ca28ddf469175f46e8cba15b62eef5519979fd63d2b180a50fad896de07ebeb6172f76c7d61d4e8ae2ce72c06b34d7462ac38  config.toml
17ba0039a84287a2183f398756cac0cb43f0de2ac95911fa41fcd5bb7b3f411aa8a174632ffa4a519fabd4edd25d69fa2ffa52711fcf0c32c0e1e55eb4828e7b  rezolus.initd
cbc3600b6a01142acb0f4f47a07ee1ad94222f3bd4106e2e29d7cb5edf23bfc54b40fd5d0ab616d0a22a9bca7a10dd1832f23589daeee195a628d25f0a0d21d3  rezolus.confd
248f447686af4b69ebfc1558029babc2aab83cdf50b0cc22c1306549c37f7448a5ed4ebd0cc216f17701b93ea37655e856360e428c7c84eec5d2a64ca3fe178e  rezolus.logrotate"
