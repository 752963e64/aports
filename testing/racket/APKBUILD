# Contributor: Jakub Jirutka <jakub@jirutka.cz>
# Maintainer: Jakub Jirutka <jakub@jirutka.cz>
#
# TODO: Separate packages into subpackages?
# TODO: Install even packages from the full tarball?
# TODO: Figure out how to run tests.
pkgname=racket
pkgver=8.1
pkgrel=0
pkgdesc="A general purpose programming language in the Lisp-Scheme family"
url="https://racket-lang.org/"
# Racket BC does not seem to support riscv64.
arch="all !riscv64"
license="LGPL-3.0-or-later MIT"
depends="ca-certificates libcrypto1.1 libssl1.1"
makedepends="chrpath libffi-dev libucontext-dev"
subpackages="$pkgname-dev $pkgname-doc"
source="https://download.racket-lang.org/releases/$pkgver/installers/racket-minimal-$pkgver-src.tgz"
builddir="$srcdir/$pkgname-$pkgver/src"

# XXX: Uses a bundled version of chez-scheme would be
# preferable to use our packaged chez version instead.

build() {
	export CFLAGS="$CFLAGS -D_GNU_SOURCE"
	export LDFLAGS="$LDFLAGS -lucontext"

	./configure \
		--build=$CBUILD \
		--host=$CHOST \
		--target=$CTARGET \
		--prefix=/usr \
		--sysconfdir=/etc \
		--enable-shared \
		--enable-csonly \
		--disable-docs
	make
}

package() {
	make install DESTDIR="$pkgdir"

	cd "$pkgdir"

	# Remove redundant RPATH.
	chrpath -d usr/bin/racket usr/lib/racket/gracket

	rm -Rf usr/share/applications
}

sha512sums="
446ee8796104e9b4d75040695872dc3753d0701cfbbaff3c2b61521ca495b1eab84e1f95f9ab07c300b75e7507d276d5a08352cc00bc638adc2462dfe47e31fd  racket-minimal-8.1-src.tgz
"
