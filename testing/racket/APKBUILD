# Contributor: Jakub Jirutka <jakub@jirutka.cz>
# Maintainer: Jakub Jirutka <jakub@jirutka.cz>
#
# TODO: Separate packages into subpackages?
# TODO: Install even packages from the full tarball?
# TODO: Figure out how to run tests.
pkgname=racket
pkgver=8.7
pkgrel=0
pkgdesc="A general purpose programming language in the Lisp-Scheme family"
url="https://racket-lang.org/"
# riscv64: Racket BC does not seem to support this arch
arch="all !riscv64"
license="LGPL-3.0-or-later MIT"
depends="
	ca-certificates
	libcrypto3
	libssl3
	"
makedepends="
	chrpath
	libffi-dev
	libucontext-dev
	"
subpackages="$pkgname-dev $pkgname-doc"
source="https://download.racket-lang.org/releases/$pkgver/installers/racket-minimal-$pkgver-src.tgz"
builddir="$srcdir/$pkgname-$pkgver/src"

# XXX: Racket CS (which is the default nowadays) uses
# a bundled version of chez-scheme. However, without
# our patches applied in only works on x86_64. For this
# reason, we use Racket BC for now.

prepare() {
	default_prepare
	# Remove bundled libffi to be sure that system-provided is used.
	rm -Rf bc/foreign/libffi
}

build() {
	export CFLAGS="${CFLAGS/-Os/-O2} -D_GNU_SOURCE"
	export CPPFLAGS="${CPPFLAGS/-Os/-O2}"
	export CXXFLAGS="${CXXFLAGS/-Os/-O2}"
	export LDFLAGS="$LDFLAGS -lucontext"
	./configure \
		--build=$CBUILD \
		--host=$CHOST \
		--target=$CTARGET \
		--prefix=/usr \
		--sysconfdir=/etc \
		--enable-shared \
		--disable-docs \
		--enable-sharezo \
		--enable-bc
	make bc
}

package() {
	make install-bc DESTDIR="$pkgdir"

	# Remove redundant RPATH.
	chrpath -d "$pkgdir"/usr/bin/racketbc "$pkgdir"/usr/lib/racket/gracketbc
	ln -sf /usr/bin/racketbc "$pkgdir"/usr/bin/racket
	ln -sf /usr/bin/racobc "$pkgdir"/usr/bin/raco

	rm -Rf "$pkgdir"/usr/share/applications
}

sha512sums="
3b59e17c4557d2b8bd4a86c3d78c461e1059408b6a50dcf4419d03376d5a91df2166875e996199066cd551a6a66214ef1548988d3a561eaf3a63aaf0ca45775c  racket-minimal-8.7-src.tgz
"
