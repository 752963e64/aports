# Contributor: wener <wenermail@gmail.com>
# Maintainer: wener <wenermail@gmail.com>
pkgname=postgresql-timescaledb
_projname=timescaledb
pkgver=2.1.0
pkgrel=0
pkgdesc="An open-source database designed to make SQL scalable for time-series data"
url="https://github.com/timescale/timescaledb"
arch="all"
license="Apache-2.0"
provides="timescaledb=$pkgver-r$pkgrel"  # for backward compatibility
makedepends="postgresql-dev cmake bash"
source="https://github.com/timescale/timescaledb/archive/$pkgver/$pkgname-$pkgver.tar.gz"
builddir="$srcdir/$_projname-$pkgver"
options="!check"  # FIXME: see comment on REGRESS_CHECKS=OFF below

export USE_PGXS=1

build() {
	# CFLAGS - performance is more important than binary size in this case
	# REGRESS_CHECKS=OFF - disable regress test
	#   regress need https://github.com/timescale/timescaledb/blob/master/test/pg_isolation_regress.sh
	#   which need to compile pg - https://github.com/timescale/timescaledb/issues/1655#issuecomment-578683986
	cmake -B build . \
		-DCMAKE_BUILD_TYPE=None \
		-DCMAKE_INSTALL_PREFIX=/usr \
		-DCMAKE_C_FLAGS="${CFLAGS/-Os/-O2} -DNDEBUG" \
		-DCMAKE_VERBOSE_MAKEFILE=ON \
		-DREGRESS_CHECKS=OFF
	make -C build
}

check() {
	make -C build test
}

package() {
	make -C build install DESTDIR="$pkgdir"
}

sha512sums="53fddb9fe4c4ab51ebc020e90eea5b032b41259d3bd45e8a03a86451acd7f8864b5a6ecba1b82b7c78e230f62cfddf1da75ff27e6629ad5fe8178839ac411ce4  postgresql-timescaledb-2.1.0.tar.gz"
