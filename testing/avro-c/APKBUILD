# Contributor: nu <llnu@protonmail.ch>
# Maintainer: nu <llnu@protonmail.ch>
pkgname=avro
pkgver=1.11.1
pkgrel=0
pkgdesc="Avro, a data serialization system"
url="https://avro.apache.org/docs/current/api/c/index.html"
arch="all"
depends_dev="snappy-dev"
makedepends="
	$depends_dev
	cmake
	jansson-dev
	samurai
	xz-dev
	zlib-dev
	"
license="Apache-2.0"
subpackages="$pkgname-static $pkgname-c-dev:cdev $pkgname-c-libs:clibs"
source="https://archive.apache.org/dist/avro/avro-$pkgver/avro-src-$pkgver.tar.gz
	pkgconf.patch
	version-bash.patch
	"
builddir="$srcdir"/avro-src-$pkgver/lang
options="!check" # needs valgrind

build() {
	export CFLAGS="$CFLAGS -O2 -flto=auto"
	export CXXFLAGS="$CXXFLAGS -O2 -flto=auto"
	cmake -B build -G Ninja -S c \
		-DCMAKE_INSTALL_PREFIX=/usr \
		-DCMAKE_BUILD_TYPE=None \
		-DTHREADSAFE=ON
	cmake --build build
}

check() {
	ctest --test-dir build --output-on-failure
}

package() {
	DESTDIR="$pkgdir" cmake --install build
}

