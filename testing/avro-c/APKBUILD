# Contributor: nu <llnu@protonmail.ch>
# Maintainer: nu <llnu@protonmail.ch>
pkgname=avro-c
pkgver=1.11.1
pkgrel=0
pkgdesc="The C implementation of Avro, a data serialization system."
url="https://avro.apache.org/docs/current/api/c/index.html"
arch="all"
depends_dev="snappy-dev"
makedepends="
	$depends_dev
	cmake
	jansson-dev
	samurai
	xz-dev
	zlib-dev
	"
license="Apache-2.0"
subpackages="$pkgname-static $pkgname-dev $pkgname-libs"
source="https://archive.apache.org/dist/avro/avro-$pkgver/avro-src-$pkgver.tar.gz
	pkgconf.patch
	version-bash.patch
	"
builddir="$srcdir"/avro-src-$pkgver/lang/c
options="!check" # needs valgrind

build() {
	CFLAGS="$CFLAGS -O2 -flto=auto" \
	cmake -B build -G Ninja \
		-DCMAKE_INSTALL_PREFIX=/usr \
		-DCMAKE_BUILD_TYPE=None \
		-DTHREADSAFE=ON
	cmake --build build
}

check() {
	ctest --test-dir build --output-on-failure
}

package() {
	DESTDIR="$pkgdir" cmake --install build
}

sha512sums="
721a94cd148067282636ba9784088dc9d43f26165d66b065e365eec420ba7cd108df9c0b0ac29beef3c37ac0034f356158769b4a7a3c4c0b1634b893e2dd2bb8  avro-src-1.11.1.tar.gz
5ad9692ecf0e0222da4c42151202d56bf6a087c4e002f39501cdb6074ad68a9cb6d7c67911d42770f8b462e9e248e3d848b8223a46f15bcb3a0c6e636d349175  pkgconf.patch
7ddee2b0c206088e272373c069eff0c3b4bb7bf42837dbc048be3aa14330d09aacba299e893a8735bd821419b8ad0c52497b968d191a3b58a8ec941d1fc3ef78  version-bash.patch
"
