# Contributor: Jakub Jirutka <jakub@jirutka.cz>
# Maintainer:

# jool version
# when changing _ver we *must* bump _rel!
_ver=4.0.6
_rel=2

# kernel verson
_kver=4.19.80
_krel=0
_kpkgver="$_kver-r$_krel"

pkgname=jool
pkgver=$_kver
pkgrel=$(( $_krel + $_rel ))
pkgdesc="SIIT and NAT64 for Linux (virtual package for kernel modules)"
url="https://jool.mx"
arch="all"
license="GPL-2.0-or-later"
makedepends="linux-headers"
install_if="jool-tools $pkgname=$pkgver-r$pkgrel"
subpackages=""
source="https://github.com/NICMx/Jool/releases/download/v$_ver/$pkgname-$_ver.tar.gz"
builddir="$srcdir/$pkgname-$_ver"
options="!check"

# for custom kernels set $FLAVOR
_flavors="$FLAVOR"
if [ -z "$_flavors" ]; then
	_flavors="vanilla"
	case $CARCH in
		x86 | x86_64) _flavors="$_flavors virt";;
	esac
fi

for _f in $_flavors; do
	makedepends="$makedepends linux-$_f-dev=$_kpkgver"
	subpackages="$subpackages $pkgname-$_f:_module"
done

prepare() {
	default_prepare

	if [ -z "$FLAVOR" ]; then
		(	. "$startdir"/../../main/linux-${_flavors%% *}/APKBUILD
			[ "$_kver" != "$pkgver" ] && die "please update _kver to $pkgver"
			[ "$_krel" != "$pkgrel" ] && die "please update _krel to $pkgrel"
			return 0
		)
	fi

	local flavor; for flavor in $_flavors; do
		cp -r "$builddir" "$srcdir"/$flavor
	done
}

build() {
	unset LDFLAGS

	local flavor; for flavor in $_flavors; do
		make -C "$srcdir"/"$flavor"/src/mod \
			MODULES_DIR="/lib/modules/$_kver-$_krel-$flavor"
	done
}

package() {
	mkdir -p "$pkgdir"
}

_module() {
	local flavor=${subpkgname##*-}
	depends="linux-$flavor=$_kpkgver"
	install_if="$pkgname=$pkgver-$pkgrel linux-$flavor=$_kpkgver"
	pkgdesc="SIIT and NAT64 for Linux (kernel modules for $flavor)"

	make -C "$srcdir"/$flavor/src/mod modules_install \
		MODULES_DIR=/lib/modules/$_kver-$_krel-$flavor \
		INSTALL_MOD_PATH="$subpkgdir"
}

sha512sums="8648cc876d801b34c4bc9616da642727d1e49ed2937daa7fdca58c0fd80dbd1c432018af410c44c1d24224aba5289f726f43adc259cdf8193832d39a86d0f6a6  jool-4.0.6.tar.gz"
