# Contributor: SÃ¶ren Tempel <soeren+alpine@soeren-tempel.net>
# Maintainer:
pkgname=ck
pkgver=0.7.0
pkgrel=0
pkgdesc="Concurrency primitives, safe memory reclamation mechanisms and non-blocking (including lock-free) data structures"
url="http://concurrencykit.org/"
# mips64, riscv64: Architecture not supported by upstream.
arch="all !mips64 !riscv64"
license="BSD-2-Clause AND Apache-2.0"
makedepends="linux-headers"
subpackages="$pkgname-static $pkgname-dev $pkgname-doc"
options="!check" # TODO: pass locally but hang on CI
source="$pkgname-$pkgver.tar.gz::https://github.com/concurrencykit/ck/archive/refs/tags/$pkgver.tar.gz
	gettid.patch"

# GitLab CI runs armhf/armv7 as 32-bit arches on aarch64.
# Thus, we cannot rely on the `uname -m` output on these platforms.
case "$CTARGET_ARCH" in
armhf) export PLATFORM=armv6l ;;
armv7) export PLATFORM=armv7l ;;
esac

build() {
	./configure \
		--build=\$CBUILD \
		--host=\$CHOST \
		--prefix=/usr \
		--sysconfdir=/etc \
		--mandir=/usr/share/man \
		--localstatedir=/var
	make
}

check() {
	make check
}

package() {
	make DESTDIR="$pkgdir" install
}

sha512sums="
509fe5bc1575a6fd646d30fbcd74204ba4683092f154dc1fb55ed6fc17e734e17759bacfc3f42344db4c243ca6b239f7d207cf2ebc609e2a37d7ddfd1bdcc3a1  ck-0.7.0.tar.gz
fe6e25a67025c5f4ef9affbd32cb4fe0c29879af866c2b621be004fbbd3ff8b203f7655aca8943bb8303a318aecd387352256b121eab68487fac0a135ad82903  gettid.patch
"
