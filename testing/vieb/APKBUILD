# Contributor: Grigory Kirillov <txgk@bk.ru>
# Maintainer: Grigory Kirillov <txgk@bk.ru>
pkgname=vieb
pkgver=9.0.0
pkgrel=0
pkgdesc="Vim Inspired Electron Browser"
url="https://vieb.dev"
arch="aarch64 x86_64" # same as electron
license="GPL-3.0-or-later"
options="!check" # there is no test suite
subpackages="$pkgname-lite:_lite"
replaces="vieb-lite"
depends="electron"
makedepends="npm"
source="https://github.com/Jelmerro/Vieb/archive/$pkgver/vieb-$pkgver.tar.gz
	package.json
	vieb
	vieb.desktop"
builddir="$srcdir/Vieb-$pkgver"

# Masks to delete unneeded files to reduce resources size.
_junk_masks="
	*.test.js
	*.test.js.map
	*.debug.js
	*.d.ts
	*.d.ts.map
	*.tsbuildinfo
	readme*
	changelog*
	changes*
	contributing*
	example*
	test*
	.github
	"

build() {
	npm ci --omit=dev

	# We'll install icons to system directory later.
	mv app/img/icons .

	# This is Windows-specific.
	rm -r app/defaultapp

	# Avoid installing project dependencies again.
	rm package.json package-lock.json

	# Remove waste files.
	for mask in $_junk_masks; do
		find node_modules -iname "$mask" -print0 | xargs -0 rm -vrf
	done

	mkdir vieb
	mv app node_modules vieb
	sed "s/PKGVER/$pkgver/" "$srcdir"/../package.json > vieb/package.json

	npm install --no-save asar

	## Pack full version.
	npx asar pack vieb full.asar

	## Pack lite version.
	rm -rf vieb/node_modules
	# Add -lite prefix to the package name because Vieb will check it at runtime
	# to toggle some default settings.
	sed -i 's/ieb/ieb-lite/' vieb/package.json
	npx asar pack vieb lite.asar
}

_package_vieb() {
	install -Dm755 "$srcdir"/../vieb -t "$1"/usr/bin
	install -Dm644 "$2" "$1"/usr/lib/vieb/app.asar
	install -Dm644 "$srcdir"/../vieb.desktop -t "$1"/usr/share/applications

	for icon in icons/*; do
		icon_base="$(basename "$icon")"
		icon_res="${icon_base%%.*}"
		icon_ext="${icon_base##*.}"
		install -Dm644 "$icon" "$1"/usr/share/icons/hicolor/"$icon_res"/apps/vieb."$icon_ext"
	done
}

package() {
	_package_vieb "$pkgdir" full.asar
}

_lite() {
	pkgdesc="Vim Inspired Electron Browser without node modules"
	replaces="vieb"
	cd "$builddir"
	_package_vieb "$subpkgdir" lite.asar
}

sha512sums="
556e20cd6ab0719ea7f06293bafc223c87da98de96aad0beac35743ddd857425b2a2f645e28606c0bf924515a20a6c8e9129e9392f3a46a34038683616d12165  vieb-9.0.0.tar.gz
d294a11e468feeb67d61604c81b3000fa50a87d27d9e6c1bda5671d9ba673ee41fdad646970bde2a5a7363bbf13b504521625c9c5334969bfd1679c8a1f119e3  package.json
af1f7d92c78e323f226d65b269ca87cd93316636096c955e5f8b23f0ae66a6ab4a68dd0719fd5f7301fcb60ecf8612a865c761afd822ad5d8e08d7c133b447b2  vieb
e74f91b934a3ae4644ee8c18002662575c55739b57fd980133935cd29d5401303de2b8af00079de517d2e8f3d52e92424aaff6fd89a1cde06b2faf4f1865eb1b  vieb.desktop
"
