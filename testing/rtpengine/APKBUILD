# Maintainer: Leonardo Arena <rnalrd@alpinelinux.org>
pkgname=rtpengine
pkgver=9.0.1.2
pkgrel=0
pkgdesc="Proxy for RTP traffic and other UDP based media traffic"
url="https://github.com/sipwise/rtpengine"
arch="all"
license="GPL-3.0-only"
makedepends="
	curl-dev
	ffmpeg-dev
	gperf
	glib-dev
	hiredis-dev
	iptables-dev
	json-glib-dev
	libevent-dev
	libpcap-dev
	mariadb-dev
	openssl-dev
	pcre-dev
	perl
	spandsp-dev
	xmlrpc-c-dev
	zlib-dev
	"
# checkdepends="perl-bencode perl-net-interface perl-socket6"
install="$pkgname.pre-install"
subpackages="$pkgname-doc $pkgname-openrc $pkgname-recording"
pkgusers="rtpengine"
pkggroups="rtpengine"
source="$pkgname-$pkgver.tar.gz::https://github.com/sipwise/rtpengine/archive/mr$pkgver.tar.gz
	$pkgname.initd

	disable-O3.patch
	fix-default-config.patch
	"
builddir="$srcdir"/$pkgname-mr$pkgver

build() {
	make
}

# TODO: There's a real test suite available,
# but some needed packages are missing
check() {
	./daemon/rtpengine --version
	# make check
}

package() {
	install -Dm644 LICENSE "$pkgdir"/usr/share/doc/$pkgname/LICENSE

	install -Dm755 daemon/rtpengine "$pkgdir"/usr/bin/rtpengine
	install -Dm644 etc/${pkgname}.sample.conf "$pkgdir"/etc/rtpengine/rtpengine.conf
	install -Dm755 "$srcdir"/${pkgname}.initd "$pkgdir"/etc/init.d/$pkgname
	ln -s rtpengine "$pkgdir"/etc/init.d/${pkgname}-recording

	install -d "$pkgdir"/usr/share/man/man1
	gzip -c daemon/rtpengine.8 > "$pkgdir"/usr/share/man/man1/rtpengine.1.gz
	gzip -c recording-daemon/rtpengine-recording.8 \
		> "$pkgdir"/usr/share/man/man1/rtpengine-recording.1.gz

	install -Dm755 iptables-extension/libxt_RTPENGINE.so \
		"$pkgdir"/usr/lib/xtables/libxt_RTPENGINE.so
}

recording() {
	depends="$pkgname"

	install -Dm755 "$builddir"/recording-daemon/rtpengine-recording \
		"$subpkgdir"/usr/bin/rtpengine-recording
	install -Dm644 "$builddir"/etc/rtpengine-recording.sample.conf \
		"$subpkgdir"/etc/$pkgname/rtpengine-recording.conf

	local dir
	for dir in lib spool; do
		install -d -o rtpengine -g rtpengine "$subpkgdir"/var/$dir/$pkgname
	done
}

sha512sums="3810e76e9a25a468e85d57a23b158023c2e1ec80bb2a2b9c4834a9306a295d7b04df7bdd16ecd256c5a005361dd55830115a709d5371ecd8a28f53de759a28a8  rtpengine-9.0.1.2.tar.gz
0bc1c411d20b1c881a2ffcd60b09ec09d348708f7eb3f8f43e14e96eb39620adff66d734737893a8b9b255808faf3c1138b6d46fb888117e47712990e0e7c1d0  rtpengine.initd
9e59d1e1507abc139c016d218e496919bc7053d143b3220753fe7a7b350bbf74facc2f43cbaf8f0b47984608a1fead7171270b0c06d2c866e5b21cf2a94da81d  disable-O3.patch
a86f896955cb06252c81abaffd362f999a0a4f38dbafb34739015f787bbd966adba1e4e3232edf562a38415a4f69c4b21d62745cb7ef8e730d0259f098765685  fix-default-config.patch"
