From 294adeed1fee1c337358cf06286a5833d561a06e Mon Sep 17 00:00:00 2001
From: Natanael Copa <ncopa@alpinelinux.org>
Date: Mon, 8 May 2023 17:31:08 +0200
Subject: [PATCH 3/5] alpine-config: add user-data ntp

This needs to happen early so time is right for https later
---
 lib/tiny-cloud/common                  | 12 +++++++
 lib/tiny-cloud/user-data/alpine-config | 33 +++++++++++++++++
 tests/tiny-cloud-alpine.test           | 50 ++++++++++++++++++++++++++
 3 files changed, 95 insertions(+)
 create mode 100644 lib/tiny-cloud/user-data/alpine-config

diff --git a/lib/tiny-cloud/common b/lib/tiny-cloud/common
index 74f3460..ce0dd1a 100644
--- a/lib/tiny-cloud/common
+++ b/lib/tiny-cloud/common
@@ -43,6 +43,18 @@ replace_word() {
     done
 }
 
+# usage: insert_after <where> <what> <list>...
+insert_after() {
+    local search="$1" addition="$2"
+    shift 2
+    for i in "$@"; do
+        echo "$i"
+        if [ "$i" = "$search" ]; then
+            echo "$addition"
+        fi
+    done
+}
+
 # usage: add_once <file> <line-to-add>...
 add_once() {
     local file="$1"
diff --git a/lib/tiny-cloud/user-data/alpine-config b/lib/tiny-cloud/user-data/alpine-config
new file mode 100644
index 0000000..4dd1134
--- /dev/null
+++ b/lib/tiny-cloud/user-data/alpine-config
@@ -0,0 +1,33 @@
+# Script UserData Functions
+# vim:set ts=4 et ft=sh:
+
+INIT_ACTIONS_MAIN="$(insert_after set_hostname userdata_ntp $INIT_ACTIONS_MAIN)"
+
+init__userdata_ntp() {
+    local ntp_enabled="$(imds user-data/ntp/enabled)"
+    if [ "$ntp_enabled" != "yes" ] && [ "$ntp_enabled" != "true" ]; then
+        return
+    fi
+    local ntp_client="$(imds user-data/ntp/ntp_client)"
+    local svc= pkg=
+    case "$ntp_client" in
+        busybox)
+            svc=ntpd
+            ;;
+        chrony|"")
+            pkg=chrony
+            svc=chronyd
+            ;;
+        openntpd)
+            pkg=openntpd
+            svc=openntpd
+            ;;
+    esac
+    if [ -n "$pkg" ]; then
+        $MOCK apk add "$pkg"
+    fi
+    if [ -n "$svc" ]; then
+        $MOCK rc-update add "$svc" default
+        $MOCK rc-service "$svc" start
+    fi
+}
diff --git a/tests/tiny-cloud-alpine.test b/tests/tiny-cloud-alpine.test
index fca82ea..43a0161 100755
--- a/tests/tiny-cloud-alpine.test
+++ b/tests/tiny-cloud-alpine.test
@@ -10,6 +10,9 @@ lib="$srcdir"/lib/tiny-cloud/cloud/alpine/init
 init_tests \
 	set_network_config_network_interfaces \
 	set_network_config_auto \
+	userdata_ntp \
+	userdata_ntp_busybox \
+	userdata_ntp_openntpd
 
 set_network_config_network_interfaces_body() {
 	fake_metadata_nocloud <<-EOF
@@ -65,3 +68,50 @@ set_network_config_auto_body() {
 		atf_fail "etc/resolv.conf should not been created with DHCP"
 	fi
 }
+
+userdata_ntp_body() {
+	fake_userdata_nocloud <<-EOF
+		#alpine-config
+		ntp:
+		  enabled: true
+	EOF
+	atf_check -e ignore -o ignore tiny-cloud net
+	atf_check \
+		-e match:"userdata_ntp .*DONE" \
+		-o match:"apk add.*chrony" \
+		-o match:"rc-update .*chronyd" \
+		-o match:"rc-service .*chronyd" \
+		tiny-cloud main
+}
+
+userdata_ntp_busybox_body() {
+	fake_userdata_nocloud <<-EOF
+		#alpine-config
+		ntp:
+		  enabled: true
+		  ntp_client: busybox
+	EOF
+	atf_check -e ignore -o ignore tiny-cloud net
+	atf_check \
+		-e match:"userdata_ntp .*DONE" \
+		-o not-match:"apk add" \
+		-o match:"rc-update .*ntpd" \
+		-o match:"rc-service .*ntpd" \
+		tiny-cloud main
+}
+
+userdata_ntp_openntpd_body() {
+	fake_userdata_nocloud <<-EOF
+		#alpine-config
+		ntp:
+		  enabled: true
+		  ntp_client: openntpd
+	EOF
+	atf_check -e ignore -o ignore tiny-cloud net
+	atf_check \
+		-e match:"userdata_ntp .*DONE" \
+		-o match:"apk add.*openntpd" \
+		-o match:"rc-update .*openntpd" \
+		-o match:"rc-service .*openntpd" \
+		tiny-cloud main
+}
-- 
2.40.1

