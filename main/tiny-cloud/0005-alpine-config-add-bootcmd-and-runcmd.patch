From cdc09de310a4a3b48ce7f28d75f249788d548790 Mon Sep 17 00:00:00 2001
From: Natanael Copa <ncopa@alpinelinux.org>
Date: Mon, 8 May 2023 20:33:17 +0200
Subject: [PATCH 5/5] alpine-config: add bootcmd and runcmd

boocmd runs as early as possible, while runcmd runs late, during final.
---
 lib/tiny-cloud/user-data/alpine-config | 20 +++++++++++++++-
 tests/tiny-cloud-alpine.test           | 33 +++++++++++++++++++++++++-
 2 files changed, 51 insertions(+), 2 deletions(-)

diff --git a/lib/tiny-cloud/user-data/alpine-config b/lib/tiny-cloud/user-data/alpine-config
index dfff109..c04d86e 100644
--- a/lib/tiny-cloud/user-data/alpine-config
+++ b/lib/tiny-cloud/user-data/alpine-config
@@ -2,8 +2,18 @@
 # vim:set ts=4 et ft=sh:
 
 INIT_ACTIONS_MAIN="$(insert_after set_hostname \
-    "userdata_ntp userdata_apk_cache userdata_apk_repositories userdata_packages" \
+    "userdata_bootcmd userdata_ntp userdata_apk_cache userdata_apk_repositories userdata_packages" \
     $INIT_ACTIONS_MAIN)"
+INIT_ACTIONS_FINAL="$INIT_ACTIONS_FINAL userdata_runcmd"
+
+init__userdata_bootcmd() {
+    # run bootcmd
+    local bootcmds="$(imds user-data/bootcmd)"
+    for i in $bootcmds; do
+        local cmd="$(imds user-data/bootcmd/"$i")"
+        sh -c "$cmd"
+    done
+}
 
 init__userdata_ntp() {
     local ntp_enabled="$(imds user-data/ntp/enabled)"
@@ -96,3 +106,11 @@ init__userdata_packages() {
         $MOCK apk add $pkgs
     fi
 }
+
+init__userdata_runcmd() {
+	local runcmds="$(imds user-data/runcmd)"
+	for i in $runcmds; do
+		local cmd="$(imds user-data/runcmd/$i)"
+		sh -c "$cmd"
+	done
+}
diff --git a/tests/tiny-cloud-alpine.test b/tests/tiny-cloud-alpine.test
index 60e5c4a..0229381 100755
--- a/tests/tiny-cloud-alpine.test
+++ b/tests/tiny-cloud-alpine.test
@@ -10,6 +10,7 @@ lib="$srcdir"/lib/tiny-cloud/cloud/alpine/init
 init_tests \
 	set_network_config_network_interfaces \
 	set_network_config_auto \
+	userdata_bootcmd \
 	userdata_ntp \
 	userdata_ntp_busybox \
 	userdata_ntp_openntpd \
@@ -17,7 +18,8 @@ init_tests \
 	userdata_apk_repositories \
 	userdata_apk_repositories_version \
 	userdata_apk_repositories_version_auto_edge \
-	userdata_packages
+	userdata_packages \
+	userdata_runcmd
 
 
 set_network_config_network_interfaces_body() {
@@ -75,6 +77,20 @@ set_network_config_auto_body() {
 	fi
 }
 
+userdata_bootcmd_body() {
+	fake_userdata_nocloud <<-EOF
+		#alpine-config
+		bootcmd:
+		  - echo foo
+		  - echo bar
+	EOF
+	atf_check -e ignore -o ignore tiny-cloud net
+	atf_check \
+		-e match:"userdata_bootcmd .*DONE" \
+		-o match:"^foo$" -o match:"^bar$" \
+		tiny-cloud main
+}
+
 userdata_ntp_body() {
 	fake_userdata_nocloud <<-EOF
 		#alpine-config
@@ -208,3 +224,18 @@ userdata_packages_body() {
 		-o match:"apk add .*vim" \
 		tiny-cloud main
 }
+
+userdata_runcmd_body() {
+	fake_userdata_nocloud <<-EOF
+		#alpine-config
+		runcmd:
+		  - echo foo
+		  - echo bar
+	EOF
+	# run net phase to extract the user data
+	atf_check -e ignore -o ignore tiny-cloud net
+	atf_check \
+		-e match:"userdata_runcmd .*DONE" \
+		-o match:"^foo$" -o match:"^bar$" \
+		tiny-cloud final
+}
-- 
2.40.1

