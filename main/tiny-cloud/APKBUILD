# Contributor: Mike Crute <mike@crute.us>
# Contributor: Jake Buchholz Göktürk <tomalok@gmail.com>
# Maintainer: Jake Buchholz Göktürk <tomalok@gmail.com>
pkgname=tiny-cloud
pkgver=2.1.0_rc5
pkgrel=0
pkgdesc="Tiny Cloud instance bootstrapper"
url="https://gitlab.alpinelinux.org/alpine/cloud/tiny-cloud"
arch="noarch"
license="MIT"
options="!check"  # no tests provided
depends="e2fsprogs-extra partx sfdisk"
source="
	$url/-/archive/$pkgver/$pkgname-$pkgver.tar.gz
	$pkgname-aws.post-install
	$pkgname-azure.post-install
	$pkgname-gcp.post-install
	$pkgname-nocloud.post-install
	$pkgname-oci.post-install
"
subpackages="
	$pkgname-network
	$pkgname-openrc
	$pkgname-aws
	$pkgname-azure
	$pkgname-gcp
	$pkgname-oci
	$pkgname-nocloud
"

package() {
	make PREFIX="$pkgdir" core openrc
}

network() {
	pkgdesc="Tiny Cloud - networking module"
	depends="ifupdown-ng iproute2-minimal $pkgname=$pkgver-r$pkgrel"
	cd "$builddir"
	make PREFIX="$subpkgdir" network
}

aws() {
	pkgdesc="Tiny Cloud - Amazon Web Services module"
	depends="nvme-cli $pkgname-network=$pkgver-r$pkgrel"
	provides="tiny-ec2-bootstrap"
	install="$pkgname-aws.post-install"
	cd "$builddir"
	make PREFIX="$subpkgdir" aws
}

azure() {
	pkgdesc="Tiny Cloud - Azure module"
	depends="$pkgname=$pkgver-r$pkgrel"
	install="$pkgname-azure.post-install"
	cd "$builddir"
	make PREFIX="$subpkgdir" azure
}

gcp() {
	pkgdesc="Tiny Cloud - Google Cloud Platform module"
	depends="$pkgname=$pkgver-r$pkgrel"
	install="$pkgname-gcp.post-install"
	cd "$builddir"
	make PREFIX="$subpkgdir" gcp
}

oci() {
	pkgdesc="Tiny Cloud - Oracle Cloud Infrastructure module"
	depends="$pkgname=$pkgver-r$pkgrel"
	install="$pkgname-oci.post-install"
	cd "$builddir"
	make PREFIX="$subpkgdir" oci
}

nocloud() {
	pkgdesc="Tiny Cloud - NoCloud module"
	depends="$pkgname=$pkgver-r$pkgrel yx"
	install="$pkgname-nocloud.post-install"
	cd "$builddir"
	make PREFIX="$subpkgdir" nocloud
}

sha512sums="
ecb5bf7fb0ec3741a36c0c0d8a3817d4ead57861c606789e6701058e5f03d56468a6f34f94ba674737e5e993187cba0b387fe462af3a588398237fd908a84731  tiny-cloud-2.1.0_rc5.tar.gz
67107514feda55100f68c0e17f29718c1c553819cc5403fa6dde9312109e6d8975930a9a22bc1e87fcf4e10f2f82ffc3849d754e384ec9b046d1a60d470fae05  tiny-cloud-aws.post-install
5b17c4580cf7fb19fab88e1300003cd59eb427fef8bdec37e4745431d9794f1f0b2f36e06ac2241faa93c4b02f554f40095ee92578d602cb5b58300d024b15e4  tiny-cloud-azure.post-install
83521229643527cd569d85973b3758932f4e59e98c5c5a7d22ec062b20bbc40dc3e4d16a9f66b11f78933f9eeff6ae1f494b9d3a15b7b691bf108e6383410a30  tiny-cloud-gcp.post-install
c4456819a9f7efdb4393f364881fa77776d2d1ca918d7c67fbcb0f707916dcf73de2e57ee8b50b4cb5d3423a05a67dbb93f8025cfeb971999176c49f67d694f8  tiny-cloud-nocloud.post-install
71f556c4ad1d1c3479647292214266512c6d646c1e83f601f3464c3ef361368c8d2d192c32a056e8956c9844a16c34417cbd413799142a400065c60c7afd9aec  tiny-cloud-oci.post-install
"
