# Maintainer: Natanael Copa <ncopa@alpinelinux.org>
pkgname=mkinitfs
pkgver=3.6.2
# shellcheck disable=SC2034 # used for git versions, keep around for next time
_ver=${pkgver%_git*}
pkgrel=4
pkgdesc="Tool to generate initramfs images for Alpine"
url="https://gitlab.alpinelinux.org/alpine/mkinitfs"
arch="all"
license="GPL-2.0-only"
# currently we do not ship any testsuite
options="!check"
makedepends_host="busybox kmod-dev util-linux-dev cryptsetup-dev linux-headers"
makedepends="$makedepends_host"
depends="busybox>=1.28.2-r1 apk-tools>=2.9.1 lddtree>=1.25 kmod mdev-conf"
subpackages="$pkgname-doc"
install="$pkgname.pre-upgrade $pkgname.post-install $pkgname.post-upgrade"
triggers="$pkgname.trigger=/usr/share/kernel/*"
source="https://gitlab.alpinelinux.org/alpine/mkinitfs/-/archive/$pkgver/mkinitfs-$pkgver.tar.gz
	$pkgname-copy-modinfo.patch::https://gitlab.alpinelinux.org/alpine/mkinitfs/-/commit/76028dc92b86181202ef2c5302bc04458dd94629.patch
	$pkgname-keyboard-drivers.patch::https://gitlab.alpinelinux.org/alpine/mkinitfs/-/commit/32a4fa18e164a4ac1f4cbbba8644cf74892cc4ba.patch
	$pkgname-features-usb::https://gitlab.alpinelinux.org/alpine/mkinitfs/-/commit/b37d8f38f9d0e04368d0d7f17775c1a5b6b7e655.patch
	"

provides="initramfs-generator"
provider_priority=900 # highest

build() {
	make VERSION=$pkgver-r$pkgrel
}

package() {
	make install DESTDIR="$pkgdir"
}

sha512sums="
c0655535e5f88634ce5be906c4fe55035ae86a1d169ee1539a8a55d795372eac45fe4a0455a8ad3ab07372ac2f816633f8a062fdebfac8e0595a7c0141ccdcec  mkinitfs-3.6.2.tar.gz
708cfa62baf132eae308e30b7334ea2dbbc5cc8101c3b044dc73b384ba911845128783644f8c3cc76c3cbb0dcfec6fd0a187b3cb5fed39bd5eece822e2378833  mkinitfs-copy-modinfo.patch
60d3ed73187a8faeb9d9c920dd6bf610eff0edcd377bd10221f9fce55997bddbfe2c1791939d061ac3099a5b4122bc9b94d08d93f964c1a0ecd7bafb7ecfe0a0  mkinitfs-keyboard-drivers.patch
a9b73524df7c414b2dd172a53f5ac56937d5b81825b390cbde0e0282f71b947ffda0361f592cbae4b5072cbb0489477af1cd252c35f2be3e447d4ac731ba284a  mkinitfs-features-usb
"
