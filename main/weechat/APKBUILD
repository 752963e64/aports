# Contributor: ≈Åukasz Jendrysik <scadu@yandex.com>
# Maintainer: Leonardo Arena <rnalrd@alpinelinux.org>
pkgname=weechat
pkgver=1.6
pkgrel=2
pkgdesc="A fast, light, extensible ncurses-based chat client"
url="http://www.weechat.org"
arch="all"
license="GPL3+"
depends=""
depends_dev="cmake libintl ncurses-dev gnutls-dev libgcrypt-dev curl-dev
             aspell-dev lua-dev perl-dev python2-dev ruby-dev"
makedepends="$depends_dev"
install=""
subpackages="$pkgname-dev $pkgname-aspell:_plugin $pkgname-lua:_plugin
             $pkgname-perl:_plugin $pkgname-python:_plugin $pkgname-ruby:_plugin"
source="http://www.weechat.org/files/src/$pkgname-$pkgver.tar.gz
	CVE-2017-8073.patch
	CVE-2017-14727.patch
	"
_builddir="$srcdir"/$pkgname-$pkgver

# secfixes:
#   1.6.0-r2:
#     - CVE-2017-14727
#   1.6.0-r1:
#     - CVE-2017-8073

prepare() {
	cd "$_builddir"
	default_prepare || return 1
}

build() {
	cd "$_builddir"
	mkdir -p build
	cd build
	cmake .. -DCMAKE_INSTALL_PREFIX=/usr -DENABLE_MAN=ON || return 1
	make || return 1
}

package() {
	cd "$_builddir"/build
	make DESTDIR="$pkgdir/" install || return 1
}

_plugin() {
	local _name=${subpkgname#*-}
	local _dir=usr/lib/weechat/plugins

	pkgdesc="WeeChat $_name plugin"
	depends="weechat"
	if [ "$_name" = python2 ]; then
		depends="$depends python2"
	fi

	mkdir -p "$subpkgdir"/$_dir
	mv "$pkgdir"/$_dir/${_name}.so "$subpkgdir"/$_dir
}

md5sums="281b7ec74be63cfb633f52f1f001aad7  weechat-1.6.tar.gz
f390999b30cb67c85a879aec4d180a64  CVE-2017-8073.patch
b5c4cffdfd2d271e02e32b6f5ace9e2d  CVE-2017-14727.patch"
sha256sums="3061e57460e0e3e4533551c45ced53b222fe0933848250d0fb7337d9aacfd853  weechat-1.6.tar.gz
03c9167feac5c7385aa75e9daac74476a3946755ea5738ca3c0ea4805623cac2  CVE-2017-8073.patch
e5d9ecc7786ea9d90201317bd8a1d2f7d78d4c16f53d83f8bb898a6552915277  CVE-2017-14727.patch"
sha512sums="cb4f701fedd0402c495e793ac2bce07590a986c6576a9274809d76f12495267012f1e61e91eb20fada98f47c12661e3b04dd9e329cd2f1124a5643d76487c391  weechat-1.6.tar.gz
5d4c0cf70ddb7c8f8ca8bbfc55e5c7b3d82be59034fd92a1896880540fcf90c2c9f6683c42b0482904bddfcfae5fa7b2e6239dacb573d77420888ffdda6c9fc7  CVE-2017-8073.patch
5f5ba09465fa252c8222a2597dbb9a99333de5c0b989818e811c263ac80a0acc939188d40e345ef114c33a19a4aa92514fcc04feddb152546e7a1798ced8d233  CVE-2017-14727.patch"
