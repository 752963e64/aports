# Maintainer: kpcyrd <git@rxv.cc>
# Contributor: kpcyrd <git@rxv.cc>
# Contributor: Bart≈Çomiej Piotrowski <bpiotrowski@alpinelinux.org>
pkgname=cjdns
pkgver=21.2
pkgrel=0
pkgdesc="A routing engine designed for security, scalability, speed and ease of use"
url="https://github.com/cjdelisle/cjdns"
arch="all !s390x !ppc64le !riscv64"
license="GPL-3.0-or-later"
makedepends="
	cargo
	libseccomp-dev
	libsodium-dev
	linux-headers
	nodejs
	python3
	"
install="$pkgname.post-install"
subpackages="$pkgname-doc $pkgname-openrc"
source="$pkgname-$pkgver.tar.gz::https://github.com/cjdelisle/cjdns/archive/cjdns-v$pkgver.tar.gz
	no-march-flag.patch
	fix-build.patch
	"
builddir="$srcdir/$pkgname-$pkgname-v$pkgver"

export CARGO_PROFILE_RELEASE_LTO="true"
export CARGO_PROFILE_RELEASE_PANIC="abort"
export CARGO_PROFILE_RELEASE_OPT_LEVEL="s"
export CARGO_PROFILE_RELEASE_CODEGEN_UNITS=1

prepare() {
	default_prepare
	cargo fetch --locked
}

build() {
	export CJDNS_RELEASE_VERSION="$pkgver"
	# gcc11 now breaks with these.. but the code looks valid
	export CFLAGS="$CFLAGS -Wno-error=array-bounds -Wno-error=stringop-overflow"
	cargo build --release --frozen
}

check() {
	cargo test --frozen
}

package() {
	install -Dm755 target/release/cjdroute "$pkgdir"/usr/sbin/cjdroute
	install -Dm755 contrib/openrc/cjdns "$pkgdir"/etc/init.d/cjdns
	install -Dm644 doc/man/cjdroute.1 \
		"$pkgdir"/usr/share/man/man1/cjdroute.1
	install -Dm644 doc/man/cjdroute.conf.5 \
		"$pkgdir"/usr/share/man/man5/cjdroute.conf.5
	install -Dm644 -t "$pkgdir"/usr/share/doc/$pkgname \
		README.md \
		doc/admin-api.md \
		doc/configure.md \
		doc/djc_layer_model.md \
		doc/nat-gateway.md \
		doc/network-services.md \
		doc/non-root-user.md \
		doc/security_specification.md \
		doc/shorewall_and_vpn_gateway_howto.md \
		doc/tunnel.md
}

sha512sums="
a88131b93e39dbb755fec29944c783b97b090b3b1a5ef069412e97c3f0e0183cc78c1ccaaea9370248629fe87f9e727dbe91a7d579ba1a1dc4f6b46dd8d2b678  cjdns-21.2.tar.gz
571c675a83c5464d31ca1dc130d559dea1866013f7e4445fb16a5f9c9d9f9b63c07a9a9714f47abbb3a62ff334b4eeaadd849cb90818bec88be773d525ff7d5f  no-march-flag.patch
e76fdad9461d27d32976b70632a22cc7faad438ea8262cd8685705bc3c53586b88d7308ce47cd6f2ec391e04c4747a1c60feee492db81354d54924d68fc15aef  fix-build.patch
"
