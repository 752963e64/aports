From fb907d48644ff499a0957e717ca16840859ef0da Mon Sep 17 00:00:00 2001
From: Denys Vlasenko <vda.linux@googlemail.com>
Date: Fri, 25 Jun 2021 02:09:41 +0200
Subject: [PATCH] ash: parser: Fix VSLENGTH parsing with trailing garbage

CVE-2021-42375

Let's adopt Herbert Xu's patch, not waiting for it to reach dash git:
hush already has a similar fix.

Signed-off-by: Denys Vlasenko <vda.linux@googlemail.com>
(cherry picked from commit 53a7a9cd8c15d64fcc2278cf8981ba526dfbe0d2)
---
 shell/ash.c | 9 +++------
 1 file changed, 3 insertions(+), 6 deletions(-)

diff --git a/shell/ash.c b/shell/ash.c
index 00b33cc86..e7a1b4161 100644
--- a/shell/ash.c
+++ b/shell/ash.c
@@ -12633,7 +12633,7 @@ parsesub: {
 			do {
 				STPUTC(c, out);
 				c = pgetc_eatbnl();
-			} while (!subtype && isdigit(c));
+			} while ((subtype == 0 || subtype == VSLENGTH) && isdigit(c));
 		} else if (c != '}') {
 			/* $[{[#]]<specialchar>[}] */
 			int cc = c;
@@ -12663,11 +12663,6 @@ parsesub: {
 		} else
 			goto badsub;
 
-		if (c != '}' && subtype == VSLENGTH) {
-			/* ${#VAR didn't end with } */
-			goto badsub;
-		}
-
 		if (subtype == 0) {
 			static const char types[] ALIGN1 = "}-+?=";
 			/* ${VAR...} but not $VAR or ${#VAR} */
@@ -12724,6 +12719,8 @@ parsesub: {
 #endif
 			}
 		} else {
+			if (subtype == VSLENGTH && c != '}')
+				subtype = 0;
  badsub:
 			pungetc();
 		}
-- 
2.33.1

