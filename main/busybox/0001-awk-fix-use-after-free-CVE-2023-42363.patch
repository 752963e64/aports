From d58f0a2ae0311552591549519186460372552749 Mon Sep 17 00:00:00 2001
From: Natanael Copa <ncopa@alpinelinux.org>
Date: Mon, 20 May 2024 17:04:23 +0200
Subject: [PATCH 1/3] awk: fix use after free (CVE-2023-42363)

Fixes https://bugs.busybox.net/show_bug.cgi?id=15865
---
 editors/awk.c | 12 ++++++++----
 1 file changed, 8 insertions(+), 4 deletions(-)

diff --git a/editors/awk.c b/editors/awk.c
index 7a34da046..b9ed0445f 100644
--- a/editors/awk.c
+++ b/editors/awk.c
@@ -2891,10 +2891,6 @@ static var *evaluate(node *op, var *res)
 			if ((opinfo & OF_REQUIRED) && !op1)
 				syntax_error(EMSG_TOO_FEW_ARGS);
 			L.v = evaluate(op1, TMPVAR0);
-			if (opinfo & OF_STR1) {
-				L.s = getvar_s(L.v);
-				debug_printf_eval("L.s:'%s'\n", L.s);
-			}
 			if (opinfo & OF_NUM1) {
 				L_d = getvar_i(L.v);
 				debug_printf_eval("L_d:%f\n", L_d);
@@ -2917,6 +2913,14 @@ static var *evaluate(node *op, var *res)
 			}
 		}
 
+		/* Must get L.s after R.v is evaluated in case it realloc's L.v.
+		 * eg: x = (v = "abc",  gsub("b", "X", v));
+		 */
+		if ((opinfo & OF_RES1) && (opinfo & OF_STR1)) {
+			L.s = getvar_s(L.v);
+			debug_printf_eval("L.s:'%s'\n", L.s);
+		}
+
 		debug_printf_eval("switch(0x%x)\n", XC(opinfo & OPCLSMASK));
 		switch (XC(opinfo & OPCLSMASK)) {
 
-- 
2.45.2

