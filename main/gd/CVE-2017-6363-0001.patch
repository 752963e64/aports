From 2dbd8f6e66b73ed43d9b81a45350922b80f75397 Mon Sep 17 00:00:00 2001
From: "Christoph M. Becker" <cmbecker69@gmx.de>
Date: Sat, 3 Feb 2018 18:31:16 +0100
Subject: [PATCH] Fix #383 (amendment)

When reading images in GD or GD2 format, we have to ensure that the
transparent color is not set, if it would refer to a non-extant palette
entry.

diff --git a/src/gd_gd.c b/src/gd_gd.c
index 3915338db..78fbdb75c 100644
--- a/src/gd_gd.c
+++ b/src/gd_gd.c
@@ -108,10 +108,10 @@ _gdGetColors (gdIOCtx * in, gdImagePtr im, int gd2xFlag)
 		if (!gdGetWord (&im->transparent, in)) {
 			goto fail1;
 		}
-		/* Make sure transparent index is within bounds of the palette. */
-		if (im->transparent >= 256 || im->transparent < 0) {
-			im->transparent = (-1);
-		}
+	}
+	/* Make sure transparent index is within bounds of the palette. */
+	if (!(im->trueColor) && (im->transparent >= im->colorsTotal || im->transparent < 0)) {
+		im->transparent = (-1);
 	}
 	GD2_DBG (printf
 	         ("Palette had %d colours (T=%d)\n", im->colorsTotal,
