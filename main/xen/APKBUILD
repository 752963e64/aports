# Contributor: Roger Pau Monne <roger.pau@entel.upc.edu>
# Maintainer: Natanael Copa <ncopa@alpinelinux.org>
pkgname=xen
pkgver=4.16.5
pkgrel=7
pkgdesc="Xen hypervisor"
url="https://www.xenproject.org/"
arch="x86_64 armv7 aarch64"
license="GPL-2.0-only"
depends="bash iproute2 logrotate"
depends_dev="
	argp-standalone
	attr-dev
	bison
	curl-dev
	dev86
	e2fsprogs-dev
	flex
	gnutls-dev
	libaio-dev
	libcap-ng-dev
	libnl3-dev
	linux-headers
	lzo-dev
	ncurses-dev
	openssl-dev>3
	pciutils-dev
	perl
	perl-dev
	python3-dev
	spice-dev
	texinfo
	util-linux-dev
	xz-dev
	yajl-dev
	zlib-dev
	zstd-dev
	"
makedepends="$depends_dev autoconf automake libtool dnsmasq samurai"
options="!strip"

# Follow security issues on: https://xenbits.xen.org/xsa/

# secfixes:
#   0:
#     - CVE-2020-29568 XSA-349
#     - CVE-2020-29569 XSA-350
#     - CVE-2023-46840 XSA-450
#   4.7.0-r0:
#     - CVE-2016-6258 XSA-182
#     - CVE-2016-6259 XSA-183
#     - CVE-2016-5403 XSA-184
#   4.7.0-r1:
#     - CVE-2016-7092 XSA-185
#     - CVE-2016-7093 XSA-186
#     - CVE-2016-7094 XSA-187
#   4.7.0-r5:
#     - CVE-2016-7777 XSA-190
#   4.7.1-r1:
#     - CVE-2016-9386 XSA-191
#     - CVE-2016-9382 XSA-192
#     - CVE-2016-9385 XSA-193
#     - CVE-2016-9384 XSA-194
#     - CVE-2016-9383 XSA-195
#     - CVE-2016-9377 XSA-196
#     - CVE-2016-9378 XSA-196
#     - CVE-2016-9381 XSA-197
#     - CVE-2016-9379 XSA-198
#     - CVE-2016-9380 XSA-198
#   4.7.1-r3:
#     - CVE-2016-9932 XSA-200
#     - CVE-2016-9815 XSA-201
#     - CVE-2016-9816 XSA-201
#     - CVE-2016-9817 XSA-201
#     - CVE-2016-9818 XSA-201
#   4.7.1-r4:
#     - CVE-2016-10024 XSA-202
#     - CVE-2016-10025 XSA-203
#     - CVE-2016-10013 XSA-204
#   4.7.1-r5:
#     - XSA-207
#     - CVE-2017-2615 XSA-208
#     - CVE-2017-2620 XSA-209
#     - XSA-210
#   4.7.2-r0:
#     - CVE-2016-9603 XSA-211
#     - CVE-2017-7228 XSA-212
#   4.8.1-r2:
#     - CVE-2017-8903 XSA-213
#     - CVE-2017-8904 XSA-214
#   4.9.0-r0:
#     - CVE-2017-10911 XSA-216
#     - CVE-2017-10912 XSA-217
#     - CVE-2017-10913 XSA-218
#     - CVE-2017-10914 XSA-218
#     - CVE-2017-10915 XSA-219
#     - CVE-2017-10916 XSA-220
#     - CVE-2017-10917 XSA-221
#     - CVE-2017-10918 XSA-222
#     - CVE-2017-10919 XSA-223
#     - CVE-2017-10920 XSA-224
#     - CVE-2017-10921 XSA-224
#     - CVE-2017-10922 XSA-224
#     - CVE-2017-10923 XSA-225
#   4.9.0-r1:
#     - CVE-2017-12135 XSA-226
#     - CVE-2017-12137 XSA-227
#     - CVE-2017-12136 XSA-228
#     - CVE-2017-12855 XSA-230
#   4.9.0-r2:
#     - XSA-235
#   4.9.0-r4:
#     - CVE-2017-14316 XSA-231
#     - CVE-2017-14318 XSA-232
#     - CVE-2017-14317 XSA-233
#     - CVE-2017-14319 XSA-234
#   4.9.0-r5:
#     - XSA-245
#   4.9.0-r6:
#     - CVE-2017-15590 XSA-237
#     - XSA-238
#     - CVE-2017-15589 XSA-239
#     - CVE-2017-15595 XSA-240
#     - CVE-2017-15588 XSA-241
#     - CVE-2017-15593 XSA-242
#     - CVE-2017-15592 XSA-243
#     - CVE-2017-15594 XSA-244
#   4.9.0-r7:
#     - CVE-2017-15597 XSA-236
#   4.9.1-r1:
#     - XSA-246
#     - XSA-247
#   4.10.0-r1:
#     - XSA-248
#     - XSA-249
#     - XSA-250
#     - XSA-251
#     - CVE-2018-5244 XSA-253
#     - XSA-254
#   4.10.0-r2:
#     - CVE-2018-7540 XSA-252
#     - CVE-2018-7541 XSA-255
#     - CVE-2018-7542 XSA-256
#   4.10.1-r0:
#     - CVE-2018-10472 XSA-258
#     - CVE-2018-10471 XSA-259
#   4.10.1-r1:
#     - CVE-2018-8897 XSA-260
#     - CVE-2018-10982 XSA-261
#     - CVE-2018-10981 XSA-262
#   4.11.0-r0:
#     - CVE-2018-3639 XSA-263
#     - CVE-2018-12891 XSA-264
#     - CVE-2018-12893 XSA-265
#     - CVE-2018-12892 XSA-266
#     - CVE-2018-3665 XSA-267
#   4.11.1-r0:
#     - CVE-2018-15469 XSA-268
#     - CVE-2018-15468 XSA-269
#     - CVE-2018-15470 XSA-272
#     - CVE-2018-3620 XSA-273
#     - CVE-2018-3646 XSA-273
#     - CVE-2018-19961 XSA-275
#     - CVE-2018-19962 XSA-275
#     - CVE-2018-19963 XSA-276
#     - CVE-2018-19964 XSA-277
#     - CVE-2018-18883 XSA-278
#     - CVE-2018-19965 XSA-279
#     - CVE-2018-19966 XSA-280
#     - CVE-2018-19967 XSA-282
#   4.12.0-r2:
#     - CVE-2018-12126 XSA-297
#     - CVE-2018-12127 XSA-297
#     - CVE-2018-12130 XSA-297
#     - CVE-2019-11091 XSA-297
#   4.12.1-r0:
#     - CVE-2019-17349 CVE-2019-17350 XSA-295
#   4.13.0-r0:
#     - CVE-2019-18425 XSA-298
#     - CVE-2019-18421 XSA-299
#     - CVE-2019-18423 XSA-301
#     - CVE-2019-18424 XSA-302
#     - CVE-2019-18422 XSA-303
#     - CVE-2018-12207 XSA-304
#     - CVE-2019-11135 XSA-305
#     - CVE-2019-19579 XSA-306
#     - CVE-2019-19582 XSA-307
#     - CVE-2019-19583 XSA-308
#     - CVE-2019-19578 XSA-309
#     - CVE-2019-19580 XSA-310
#     - CVE-2019-19577 XSA-311
#   4.13.0-r3:
#     - CVE-2020-11740 CVE-2020-11741 XSA-313
#     - CVE-2020-11739 XSA-314
#     - CVE-2020-11743 XSA-316
#     - CVE-2020-11742 XSA-318
#   4.13.1-r0:
#     - XSA-312
#   4.13.1-r3:
#     - CVE-2020-0543 XSA-320
#   4.13.1-r4:
#     - CVE-2020-15566 XSA-317
#     - CVE-2020-15563 XSA-319
#     - CVE-2020-15565 XSA-321
#     - CVE-2020-15564 XSA-327
#     - CVE-2020-15567 XSA-328
#   4.13.1-r5:
#     - CVE-2020-14364 XSA-335
#   4.14.0-r1:
#     - CVE-2020-25602 XSA-333
#     - CVE-2020-25598 XSA-334
#     - CVE-2020-25604 XSA-336
#     - CVE-2020-25595 XSA-337
#     - CVE-2020-25597 XSA-338
#     - CVE-2020-25596 XSA-339
#     - CVE-2020-25603 XSA-340
#     - CVE-2020-25600 XSA-342
#     - CVE-2020-25599 XSA-343
#     - CVE-2020-25601 XSA-344
#   4.14.0-r2:
#     - CVE-2020-27674 XSA-286
#     - CVE-2020-27672 XSA-345
#     - CVE-2020-27671 XSA-346
#     - CVE-2020-27670 XSA-347
#     - CVE-2020-28368 XSA-351
#   4.14.0-r3:
#     - CVE-2020-29040 XSA-355
#   4.14.1-r0:
#     - CVE-2020-29480 XSA-115
#     - CVE-2020-29481 XSA-322
#     - CVE-2020-29482 XSA-323
#     - CVE-2020-29484 XSA-324
#     - CVE-2020-29483 XSA-325
#     - CVE-2020-29485 XSA-330
#     - CVE-2020-29566 XSA-348
#     - CVE-2020-29486 XSA-352
#     - CVE-2020-29479 XSA-353
#     - CVE-2020-29567 XSA-356
#     - CVE-2020-29570 XSA-358
#     - CVE-2020-29571 XSA-359
#   4.14.1-r2:
#     - CVE-2021-3308 XSA-360
#   4.14.1-r3:
#     - CVE-2021-26933 XSA-364
#   4.15.0-r0:
#     - CVE-2021-28687 XSA-368
#   4.15.0-r1:
#     - CVE-2021-28693 XSA-372
#     - CVE-2021-28692 XSA-373
#     - CVE-2021-0089 XSA-375
#     - CVE-2021-28690 XSA-377
#   4.15.0-r2:
#     - CVE-2021-28694 XSA-378
#     - CVE-2021-28695 XSA-378
#     - CVE-2021-28696 XSA-378
#     - CVE-2021-28697 XSA-379
#     - CVE-2021-28698 XSA-380
#     - CVE-2021-28699 XSA-382
#     - CVE-2021-28700 XSA-383
#   4.15.0-r3:
#     - CVE-2021-28701 XSA-384
#   4.15.1-r1:
#     - CVE-2021-28702 XSA-386
#     - CVE-2021-28703 XSA-387
#     - CVE-2021-28710 XSA-390
#   4.15.1-r2:
#     - CVE-2021-28704 XSA-388
#     - CVE-2021-28707 XSA-388
#     - CVE-2021-28708 XSA-388
#     - CVE-2021-28705 XSA-389
#     - CVE-2021-28709 XSA-389
#   4.16.1-r0:
#     - CVE-2022-23033 XSA-393
#     - CVE-2022-23034 XSA-394
#     - CVE-2022-23035 XSA-395
#     - CVE-2022-26356 XSA-397
#     - XSA-398
#     - CVE-2022-26357 XSA-399
#     - CVE-2022-26358 XSA-400
#     - CVE-2022-26359 XSA-400
#     - CVE-2022-26360 XSA-400
#     - CVE-2022-26361 XSA-400
#   4.16.1-r2:
#     - CVE-2022-26362 XSA-401
#     - CVE-2022-26363 XSA-402
#     - CVE-2022-26364 XSA-402
#   4.16.1-r3:
#     - CVE-2022-21123 XSA-404
#     - CVE-2022-21125 XSA-404
#     - CVE-2022-21166 XSA-404
#   4.16.1-r4:
#     - CVE-2022-26365 XSA-403
#     - CVE-2022-33740 XSA-403
#     - CVE-2022-33741 XSA-403
#     - CVE-2022-33742 XSA-403
#   4.16.1-r5:
#     - CVE-2022-23816 XSA-407
#     - CVE-2022-23825 XSA-407
#     - CVE-2022-29900 XSA-407
#   4.16.1-r6:
#     - CVE-2022-33745 XSA-408
#   4.16.2-r1:
#     - CVE-2022-42327 XSA-412
#     - CVE-2022-42309 XSA-414
#   4.16.2-r2:
#     - CVE-2022-23824 XSA-422
#   4.16.3-r0:
#     - CVE-2022-42311 XSA-326
#     - CVE-2022-42312 XSA-326
#     - CVE-2022-42313 XSA-326
#     - CVE-2022-42314 XSA-326
#     - CVE-2022-42315 XSA-326
#     - CVE-2022-42316 XSA-326
#     - CVE-2022-42317 XSA-326
#     - CVE-2022-42318 XSA-326
#     - CVE-2022-33747 XSA-409
#     - CVE-2022-33746 XSA-410
#     - CVE-2022-33748 XSA-411
#     - CVE-2022-42310 XSA-415
#     - CVE-2022-42319 XSA-416
#     - CVE-2022-42320 XSA-417
#     - CVE-2022-42321 XSA-418
#     - CVE-2022-42322 XSA-419
#     - CVE-2022-42323 XSA-419
#     - CVE-2022-42325 XSA-421
#     - CVE-2022-42326 XSA-421
#   4.16.4-r0:
#     - CVE-2022-27672 XSA-426
#     - CVE-2022-42332 XSA-427
#     - CVE-2022-42333 XSA-428
#     - CVE-2022-42334 XSA-428
#     - CVE-2022-42331 XSA-429
#   4.16.4-r1:
#     - CVE-2023-20593 XSA-433
#   4.16.4-r3:
#     - CVE-2023-34320 XSA-436
#   4.16.5-r0:
#     - CVE-2023-20569 XSA-434
#     - CVE-2022-40982 XSA-435
#   4.16.5-r1:
#     - CVE-2023-34321 XSA-437
#     - CVE-2023-34322 XSA-438
#   4.16.5-r2:
#     - CVE-2023-20588 XSA-439
#   4.16.5-r3:
#     - CVE-2023-34323 XSA-440
#     - CVE-2023-34326 XSA-442
#     - CVE-2023-34325 XSA-443
#     - CVE-2023-34327 XSA-444
#     - CVE-2023-34328 XSA-444
#   4.16.5-r4:
#     - CVE-2023-46835 XSA-445
#     - CVE-2023-46836 XSA-446
#   4.16.5-r5:
#     - CVE-2023-46837 XSA-447
#   4.16.5-r6:
#     - CVE-2023-46839 XSA-449
#   4.16.5-r7:
#     - CVE-2023-46841 XSA-451
#     - CVE-2023-28746 XSA-452
#     - CVE-2024-2193 XSA-453

case "$CARCH" in
x86*)
	makedepends="$makedepends iasl seabios-bin"
	;;
arm*)
	makedepends="$makedepends dtc-dev"
	;;
aarch64)
	makedepends="$makedepends dtc-dev iasl"
	;;
esac

#if [ "$CARCH" != "armhf" ]; then
#	subpackages="$pkgname-dbg"
#fi
subpackages="$subpackages $pkgname-doc $pkgname-dev $pkgname-libs
	$pkgname-hypervisor $pkgname-bridge $pkgname-qemu $pkgname-bash-completion"

# grep _VERSION= stubdom/configure
_ZLIB_VERSION="1.2.3"
_LIBPCI_VERSION="2.2.9"
_NEWLIB_VERSION="1.16.0"
_LWIP_VERSION="1.3.0"
_GRUB_VERSION="0.97"
_GMP_VERSION="4.3.2"
_POLARSSL_VERSION="1.1.4"
_TPMEMU_VERSION="0.7.4"

# grep ^IPXE_GIT_TAG tools/firmware/etherboot/Makefile
_IPXE_GIT_TAG=3c040ad387099483102708bb1839110bc788cefb


source="https://downloads.xenproject.org/release/xen/$pkgver/xen-$pkgver.tar.gz
	https://xenbits.xen.org/xen-extfiles/gmp-$_GMP_VERSION.tar.bz2
	https://xenbits.xen.org/xen-extfiles/grub-$_GRUB_VERSION.tar.gz
	https://xenbits.xen.org/xen-extfiles/lwip-$_LWIP_VERSION.tar.gz
	https://xenbits.xen.org/xen-extfiles/newlib-$_NEWLIB_VERSION.tar.gz
	https://xenbits.xen.org/xen-extfiles/pciutils-$_LIBPCI_VERSION.tar.bz2
	https://xenbits.xen.org/xen-extfiles/polarssl-$_POLARSSL_VERSION-gpl.tgz
	https://xenbits.xen.org/xen-extfiles/tpm_emulator-$_TPMEMU_VERSION.tar.gz
	https://xenbits.xen.org/xen-extfiles/zlib-$_ZLIB_VERSION.tar.gz
	https://xenbits.xen.org/xen-extfiles/ipxe-git-$_IPXE_GIT_TAG.tar.gz

	xen-stable-4.16-20230920.patch

	xsa440-4.17.patch
	xsa442-4.17.patch
	xsa443-4.16-01.patch
	xsa443-4.16-02.patch
	xsa443-4.16-03.patch
	xsa443-4.16-04.patch
	xsa443-4.16-05.patch
	xsa443-4.16-06.patch
	xsa443-4.16-07.patch
	xsa443-4.16-08.patch
	xsa443-4.16-09.patch
	xsa443-4.16-10.patch
	xsa443-4.16-11.patch
	xsa444-4.16-1.patch
	xsa444-4.16-2.patch
	xsa445-4.16.patch
	xsa446.patch
	xsa447-4.16.patch
	xsa449-4.16.patch
	xsa451-4.16.patch
	xsa452-4.16-1.patch
	xsa452-4.16-2.patch
	xsa452-4.16-3.patch
	xsa452-4.16-4.patch
	xsa452-4.16-5.patch
	xsa452-4.16-6.patch
	xsa452-4.16-7.patch
	xsa453-4.16-1.patch
	xsa453-4.16-2.patch
	xsa453-4.16-3.patch
	xsa453-4.16-4.patch
	xsa453-4.16-5.patch
	xsa453-4.16-6.patch
	xsa453-4.16-7.patch
	xsa453-4.16-8.patch

	mini-os-__divmoddi4.patch
	qemu-xen_paths.patch

	hotplug-vif-vtrill.patch

	hotplug-Linux-iscsi-block-handle-lun-1.patch

	stubdom-hack.patch

	xenstored.initd
	xenstored.confd
	xenconsoled.initd
	xenconsoled.confd
	xendomains.initd
	xendomains.confd
	xen-consoles.logrotate
	xenqemu.confd
	xenqemu.initd
	xendriverdomain.initd
	xen-pci.initd
	xen-pci.confd
	"

_seabios=/usr/share/seabios/bios-256k.bin

# Override wrong arch detection from xen-$pkgver/Config.mk.
case "$CARCH" in
armv7) export XEN_TARGET_ARCH="arm32";;
aarch64) export XEN_TARGET_ARCH="arm64";;
esac

prepare() {
	local i _failed=''

	for i in $source; do
		case $i in
		*-etherboot-*)
			p=${i%%::*}
			p=${p##*/}
			msg "adding to ipxe: $p"
			cp "$srcdir"/$p tools/firmware/etherboot/patches/
			echo "$p" >> tools/firmware/etherboot/patches/series
			;;
		*.patch) msg $i; patch -s -N -p1 -i "$srcdir"/$i \
				|| _failed="$_failed $i"
			;;
		*/ipxe-git-*)
			ln -s "$srcdir"/${i##*/} \
				tools/firmware/etherboot/ipxe.tar.gz
			;;
		*/xen-extfiles/*)
			ln -s "$srcdir"/${i##*/} stubdom/
			;;
		esac
	done
	if [ -n "$_failed" ]; then
		error "Patches failed:"
		for i in $_failed; do
			echo $i
		done
		return 1
	fi

	# remove all -Werror
	msg "Eradicating -Werror..."
	find . \( -name '*.mk' -o -name 'Make*' \) -exec sed -i -e 's/-Werror//g' {} +

	sed -e 's,^#include <sys/signal.h>$,#include <signal.h>,g' -i tools/qemu-xen/include/qemu/osdep.h

	msg "Updating config.sub..."
	update_config_sub

	msg "Autoreconf..."
	autoreconf --install

	unset CFLAGS
	unset LDFLAGS
}

# Unset CFLAGS and LDFLAGS because the xen build system
# doesn't support them. Instead use .config in xen root
# folder if necessary.
munge_cflags() {
	msg "Munging CFLAGS..."

	unset CFLAGS
	unset LDFLAGS
	unset LANG
	unset LC_ALL

	case "$CARCH" in
	arm*) export CFLAGS="-mcpu=cortex-a15";;
	aarch64) export CFLAGS="-mcpu=cortex-a53";;
	esac
}

# These tasks are added as separate tasks to enable a packager
# to invoke specific tasks like building the hypervisor.  i.e.
#    $ abuild configure build_tools
configure() {
	case "$CARCH" in
	x86*)
		msg "Running configure..."
		./configure --prefix=/usr \
			--build=$CBUILD \
			--host=$CHOST \
			--with-system-seabios=$_seabios \
			--enable-9pfs \
			--enable-qemu-traditional \
			--enable-pv-grub \
			--disable-golang
		;;
	*)
		msg "Running configure..."
		./configure --prefix=/usr \
			--build=$CBUILD \
			--host=$CHOST \
			--with-system-seabios=$_seabios \
			--enable-9pfs \
			--disable-golang
		;;
	esac
}

build_hypervisor() {
	munge_cflags

	msg "Building hypervisor..."
	make xen
}

build_tools() {
	munge_cflags

	msg "Building tools..."
	NO_WERROR=1 make tools
}

build_docs() {
	munge_cflags

	msg "Building documentation..."
	make docs
}

build_stubdom() {
	munge_cflags

	msg "Building stub domains..."
	make stubdom
}

build() {
	configure
	build_hypervisor
	build_tools
	build_docs
	case "$CARCH" in
	x86*) build_stubdom;;
	esac
}

package() {
	munge_cflags

	local _studom=
	case "$CARCH" in
		x86*) _stubdom=install-stubdom;;
	esac

	make DESTDIR="$pkgdir" EFI_DIR=/usr/lib/efi \
		BASH_COMPLETION_DIR=/usr/share/bash-completion/completions \
		install-xen install-tools install-docs $_stubdom

	# remove default xencommons
	rm -rf "$pkgdir"/etc/init.d/xencommons
	# remove default xendriverdomain
	rm -rf "$pkgdir"/etc/init.d/xendriverdomain

	for i in $source; do
		case $i in
		*.initd) install -Dm755 "$srcdir"/$i \
				"$pkgdir"/etc/init.d/${i%.*};;
		*.confd) install -Dm644 "$srcdir"/$i \
				"$pkgdir"/etc/conf.d/${i%.*};;
		esac
	done
	install -Dm644 "$srcdir"/xen-consoles.logrotate \
		"$pkgdir"/etc/xen/xen-consoles.logrotate

	# we need to exclude /usr/share when stripping
	msg "Stripping binaries"
	scanelf --recursive --nobanner --etype "ET_DYN,ET_EXEC" "$pkgdir"/usr/lib \
		"$pkgdir"/usr/bin \
		"$pkgdir"/usr/sbin \
		| sed -e 's:^ET_DYN ::' -e 's:^ET_EXEC ::' \
		| xargs strip
}

check() {
	make test
}

libs() {
	pkgdesc="Libraries for Xen tools"
	replaces="xen"
	depends=
	mkdir -p "$subpkgdir"/usr/lib
	mv "$pkgdir"/usr/lib/*.so.* \
		"$pkgdir"/usr/lib/xenfsimage \
		"$subpkgdir"/usr/lib/
}

hypervisor() {
	pkgdesc="Xen hypervisor"
	depends=
	mkdir -p "$subpkgdir"
	mv "$pkgdir"/boot "$subpkgdir"/
	if [ -d "$pkgdir"/usr/lib/efi ]; then
		mkdir -p "$subpkgdir"/usr/lib
		mv "$pkgdir"/usr/lib/efi "$subpkgdir"/usr/lib/
	fi
}

bridge() {
	depends="dnsmasq"
	pkgdesc="Bridge interface for XEN with dhcp"
	mkdir -p "$subpkgdir"/etc/conf.d \
		"$subpkgdir"/etc/init.d \
		"$subpkgdir"/etc/xen

	ln -s dnsmasq "$subpkgdir"/etc/init.d/dnsmasq.xenbr0
	cat ->>"$subpkgdir"/etc/conf.d/dnsmasq.xenbr0 <<EOF
		BRIDGE_ADDR="10.0.4.1"
		BRIDGE_NETMASK="255.255.255.0"
		BRIDGE_NETWORK="10.0.4.0/24"
		BRIDGE_DHCP_RANGE="10.0.4.2,10.0.4.254"
		BRIDGE_DHCP_MAX="253"
		BRIDGE_MAC="00:16:3f:00:00:00"
		DNSMASQ_CONFFILE="/etc/xen/dnsmasq.conf"
EOF
	cat ->>"$subpkgdir"/etc/xen/dnsmasq.conf <<EOF
		#dhcp-host=somehost,10.0.4.3
		#dhcp-host=otherhost,10.0.4.4
EOF

}

qemu() {
	pkgdesc="QEMU for XEN"
	case "$CARCH" in
	x86*)
		depends="$depends seabios-bin"
		;;
	esac
	mkdir -p "$subpkgdir"/etc/conf.d \
		"$subpkgdir"/etc/init.d \
		"$subpkgdir"/usr/lib/xen/bin \
		"$subpkgdir"/usr/share/applications

	amove etc/conf.d/xenqemu
	amove etc/init.d/xenqemu
	amove usr/lib/xen/bin/qemu*
	mv "$pkgdir"/usr/share/qemu-xen/applications/qemu.desktop \
		"$subpkgdir"/usr/share/applications/qemu-xen.desktop
	amove usr/share/qemu-xen

	case "$CARCH" in
	x86*)
		# these files are only in the x86* builds
		amove usr/lib/xen/libexec/qemu-bridge-helper
		# qemu-traditional files not caught above
		mkdir -p "$subpkgdir"/usr/lib/xen/bin "$subpkgdir"/usr/lib/xen/boot
		amove usr/share/xen/qemu
		amove usr/bin/qemu-img-xen
		amove usr/bin/qemu-nbd-xen
		amove etc/xen/scripts/qemu-ifup
		amove usr/lib/xen/bin/stubdom-dm
		amove usr/lib/xen/bin/stubdompath.sh
		amove usr/lib/xen/boot/ioemu-stubdom.gz
		amove usr/lib/xen/boot/ipxe.bin
		;;
	esac
}

sha512sums="
2f370787b72b2cd9d81c0b5f138133e676d2b9c8c76e31e6439649d7145242a6b7be0d51a7ff4f4197a99e3f6b24ac50e63d2fa49368da440d3f555e70c4ebd3  xen-4.16.5.tar.gz
18a5d5eeab8390176a2601cd3730e0bd1814ff03c6303efd956b00ac069746710d31ee23ee30c8d537c43bb2f009829997c4b00e4f81cec73bd3428f07e35ea6  xen-stable-4.16-20230920.patch
505d1a7b5b5664ae07984900963c1bf13f59be2b910ce7cb076031e6a79aad87e6f1bf7e2cc168f8e4b09aa76ccb18a96209b3528ed7225cebce1fa17ff18ad0  xsa440-4.17.patch
109f3127382fe5e38e29e2147d2ac730b672b777d370b91d5eec80f90d0ce66963d5b5caea7bf5bb79aff37e93e3c5588872fec96f4a942cf2027bf8bf463f8f  xsa442-4.17.patch
d282f86de2d7a163af6d32e50a69922ecec860a27e3be41476d85c73223a6b69da24123074a7206031570fd45e0b6c4f636ebbf2bb10377b1c3d70063ef091b6  xsa443-4.16-01.patch
d622e8963ba61617038d861054e3851e7eefe733db7f6a9ef9e055a64362961772eb1ad5ec9dab76db17f7039d0d24172077757f645416089440ea07feaea153  xsa443-4.16-02.patch
315a1d7c52c95d5dd052eb60bdd1c5847f282a8d7b8d026806e0c4c49ddf7795ed1fab619f8ffeeb56a96c48d928dcf7ce364165a1ac5e79809d2e2ff28deace  xsa443-4.16-03.patch
a43ed929507e4251668ded0c7cbeff070e765c060e528e8a21ce83aa8aeaac207ccceca69f3377ec0ddce8a5d6da70b3c2a85e88ab948e431271f988cae4b306  xsa443-4.16-04.patch
f9770ef0713ef075ddaaac4681e04c859cb6428662647f4ab6d900d565ca915007e94f6365e01ddd1a85b1d62f574fa909c854a6a3f4834cdc369b88e25b5f9b  xsa443-4.16-05.patch
4a53c3653e634424c87e4040781b5b5a755089ad35a775fa908e05cb857f077761fb27dfc867e8ed70de51679cfc4333a5623cc241ff1f731cbba96c2fea28cf  xsa443-4.16-06.patch
73be95abcf857d4f5cc055ce47ebf508ee31347d1a04bbf53f21265b36a5082e0b7e2e98df3309122909583aac759b8b1326dcd4e9a9f75bc7b277f17ff9a670  xsa443-4.16-07.patch
deb3eb9adbcf1e03089b973d043d307ebb900fd85f2d01a674cd6e78853377bda26f69e875f797bdcd47d902dc477e40db24a2d690b53a7a516d3a7bc017399b  xsa443-4.16-08.patch
3b550f2734d3815924d604962a47dc4ad6c4fbce851fe37e04e40cebac616bb97b9ef07b00bde5ad783b241ec1f3a357e9d2c4ce652365b13a463c484ee2c490  xsa443-4.16-09.patch
fa29989f81a25a26c87a21ef24a0f9fb57e4d3e27869e8e46650a75c003a696eac44c02e7171e4158ddb10e6e13e048489cfcc87a63b633cbb96e8c3f482a45f  xsa443-4.16-10.patch
3622e52f2321f92bfa764e20e24f2d73a28b8b4e309661f53a837e8e563065322dfa4da4390dbaeed74fcd47825934decd88720e53b7e70c6d982be6a3e61334  xsa443-4.16-11.patch
3d8f8a85d8d5cea5ae5072456db12f3526d787a8a8dcbe2402bc0fb0d6993adbfa0045ee971227744f5a94567d25d38e802c3117acda2e862f35f16000b3a667  xsa444-4.16-1.patch
f3694e355ae921528591dfec79c187eb22890f5a294ad2f4d4e96ed0476aa290c9a993f30a51e2ca5e3a731b14133615384900a3f7119e1d2d369188dc470245  xsa444-4.16-2.patch
9a365c1c58e4555b923455f44150d72e890867eb62cb2185e104d3061d2e8288854ed2adeb21af269be68e4e91d6a22383b83b814a117a5afd88d165d9e6811c  xsa445-4.16.patch
229319de61f83d98b41ff7bf8ac944f7d5283f190ae54ed01087409b2cf42c141455b2a56c28898288db85780587803670671c1f5f446359a1d9767259f975d5  xsa446.patch
98ac1fd6b2755e4034d70f283253eb18011b81ecb78f6507629ff8144faf422008ec6c603b6f9727bc752f57f7d09f9fce3cde3127b006c6e4ef0aeab319647f  xsa447-4.16.patch
4baf6b93eaa46b90a5784502857fcbe271a06bf433d2b58b47c6777e3bc0860d94bb4c4e8e93b9cb9295c475e6d030fd59b4d9b7efd57ad087108650c5022656  xsa449-4.16.patch
8a8228b9da87b4d10217c3d7a8091655feee5d43c7a370ea869e4cf9f7b5c679ef56ec530fa49dbac5b607c24687bd8810b33a040734f5750aa04917f6a8e250  xsa451-4.16.patch
64c8bf4350955dc2ef052713415d7dace6c7afcc35d18b9a0d648e25de4cb02783fcec3828fad5c33d2e482ca42e13936c14a8274ac34f0f9130905c8f010b3f  xsa452-4.16-1.patch
16aaabfec8abf90c416c86c123c8f657c6d9e3f5a40cf558fe4b207f9fc6e95253697c0a9f4a8c9332782bd627de10bd8c930b2c31a93d02717795c36e36e4b1  xsa452-4.16-2.patch
a81677105f358974f8709fbee70d0ba16eee64d4261de69f012bc0ec33955cf2f76f4fc11a4a027ac6552d7b448fc18a5fd4f9bb58bcab819b9492376254a3c1  xsa452-4.16-3.patch
8344d55fea823ec8711d27fb6188ee0e8a613383f814a0f83046c7e822a72e6583cb94c0e7536c47d9a9209805492fa6a99505ae925f60f0ac68911a4fd06e54  xsa452-4.16-4.patch
dfe195a53d90ee4fd1e44ba5ab270ac01d8a241f279fe9c1c0977a0e5c3d4c1792ab9fa20bd37ece7fd494d00d9009f8a1922c3438b08eed852982e88ed85638  xsa452-4.16-5.patch
6c045a64ff119ec5e90cad0974230aca7cc94e7990a85136ec0fd38a051f6179139d75de95766d36e6d6330f48999721d37ba7102a2eab2850fff9c56b236abb  xsa452-4.16-6.patch
f196f4e3877093d2892106778aaa61d318a65392adde7d38a8256ccf5e76eab4f8d833e3f7f119611598b26c190f197e85bd97ecf7ad73d362ec4e2b8302e37a  xsa452-4.16-7.patch
23abb30d679285fff2687a0183425c30aa5214026b0d061d079911a471ffa823d48d6e3929e9180c583db8eab03bf871236b94c5ebbe9b94f016896474734abc  xsa453-4.16-1.patch
2bf1ec8e49347f2fb305e1bb8d6b6be98b409409c93ce0d6a83751aea681be1548200acb111c242767033489595c040ffff32b31ae5e03dce21e5916cc59b470  xsa453-4.16-2.patch
a8be0ffce584d408ae865679ea131e76157ee73e83c878b3a36aa795cb75ef63b6c6ab74fd54f4b0f283f557299d4eb9d2dae4f526c3dd8b9b0c0ea4e4fd369e  xsa453-4.16-3.patch
3c0cc89564ae76714304041a67612fe035617f7709c62a3d069c66b09228fa611881cedf81b7d9a405c9410477796cdfe62399b7f95790789b708b05311df912  xsa453-4.16-4.patch
5004450f8446c4e7dc9b3c40a5140aae9779a1cf36be1465b6e46a3b6b433acecc248b557713771129c6ec7a06080330bb9e9f4055f9787105ec2e118efbe893  xsa453-4.16-5.patch
ed7c23e0ae1ab9df5c6ddc581110345208f924071fa012f5471991fa26f35245c7c8cbb6d822d5c98a8f5a8bcf0b267243429b9b6e416201898a78a152de1d23  xsa453-4.16-6.patch
3559110c1f4b26b0714cdd0d33f644262e331d3fc6bf29377ad85194a74e2efdb58841cfe9f6b2932a853c3ff702d0e38e0bc9c6e25aa65c7236b236f17ebdd1  xsa453-4.16-7.patch
cf01db150adc7d737161cd9c2c607e85e05b0d5d74371b1bcbc2e87d52f38adaa17bb798dacfd690e63de2cf165421847c722eed0eef5474565b3fdd1c6b25e6  xsa453-4.16-8.patch
2e0b0fd23e6f10742a5517981e5171c6e88b0a93c83da701b296f5c0861d72c19782daab589a7eac3f9032152a0fc7eff7f5362db8fccc4859564a9aa82329cf  gmp-4.3.2.tar.bz2
c2bc9ffc8583aeae71cee9ddcc4418969768d4e3764d47307da54f93981c0109fb07d84b061b3a3628bd00ba4d14a54742bc04848110eb3ae8ca25dbfbaabadb  grub-0.97.tar.gz
1465b58279af1647f909450e394fe002ca165f0ff4a0254bfa9fe0e64316f50facdde2729d79a4e632565b4500cf4d6c74192ac0dd3bc9fe09129bbd67ba089d  lwip-1.3.0.tar.gz
40eb96bbc6736a16b6399e0cdb73e853d0d90b685c967e77899183446664d64570277a633fdafdefc351b46ce210a99115769a1d9f47ac749d7e82837d4d1ac3  newlib-1.16.0.tar.gz
2b3d98d027e46d8c08037366dde6f0781ca03c610ef2b380984639e4ef39899ed8d8b8e4cd9c9dc54df101279b95879bd66bfd4d04ad07fef41e847ea7ae32b5  pciutils-2.2.9.tar.bz2
88da614e4d3f4409c4fd3bb3e44c7587ba051e3fed4e33d526069a67e8180212e1ea22da984656f50e290049f60ddca65383e5983c0f8884f648d71f698303ad  polarssl-1.1.4-gpl.tgz
4928b5b82f57645be9408362706ff2c4d9baa635b21b0d41b1c82930e8c60a759b1ea4fa74d7e6c7cae1b7692d006aa5cb72df0c3b88bf049779aa2b566f9d35  tpm_emulator-0.7.4.tar.gz
021b958fcd0d346c4ba761bcf0cc40f3522de6186cf5a0a6ea34a70504ce9622b1c2626fce40675bc8282cf5f5ade18473656abc38050f72f5d6480507a2106e  zlib-1.2.3.tar.gz
4ac1d07ce879a3a8c6c260380258c37f5e4ecddc880b27fb59afc38fbf3718e81b04a4dda2b58fe7a438a23175e00b6179fc067acbc4a75e33d93c4b85ff5d68  ipxe-git-3c040ad387099483102708bb1839110bc788cefb.tar.gz
b9c754220187955d01ffbb6e030dace9d9aaae755db1765d07e407858c71a2cb0de04e0ab2099cd121d9e1bc1978af06c7dbd2fd805e06eca12ac5d527f15a52  mini-os-__divmoddi4.patch
fe3c253d03e1962ca4dd6bccd2e51817075450f51aa66e8ab9673bdd5a530dc08f1ed7817a1271ada028b0c34162f37cd6b24d84334403767caacd8206284cbb  qemu-xen_paths.patch
1c9cb24bf67a2e84466572198315d5501627addf1ccd55d8d83df8d77d269a6696cd45e4a55601495168284e3bff58fb39853f56c46aaddd14f6191821678cf6  hotplug-vif-vtrill.patch
8c9cfc6afca325df1d8026e21ed03fa8cd2c7e1a21a56cc1968301c5ab634bfe849951899e75d328951d7a41273d1e49a2448edbadec0029ed410c43c0549812  hotplug-Linux-iscsi-block-handle-lun-1.patch
6c28470dab368ce94d94db9e66954e4d915394ea730f6d4abb198ae122dbd7412453d6d8054f0a348d43d7f807fb13294363162f8b19f47311e802ffa9a40a90  stubdom-hack.patch
a8dda349cab62febf2ef506eb26d2ba494a649b1c37206519ae23f02a36f600b19996bb8a148e5f21a240ec53ecfcf971a07686b9ddcdad417563fdf39b2215f  xenstored.initd
093f7fbd43faf0a16a226486a0776bade5dc1681d281c5946a3191c32d74f9699c6bf5d0ab8de9d1195a2461165d1660788e92a3156c9b3c7054d7b2d52d7ff0  xenstored.confd
1dd04f4bf1890771aa7eef0b6e46f7139487da0907d28dcdbef9fbe335dcf731ca391cfcb175dd82924f637a308de00a69ae981f67348c34f04489ec5e5dc3b7  xenconsoled.initd
30df69cc38d0bed26bc4d6e08a2b62cbdc654d5f663009a05cb3b83b3e3dc5e206362d3fd59abbb753ceb8d6d79eaa6e15d079bb8f4f35dc74667103faf4e85d  xenconsoled.confd
71d464464130fbac0ffe6ce06337d8032b4a03a9da5fbb313b26538946d122f2531ef91e258faaff2636b29514cbb65ec0f62615a48437a8383f24f7e59df685  xendomains.initd
c7c0eecd5f454d903b57a710902da27dcb2c6b200f88d4eadfab33a447be6b41454109d482aab849a690446ea5c928e619dfc6cf95b7955f00a476f2317bb82b  xendomains.confd
ab2105c75cfe01768aecd5bcbb56269d63666e8a44e42b6a83aee87df6c84ee2f9ab249171c21b2e09f8fec2cae8318f6e87d160989398a3e7dd68db8d52c426  xen-consoles.logrotate
bdbe15c924071cdc2d0f23e53ba8e3f837d4b5369bfb218abd3405f9bef25d105269aaf0784baeb69c073a5786b8c82ffdfd414e86874da34293cfdc2c497928  xenqemu.confd
b833ed7334d912b519f317caefcf278274964838ca5588a0d58d9e91817e6c5519eab42521b78f7fc307ad24f25934e4f5d5d1097f783a847fc22d2cc38b27b5  xenqemu.initd
bc40f7c0548162ce2181b34ea39064c0e1c529af95e0a282c78879916036cf7ac3c2cb7c433f8702a9fffe6e9257707d25fdccb6f8d045aef78b5e251a476309  xendriverdomain.initd
a46337bebce24337f00adbe08095b9f5128c1f440e2033329e5ace9fd817a31fb772d75c0ecc7cc06f34b1522ebf8b21874ee4d0881a0f29851b1c1235f29cf3  xen-pci.initd
2db5fa6edeeb028236460029b976a849f22b3a15d3929acc3911dc41f365b471c2b815eb111639bc230a69528b1571f3c2e9e8e1e81a6679e55387e39355aa99  xen-pci.confd
"
