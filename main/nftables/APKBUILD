# Contributor: SÃ¶ren Tempel <soeren+alpine@soeren-tempel.net>
# Contributor: Jakub Jirutka <jakub@jirutka.cz>
# Maintainer: Francesco Colista <fcolista@alpinelinux.org>
pkgname=nftables
pkgver=1.0.5
pkgrel=2
pkgdesc="Netfilter tables userspace tools"
url="https://netfilter.org/projects/nftables"
arch="all"
license="GPL-2.0-or-later"
makedepends="
	asciidoc
	autoconf
	automake
	bison
	docbook2x
	flex
	gmp-dev
	jansson-dev
	libmnl-dev
	libnftnl-dev
	libtool
	ncurses-dev
	python3
	readline-dev
	"
install="$pkgname.post-upgrade"
subpackages="
	$pkgname-static
	$pkgname-dev
	$pkgname-doc
	$pkgname-openrc
	py3-$pkgname:_py3:noarch
	"
source="https://netfilter.org/projects/nftables/files/nftables-$pkgver.tar.bz2
	nftables.confd
	nftables.initd
	nftables.nft
	"

prepare() {
	default_prepare
	sed -i '1i#include "config.h"' "$builddir"/src/proto.c
	autoreconf -fi
	rm -Rf autom4te*.cache config.h.in~
}

build() {
	CONFIG_MAN=y DB2MAN=docbook2x-man ./configure \
		--build=$CBUILD \
		--host=$CHOST \
		--prefix=/usr \
		--sysconfdir=/usr/share \
		--mandir=/usr/share/man \
		--infodir=/usr/share/info \
		--localstatedir=/var \
		--enable-python \
		--enable-static=yes \
		--with-json \
		--with-cli=readline
	make
}

package() {
	make DESTDIR="$pkgdir" install

	install -Dm755 "$srcdir"/$pkgname.initd "$pkgdir"/etc/init.d/$pkgname
	install -Dm644 "$srcdir"/$pkgname.confd "$pkgdir"/etc/conf.d/$pkgname
	install -Dm644 "$srcdir"/nftables.nft "$pkgdir"/etc/nftables.nft
	install -dm755 "$pkgdir"/etc/nftables.d
}

_py3() {
	pkgdesc="$pkgdesc (Python interface)"
	depends="$pkgname=$pkgver-r$pkgrel"

	amove usr/lib/python3*
}

sha512sums="
51cbf10579db7eed58f4358044840f2ce1bffe84533c5fb03e0ebcc702970856455576ac793169c94d38a9f8148e33631ad91444e54a8be189d93af7c27feb9a  nftables-1.0.5.tar.bz2
f36e42bde36844e849ec2660bdf09998c5dcb11ab07f3df23a536de8f821cfc48165cf057eac77467458b3a671bd55918040a58cdb5a33faed32edb808502f34  nftables.confd
2e6efafc1d3a283b53e458b9041f6152d52aa2d92d23ee96006a478227bb848a8fab31ecfa179ae010b91bc93e69246307764a85988eef579131c3bd3d397b1d  nftables.initd
8770185348e98c3fb7fb3106441bb89f31f9157f8fd475a238ea91f288f4babee7d867b229c5bb29fabca6fce6f3679f9f9c17fdbc077e3693d7c00ee2611446  nftables.nft
"
