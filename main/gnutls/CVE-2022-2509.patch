Patch-Source: https://github.com/gnutls/gnutls/commit/ce37f9eb265dbe9b6d597f5767449e8ee95848e2
news/tests trimmed
---
From ce37f9eb265dbe9b6d597f5767449e8ee95848e2 Mon Sep 17 00:00:00 2001
From: Zoltan Fridrich <zfridric@redhat.com>
Date: Fri, 22 Jul 2022 12:00:11 +0200
Subject: [PATCH] Fix double free during gnutls_pkcs7_verify

Signed-off-by: Zoltan Fridrich <zfridric@redhat.com>
---
 .gitignore                       |   1 +
 NEWS                             |   4 +
 lib/x509/pkcs7.c                 |   3 +-
 tests/Makefile.am                |   2 +-
 tests/pkcs7-verify-double-free.c | 215 +++++++++++++++++++++++++++++++
 5 files changed, 223 insertions(+), 2 deletions(-)
 create mode 100644 tests/pkcs7-verify-double-free.c

diff --git a/lib/x509/pkcs7.c b/lib/x509/pkcs7.c
index 3227bf3a25..ff8cab0158 100644
--- a/lib/x509/pkcs7.c
+++ b/lib/x509/pkcs7.c
@@ -1322,7 +1322,8 @@ gnutls_x509_crt_t find_signer(gnutls_pkcs7_t pkcs7, gnutls_x509_trust_list_t tl,
 				issuer = find_verified_issuer_of(pkcs7, issuer, purpose, vflags);
 
 				if (issuer != NULL && gnutls_x509_crt_check_issuer(issuer, issuer)) {
-					if (prev) gnutls_x509_crt_deinit(prev);
+					if (prev && prev != signer)
+						gnutls_x509_crt_deinit(prev);
 					prev = issuer;
 					break;
 				}
