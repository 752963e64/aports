# Maintainer: Natanael Copa <ncopa@alpinelinux.org>
pkgname=ncurses
pkgver=6.3_p20211120
_ver=${pkgver/_p/-}
_mirror_commit=461e72d1826483cb2c2cb243412f2dc5b00b2b1a
pkgrel=2
pkgdesc="Console display library"
url="https://invisible-island.net/ncurses/"
arch="all"
options="!check" # "tests" are actual demo programs, not a test suite.
license="MIT"
makedepends_build="ncurses"
subpackages="$pkgname-static $pkgname-dev $pkgname-doc $pkgname-libs
	$pkgname-terminfo-base:base:noarch $pkgname-terminfo:terminfo:noarch"
source="$pkgname-$pkgver.tar.gz::https://github.com/mirror/ncurses/archive/$_mirror_commit.tar.gz
	CVE-2022-29458.patch
	fix-configure-root-args-option.patch
	root-environ-only-setuid.patch
	"
builddir="$srcdir"/ncurses-$_mirror_commit

# secfixes:
#   6.3_p20211120-r2:
#     - CVE-2023-29491
#   6.3_p20211120-r1:
#     - CVE-2022-29458
#   6.2_p20200530-r0:
#     - CVE-2021-39537
#   6.1_p20180414-r0:
#     - CVE-2018-10754
#   6.0_p20171125-r0:
#     - CVE-2017-16879
#   6.0_p20170701-r0:
#     - CVE-2017-10684

build() {
	./configure \
		--build=$CBUILD \
		--host=$CHOST \
		--mandir=/usr/share/man \
		--without-ada \
		--without-tests \
		--disable-termcap \
		--disable-root-environ \
		--disable-rpath-hack \
		--disable-stripping \
		--with-pkg-config-libdir=/usr/lib/pkgconfig \
		--without-cxx-binding \
		--with-terminfo-dirs="/etc/terminfo:/usr/share/terminfo:/lib/terminfo:/usr/lib/terminfo" \
		--enable-pc-files \
		--with-shared \
		--enable-widec
	make
}

package() {
	make -j1 DESTDIR="$pkgdir" install

	# Install basic terms in /etc/terminfo
	for i in ansi console dumb linux rxvt screen sun vt52 vt100 vt102 \
			vt200 vt220 xterm xterm-color xterm-xfree86 xterm-256color \
			alacritty tmux tmux-256color terminator 'terminology*' \
			vte vte-256color gnome gnome-256color kitty konsole konsole-256color \
			konsole-linux putty putty-256color rxvt-256color 'st-*' \
			screen-256color; do
		local termfiles=$(find "$pkgdir"/usr/share/terminfo/ -name "$i" 2>/dev/null) || true

		[ -z "$termfiles" ] && continue

		for termfile in $termfiles; do
			local basedir=$(basename "$(dirname "$termfile")")
			install -d "$pkgdir"/etc/terminfo/$basedir
			mv "$termfile" "$pkgdir"/etc/terminfo/$basedir/
			ln -s "../../../../etc/terminfo/$basedir/${termfile##*/}" \
				"$pkgdir/usr/share/terminfo/$basedir/${termfile##*/}"
		done
	done
}

dev() {
	default_dev
	# force link against *w.so
	for lib in ncurses ncurses++ form panel menu; do
		echo "INPUT(-l${lib}w)" > "$subpkgdir"/usr/lib/lib$lib.so
		ln -s ${lib}w.pc "$subpkgdir"/usr/lib/pkgconfig/$lib.pc
	done
	# link curses -> ncurses
	echo "INPUT(-lncursesw)" > "$subpkgdir"/usr/lib/libcursesw.so
	ln -s libncurses.so "$subpkgdir"/usr/lib/libcurses.so
}

terminfo() {
	pkgdesc="$pkgdesc (other terminfo files)"
	depends="$pkgname-terminfo-base=$pkgver-r$pkgrel"

	mkdir -p "$subpkgdir"/usr/share "$subpkgdir"/usr/lib
	mv "$pkgdir"/usr/share/terminfo "$subpkgdir"/usr/share
	# also move symlink
	mv "$pkgdir"/usr/lib/terminfo "$subpkgdir"/usr/lib/
}

libs() {
	pkgdesc="Ncurses libraries"
	depends="$pkgname-terminfo-base=$pkgver-r$pkgrel"
	provides="ncurses-widec-libs=$pkgver-r$pkgrel"

	mkdir -p "$subpkgdir"/usr/lib
	mv "$pkgdir"/usr/lib/*.so.* "$subpkgdir"/usr/lib
}

base() {
	depends=""
	pkgdesc="Descriptions of common terminals"

	mkdir -p "$subpkgdir"/etc/terminfo
	mv "$pkgdir"/etc/terminfo/ "$subpkgdir"/etc/
}

static() {
	pkgdesc="Static libraries for the ncurses library"
	mkdir -p "$subpkgdir"/usr/lib
	mv "$pkgdir"/usr/lib/*.a "$subpkgdir"/usr/lib/
	ln -s libncurses.a "$subpkgdir"/usr/lib/libcurses.a
}

sha512sums="
0592d85520ecee36b148db40baff4060742c81ca77bbd79af6ce892dbff1a6a7fa6308ea1d55dc3356b06978e34b646c94f3b0bd60e36c17c522b8ca90b282d2  ncurses-6.3_p20211120.tar.gz
b7904866af8afc7a163151a803ca506981d87f58ce9a720a28c27aa6fa1ac1cf43dad8916a8265779ff2253d2dbacb2793733cadf44dbe10f6cf894944042708  CVE-2022-29458.patch
a075e0f0ed1778466f8da58bed279f5603ce3676afeb5345c228d4c89a42a28755d6a6f9ddcce5c4a364e6b020bf021a8aa63802fa781829c63ef0fdb9fd41c1  fix-configure-root-args-option.patch
cd0bcf43cb8bc54b2a0189ae20b106a8545e6e3008782f1faa9ea341ac8b05305f5870d6217dbd33009876d32ce3dcc14fc454df4be234187528db27d1351432  root-environ-only-setuid.patch
"
