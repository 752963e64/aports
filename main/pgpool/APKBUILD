# Contributor: Cameron <cbanta@gmail.com>
# Maintainer: Jakub Jirutka <jakub@jirutka.cz>
pkgname=pgpool
_pkgname="$pkgname-II"
pkgver=4.1.0
pkgrel=0
pkgdesc="A connection pooling/replication server for PostgreSQL"
url="https://www.pgpool.net/"
arch="all"
license="BSD"
makedepends="postgresql-dev linux-headers"
subpackages="$pkgname-doc $pkgname-dev"
source="$pkgname-$pkgver.tar.gz::https://www.pgpool.net/download.php?f=$_pkgname-$pkgver.tar.gz
	$pkgname.initd
	musl-compat.patch
	"
builddir="$srcdir/$_pkgname-$pkgver"

prepare() {
	default_prepare
	update_config_sub
}

build() {
	./configure \
		--build=$CBUILD \
		--host=$CHOST \
		--prefix=/usr \
		--sysconfdir=/etc \
		--mandir=/usr/share/man \
		--infodir=/usr/share/info \
		--with-openssl
	make
}

check() {
	make check
}

package() {
	make DESTDIR="$pkgdir" install

	install -m755 -D "$srcdir"/$pkgname.initd "$pkgdir"/etc/init.d/$pkgname
	install -d -m755 "$pkgdir"/var/log/$pkgname
}

doc() {
	local docdir="$subpkgdir"/usr/share/doc/$_pkgname
	default_doc

	mkdir -p "$docdir"
	find "$pkgdir"/etc -type f -maxdepth 1 -exec mv '{}' "$docdir"/ +
}

sha512sums="6e6d5cb40efd5357b5c428dedf71d7a772c23becc397d0ece86134b9d32d4911933d7d92f7e6e5fde8cf37efed74f44c4c9d1ab782994750e8d9e99e24603863  pgpool-4.1.0.tar.gz
de36d7aab6806f1e303901ac80284bb9861edaf9b682901db9f1ead3843ba8cb528c814e5dabfc2c450ebed6450daf3fff14166d08a530e1c44a29e4d4e29a2c  pgpool.initd
37e8314f2dab6889c35edb679906db3997c4d5eba704a7337ff82926d400f2ab780103b6a162b1effa74c0d7f8d6655b62cddd2017d3ea7a5de5f370871ab088  musl-compat.patch"
