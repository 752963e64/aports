# Contributor: Cameron <cbanta@gmail.com>
# Maintainer: Jakub Jirutka <jakub@jirutka.cz>
pkgname=pgpool
_pkgname="$pkgname-II"
pkgver=4.1.0
pkgrel=0
pkgdesc="A connection pooling/replication server for PostgreSQL"
url="https://www.pgpool.net/"
arch="all"
license="BSD"
makedepends="postgresql-dev linux-headers"
install="$pkgname.post-upgrade"
subpackages="$pkgname-doc $pkgname-dev"
source="$pkgname-$pkgver.tar.gz::https://www.pgpool.net/download.php?f=$_pkgname-$pkgver.tar.gz
	$pkgname.initd
	musl-compat.patch
	"
builddir="$srcdir/$_pkgname-$pkgver"

prepare() {
	default_prepare
	update_config_sub
}

build() {
	./configure \
		--build=$CBUILD \
		--host=$CHOST \
		--prefix=/usr \
		--sysconfdir=/etc/$pkgname \
		--mandir=/usr/share/man \
		--infodir=/usr/share/info \
		--with-openssl
	make
}

check() {
	make check
}

package() {
	make DESTDIR="$pkgdir" install

	install -m755 -D "$srcdir"/$pkgname.initd "$pkgdir"/etc/init.d/$pkgname
	install -d -m755 "$pkgdir"/var/log/$pkgname
}

doc() {
	local docdir="$subpkgdir"/usr/share/doc/$_pkgname
	default_doc

	mkdir -p "$docdir"
	mv "$pkgdir"/etc/$pkgname/* "$docdir"/
}

sha512sums="6e6d5cb40efd5357b5c428dedf71d7a772c23becc397d0ece86134b9d32d4911933d7d92f7e6e5fde8cf37efed74f44c4c9d1ab782994750e8d9e99e24603863  pgpool-4.1.0.tar.gz
52331b4b124d8ef6ed02e31f20fc16508c546fe9fb3af4f5dfab76e29613c9b7ba3505769265ef6a5dee2faed9d33fef6f82bf52be440a1d2e37a220ace7e749  pgpool.initd
37e8314f2dab6889c35edb679906db3997c4d5eba704a7337ff82926d400f2ab780103b6a162b1effa74c0d7f8d6655b62cddd2017d3ea7a5de5f370871ab088  musl-compat.patch"
