# Contributor: Leo <thinkabit.ukim@gmail.com>
# Maintainer: Natanael Copa <ncopa@alpinelinux.org>
pkgname=libcap
pkgver=2.38
pkgrel=0
pkgdesc="POSIX 1003.1e capabilities"
arch="all"
license="BSD-3-Clause OR GPL-2.0-only"
url="https://sites.google.com/site/fullycapable/"
depends_dev="linux-headers"
makedepends_build="linux-headers perl"
makedepends_host="$depends_dev attr-dev"
makedepends="$makedepends_build $makedepends_host"
checkdepends="bash"
source="https://kernel.org/pub/linux/libs/security/linux-privs/libcap2/libcap-$pkgver.tar.xz
	libpsx-thread-shutdown.patch
	makefile-test-fix.patch
	"
subpackages="$pkgname-doc $pkgname-static $pkgname-dev"

build() {
	cd "$builddir"
	make BUILD_CC=gcc CC="${CC:-gcc}" lib=lib prefix=/usr DESTDIR="$pkgdir"
}

check() {
	cd "$builddir"
	make -j1 test
}

package() {
	cd "$builddir"
	make lib=lib prefix=/usr RAISE_SETFCAP=no DESTDIR="$pkgdir" install
	# Fix perms
	chmod -v 0755 "$pkgdir"/usr/lib/libcap.so.${pkgver}
}

static() {
	depends=""
	pkgdesc="$pkgdesc (static library)"

	mkdir -p "$subpkgdir"/usr/lib
	mv "$pkgdir"/usr/lib/*.a "$subpkgdir"/usr/lib
}

sha512sums="df92c77f29d9a92b9356f9422a55ba56855e89875b24db57f42f247a8ee0891a2e50f235805aa848c2564de33c1ecd5d68e4a9e8ea6896542cf7585ccbf677d1  libcap-2.38.tar.xz
956efcd8bf70565f3a35f467a9197195396e4d14f8ea36a018006889edd02f62ccdd5f59b0e38e7bd59cd453e735f8787166d4f6d9012072647b3a13d9ac3ba2  libpsx-thread-shutdown.patch
5c0d6106f684d9773329c60171cf8841400f765639e7c5b43cfd151dfc81a58c980e2ff7e2c170162bbb042b1e94555c6586a382cf9f9d8bad6027530c4f297c  makefile-test-fix.patch"
