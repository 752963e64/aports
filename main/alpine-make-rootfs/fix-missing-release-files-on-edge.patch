Patch-Source: https://github.com/alpinelinux/alpine-make-rootfs/commit/80a8e3f9d6f5ec701b2ae5e9a0d6bdb004ec1246
--
From 80a8e3f9d6f5ec701b2ae5e9a0d6bdb004ec1246 Mon Sep 17 00:00:00 2001
From: Jakub Jirutka <jakub@jirutka.cz>
Date: Sun, 21 Aug 2022 00:56:04 +0200
Subject: [PATCH] Adapt to alpine-base not providing release files since v3.17
 and on edge

https://gitlab.alpinelinux.org/alpine/aports/-/commit/23e66e85c95beef9d3f72a2ccc510671fdb3462d
---
 alpine-make-rootfs | 15 ++++++++++-----
 1 file changed, 10 insertions(+), 5 deletions(-)

diff --git a/alpine-make-rootfs b/alpine-make-rootfs
index 63133f3..eb24005 100755
--- a/alpine-make-rootfs
+++ b/alpine-make-rootfs
@@ -387,11 +387,16 @@ fi
 
 _apk add --root "$rootfs" --update-cache --initdb $rootfs_pkgs >&2
 
-if ! _apk info --root "$rootfs" --quiet --installed alpine-base; then
-	# This package contains /etc/os-release, /etc/alpine-release and /etc/issue,
-	# but we don't wanna install all its dependencies (e.g. openrc).
-	_apk fetch --root "$rootfs" --stdout alpine-base \
-		| tar -xz -C "$rootfs" etc >&2
+if ! [ -f "$rootfs"/etc/alpine-release ]; then
+	if _apk info --root "$rootfs" --quiet alpine-release >/dev/null; then
+		_apk add --root "$rootfs" alpine-release
+	else
+		# In Alpine <3.17, this package contains /etc/os-release,
+		# /etc/alpine-release and /etc/issue, but we don't wanna install all
+		# its dependencies (e.g. openrc).
+		_apk fetch --root "$rootfs" --stdout alpine-base \
+			| tar -xz -C "$rootfs" etc >&2
+	fi
 fi
 
 [ -e "$rootfs"/var/run ] || ln -s /run "$rootfs"/var/run
