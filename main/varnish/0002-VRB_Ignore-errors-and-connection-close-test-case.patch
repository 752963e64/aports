From 1020be7e886399a4e94407ae0dfbfd1475cc5756 Mon Sep 17 00:00:00 2001
From: Martin Blix Grydeland <martin@varnish-software.com>
Date: Fri, 17 Dec 2021 22:10:27 +0100
Subject: [PATCH 2/2] VRB_Ignore() errors and connection close test case

---
 bin/varnishtest/tests/f00008.vtc | 56 ++++++++++++++++++++++++++++++++
 1 file changed, 56 insertions(+)
 create mode 100644 bin/varnishtest/tests/f00008.vtc

diff --git a/bin/varnishtest/tests/f00008.vtc b/bin/varnishtest/tests/f00008.vtc
new file mode 100644
index 000000000..4d6161a35
--- /dev/null
+++ b/bin/varnishtest/tests/f00008.vtc
@@ -0,0 +1,56 @@
+varnishtest "VRB_Ignore and connection close"
+
+server s1 {
+	rxreq
+	txresp -body HIT
+} -start
+
+varnish v1 -arg "-p timeout_idle=1" -vcl+backend {
+	sub vcl_recv {
+		if (req.url == "/synth") {
+			return (synth(200, "SYNTH"));
+		}
+	}
+} -start
+
+# Prime an object
+client c1 {
+	txreq -url /hit
+	rxresp
+	expect resp.status == 200
+	expect resp.body == HIT
+} -run
+
+# Test synth
+client c2 {
+	txreq -req POST -url /synth -hdr "Content-Length: 2"
+	# Send 1 byte
+	send a
+	# Wait timeout_idle
+	delay 1.1
+	# Send 1 byte
+	send b
+	rxresp
+	expect resp.status == 200
+	expect resp.reason == SYNTH
+	expect resp.http.connection == close
+	timeout 0.5
+	expect_close
+} -run
+
+# Test cache hit
+client c3 {
+	txreq -req GET -url /hit -hdr "Content-Length: 2"
+	# Send 1 byte
+	send a
+	# Wait timeout_idle
+	delay 1.1
+	# Send 1 byte
+	send b
+	rxresp
+	expect resp.status == 200
+	expect resp.body == HIT
+	expect resp.http.connection == close
+	timeout 0.5
+	expect_close
+} -run
-- 
2.35.0

