Patch-Source: https://sourceware.org/pipermail/gdb-patches/2022-May/189226.html

From 95ad566484663df16c4bf381b1b595d4a1c64866 Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?S=C3=B6ren=20Tempel?= <soeren+git@soeren-tempel.net>
Date: Thu, 19 May 2022 15:41:01 +0200
Subject: [PATCH] Fix build on 32-bit arches with --enable-targets=all

Starting with gdb 12.1, gdb does no longer compile on 32-bit arches with
--enable-targets=all. This is due to missing symbols in libopcodes.a.
For example, on armv6 the compilation error looks as follows:

	CC     nrun.o
	AR     libsim.a
	RANLIB libsim.a
	CCLD   run
	libsim.a(sim-close.o): in function `sim_close':
	  sim-close.c:(.text+0x10): undefined reference to `bpf_cgen_cpu_close'
	libsim.a(sim-if.o): in function `sim_open':
	  sim-if.c:(.text+0x1c0): undefined reference to `bpf_cgen_cpu_open_1'
	sim-if.c:(.text+0x1d8): undefined reference to `bpf_cgen_init_dis'
	  collect2: error: ld returned 1 exit status

I believe this to be a regression introduced in gdb 12.1 by commit
0b32f05baccc6e1ab7f74a55254c5db86e22522b. Since this commit, some
important object files are missing in TARGET32_LIBOPCODES_CFILES
in opcodes/Makefile.am. This commit re-adds these object files to
TARGET32_LIBOPCODES_CFILES thereby fixing compilation of gdb on
32-bit arches with --enable-targets=all.
---
 opcodes/Makefile.am | 19 +++++++++++++++++++
 opcodes/Makefile.in | 19 +++++++++++++++++++
 2 files changed, 38 insertions(+)

diff --git a/opcodes/Makefile.am b/opcodes/Makefile.am
index 10ea3368d7f..342dd8056be 100644
--- a/opcodes/Makefile.am
+++ b/opcodes/Makefile.am
@@ -143,6 +143,11 @@ TARGET32_LIBOPCODES_CFILES = \
 	d30v-dis.c \
 	d30v-opc.c \
 	dlx-dis.c \
+	bpf-asm.c \
+	bpf-desc.c \
+	bpf-dis.c \
+	bpf-ibld.c \
+	bpf-opc.c \
 	epiphany-asm.c \
 	epiphany-desc.c \
 	epiphany-dis.c \
@@ -164,6 +169,8 @@ TARGET32_LIBOPCODES_CFILES = \
 	hppa-dis.c \
 	i386-dis.c \
 	i386-opc.c \
+	ia64-dis.c \
+	ia64-opc.c \
 	ip2k-asm.c \
 	ip2k-desc.c \
 	ip2k-dis.c \
@@ -209,6 +216,15 @@ TARGET32_LIBOPCODES_CFILES = \
 	mep-opc.c \
 	metag-dis.c \
 	microblaze-dis.c \
+	micromips-opc.c \
+	loongarch-opc.c \
+	loongarch-dis.c \
+	loongarch-coder.c \
+	mips-dis.c \
+	mips-opc.c \
+	mips16-opc.c \
+	mmix-dis.c \
+	mmix-opc.c \
 	moxie-dis.c \
 	moxie-opc.c \
 	msp430-decode.c \
@@ -220,6 +236,7 @@ TARGET32_LIBOPCODES_CFILES = \
 	mt-opc.c \
 	nds32-asm.c \
 	nds32-dis.c \
+	nfp-dis.c \
 	nios2-dis.c \
 	nios2-opc.c \
 	ns32k-dis.c \
@@ -236,6 +253,8 @@ TARGET32_LIBOPCODES_CFILES = \
 	ppc-opc.c \
 	pru-dis.c \
 	pru-opc.c \
+	riscv-dis.c \
+	riscv-opc.c \
 	rl78-decode.c \
 	rl78-dis.c \
 	rx-decode.c \
diff --git a/opcodes/Makefile.in b/opcodes/Makefile.in
index b8545a0fa82..af89569d224 100644
--- a/opcodes/Makefile.in
+++ b/opcodes/Makefile.in
@@ -535,6 +535,11 @@ TARGET32_LIBOPCODES_CFILES = \
 	d30v-dis.c \
 	d30v-opc.c \
 	dlx-dis.c \
+	bpf-asm.c \
+	bpf-desc.c \
+	bpf-dis.c \
+	bpf-ibld.c \
+	bpf-opc.c \
 	epiphany-asm.c \
 	epiphany-desc.c \
 	epiphany-dis.c \
@@ -556,6 +561,8 @@ TARGET32_LIBOPCODES_CFILES = \
 	hppa-dis.c \
 	i386-dis.c \
 	i386-opc.c \
+	ia64-dis.c \
+	ia64-opc.c \
 	ip2k-asm.c \
 	ip2k-desc.c \
 	ip2k-dis.c \
@@ -601,6 +608,15 @@ TARGET32_LIBOPCODES_CFILES = \
 	mep-opc.c \
 	metag-dis.c \
 	microblaze-dis.c \
+	micromips-opc.c \
+	loongarch-opc.c \
+	loongarch-dis.c \
+	loongarch-coder.c \
+	mips-dis.c \
+	mips-opc.c \
+	mips16-opc.c \
+	mmix-dis.c \
+	mmix-opc.c \
 	moxie-dis.c \
 	moxie-opc.c \
 	msp430-decode.c \
@@ -612,6 +628,7 @@ TARGET32_LIBOPCODES_CFILES = \
 	mt-opc.c \
 	nds32-asm.c \
 	nds32-dis.c \
+	nfp-dis.c \
 	nios2-dis.c \
 	nios2-opc.c \
 	ns32k-dis.c \
@@ -628,6 +645,8 @@ TARGET32_LIBOPCODES_CFILES = \
 	ppc-opc.c \
 	pru-dis.c \
 	pru-opc.c \
+	riscv-dis.c \
+	riscv-opc.c \
 	rl78-decode.c \
 	rl78-dis.c \
 	rx-decode.c \
