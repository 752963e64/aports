# Contributor: Łukasz Jendrysik <scadu@yandex.com>
# Contributor: Sören Tempel <soeren+alpine@soeren-tempel.net>
# Contributor: Takuya Noguchi <takninnovationresearch@gmail.com>
# Maintainer: Fabian Affolter <fabian@affolter-engineering.ch>
pkgname=ansible
pkgver=2.7.17
pkgrel=0
pkgdesc="A configuration-management, deployment, task-execution, and multinode orchestration framework"
url="https://ansible.com/"
arch="noarch"
license="GPL-3.0-or-later"
_py=py3
depends="python3 $_py-yaml $_py-paramiko $_py-jinja2 $_py-markupsafe $_py-crypto"
makedepends="python3-dev py3-setuptools"
options="!check" # not included in release tarball
subpackages="$pkgname-doc"
source="https://releases.ansible.com/ansible/ansible-$pkgver.tar.gz
	add-lxc-container_shell-option.patch
	"

builddir="$srcdir/$pkgname-$pkgver"

# secfixes:
#   2.7.17-r0:
#     - CVE-2019-3828
#     - CVE-2020-1733
#     - CVE-2020-1737
#     - CVE-2020-1739
#     - CVE-2020-1740
#     - CVE-2020-1746
#   2.7.16-r0:
#     - CVE-2019-14864
#     - CVE-2019-14904
#     - CVE-2019-14905
#   2.7.14-r0:
#     - CVE-2019-14846
#     - CVE-2019-14856
#     - CVE-2019-14858
#   2.7.13-r0:
#     - CVE-2019-10206
#   2.7.12-r0:
#     - CVE-2019-101562
#   2.7.8-r0:
#     - CVE-2019-38287
#   2.7.5-r0:
#     - CVE-2018-16876
#   2.7.3-r0:
#     - CVE-2018-16859
#   2.7.1-r0:
#     - CVE-2018-16837
#   2.6.3-r0:
#     - CVE-2018-10875

prepare() {
	# Windows-only scripts
	rm -r examples/scripts
}

build() {
	cd "$builddir"
	python3 setup.py build
}

package() {
	cd "$builddir"
	python3 setup.py install --prefix=/usr --root="$pkgdir"

	mkdir -p "$pkgdir"/usr/share/man/man1
	install -Dm644 "$builddir"/docs/man/man1/*.1 \
		"$pkgdir"/usr/share/man/man1/

	mkdir -p "$pkgdir"/usr/share/doc/$pkgname/examples/
	install -m644 examples/* \
		"$pkgdir"/usr/share/doc/$pkgname/examples/
	install -m644 README.rst "$pkgdir"/usr/share/doc/$pkgname
}

sha512sums="387ee26381d120e8b1a77a5251686831fefb47213dce4a1f0aee714e6c6e2a94f1bf283ef2bcf3d79940552407fff7d86453968f1aa5a866f013d396948ccc0f  ansible-2.7.17.tar.gz
e1bd1affec585abf4556d1f2598df2689c2341fc0ddaec3eadc0a9c6df5725b8ab97092771f2c57da6ecaa72ae1bb5e5ccce55db8c4d74bfc785f611dd5b8c32  add-lxc-container_shell-option.patch"
