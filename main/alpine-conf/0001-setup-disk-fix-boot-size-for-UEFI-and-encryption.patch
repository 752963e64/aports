From f2a081f99a927faa9f7e21f7b25aa55af985fda0 Mon Sep 17 00:00:00 2001
From: Natanael Copa <ncopa@alpinelinux.org>
Date: Fri, 4 Nov 2022 16:07:44 +0100
Subject: [PATCH] setup-disk: fix /boot size for UEFI and encryption

Currently, /boot becomes 34 MB, which is too small.

Fixes https://gitlab.alpinelinux.org/alpine/alpine-conf/-/issues/10536
---
 setup-disk.in | 3 ++-
 1 file changed, 2 insertions(+), 1 deletion(-)

diff --git a/setup-disk.in b/setup-disk.in
index fca6fbf..7e87f2a 100644
--- a/setup-disk.in
+++ b/setup-disk.in
@@ -1601,7 +1601,8 @@ if [ -z "$SWAP_SIZE" ]; then
 	SWAP_SIZE=$(find_swap_size $diskdevs)
 fi
 
-if [ -n "$USE_EFI" ] && [ -z "$BOOT_SIZE" ]; then
+# reduce size of ESP partition
+if [ -n "$USE_EFI" ] && [ -z "$USE_CRYPT" ] && [ -z "$BOOT_SIZE" ]; then
 	blocksize=$(cat $(echo $diskdevs | sed -E -e 's:/dev/([^ ]+):/sys/block/\1/queue/logical_block_size:g') | sort -n | tail -n 1)
 	# calculate minimal FAT32 size
 	# for block size 512 minimal size is 32MB
-- 
2.38.1

