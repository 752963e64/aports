# Maintainer: Natanael Copa <ncopa@alpinelinux.org>
pkgname=libmspack
pkgver=0.8_alpha
_ver=${pkgver/_/}
pkgrel=1
pkgdesc="Library for CAB and related files compression and decompression"
url="https://www.cabextract.org.uk/libmspack/"
arch="all"
license="LGPL-2.0"
depends=""
depends_dev=""
makedepends="$depends_dev"
subpackages="$pkgname-dev"
source="https://www.cabextract.org.uk/libmspack/libmspack-$_ver.tar.gz
	CVE-2019-1010305.patch
	"

_builddir="$srcdir"/libmspack-$_ver

# secfixes:
#   0.8_alpha-r1:
#     - CVE-2019-1010305
#   0.8_alpha-r0:
#     - CVE-2018-18584
#     - CVE-2018-18585
#     - CVE-2018-18586
#   0.7.1_alpha-r0:
#     - CVE-2018-14679
#     - CVE-2018-14680
#     - CVE-2018-14681
#     - CVE-2018-14682
#   0.5_alpha-r1:
#     - CVE-2017-6419
#     - CVE-2017-11423

prepare() {
	local i
	cd "$_builddir"
	for i in $source; do
		case $i in
		*.patch) msg $i; patch -p1 -i "$srcdir"/$i || return 1;;
		esac
	done
}

build() {
	cd "$_builddir"
	./configure \
		--build=$CBUILD \
		--host=$CHOST \
		--prefix=/usr \
		--sysconfdir=/etc \
		--mandir=/usr/share/man \
		--localstatedir=/var \
		--disable-static \
		|| return 1
	# parallel build workaround
	make libmspack.la libmscabd.la libmschmd.la
	make
}

package() {
	cd "$_builddir"
	make DESTDIR="$pkgdir" install || return 1
}

sha512sums="d178afc4d2eded204594c81af1c91be17d3be4f1a09829e08c103023aa7badc6b2595e9ec13cc7f77e3262d2cd874ed40ce6da01695c5c839682562740d2bf0a  libmspack-0.8alpha.tar.gz
4c5f5ab9d597538303ce2adf27014db715603afdde50904cd3cb363077f2ff883086cf9ccf1072fa516f73df4652bec3bddd81854aeac5f11c0698d1cfb59cdf  CVE-2019-1010305.patch"
