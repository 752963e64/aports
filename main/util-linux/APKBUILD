# Contributor: SÃ¶ren Tempel <soeren+alpine@soeren-tempel.net>
# Contributor: Leonardo Arena <rnalrd@alpinelinux.org>
# Maintainer: Natanael Copa <ncopa@alpinelinux.org>
pkgname=util-linux
pkgver=2.37.2
pkgrel=4
pkgdesc="Random collection of Linux utilities"
url="https://git.kernel.org/cgit/utils/util-linux/util-linux.git"
arch="all"
license="GPL-3.0-or-later AND GPL-2.0-or-later AND GPL-2.0-only AND
	LGPL-2.1-or-later AND BSD-3-Clause AND BSD-4-Clause-UC AND Public-Domain"
checkdepends="bash findutils xz"
makedepends_build="
	autoconf
	automake
	libtool
	"
makedepends_host="
	libcap-ng-dev
	linux-headers
	ncurses-dev
	zlib-dev
	"
subpackages="
	$pkgname-bash-completion
	$pkgname-dev
	$pkgname-doc
	$pkgname-openrc

	libblkid:_mv_lib
	libfdisk:_mv_lib
	libmount:_mv_lib
	libsmartcols:_mv_lib
	libuuid:_mv_lib

	agetty:_mv_bin
	blkid:_mv_bin
	cfdisk:_mv_bin
	findmnt:_mv_bin
	flock:_mv_bin
	hexdump:_mv_bin
	logger:_mv_bin
	lsblk:_mv_bin
	mcookie:_mv_bin
	partx:_mv_bin
	setpriv:_mv_bin
	sfdisk:_mv_bin
	uuidgen:_mv_bin
	wipefs:_mv_bin
	"
if [ -z "$BOOTSTRAP" ]; then
	makedepends_build="$makedepends_build asciidoctor"
	makedepends_host="$makedepends_host linux-pam-dev python3-dev libeconf-dev"
	subpackages="$subpackages py3-libmount:_py3 runuser:_mv_bin"
	_bootstrap_config="--enable-runuser --with-python=3 --with-econf"
else
	_bootstrap_config="--without-python --without-econf --disable-asciidoc"
fi
subpackages="$subpackages $pkgname-misc"
makedepends="$makedepends_build $makedepends_host"
options="suid"

case $pkgver in
	*.*.*) _v=${pkgver%.*};;
	*.*) _v=$pkgver;;
esac
source="https://www.kernel.org/pub/linux/utils/util-linux/v$_v/util-linux-$pkgver.tar.xz
	ttydefaults.h
	rfkill.confd
	rfkill.initd
	"

# secfixes:
#   2.37.2-r0:
#     - CVE-2021-37600

prepare() {
	default_prepare

	cp "$srcdir"/ttydefaults.h include/
	libtoolize --force
	aclocal -I m4
	autoconf
	automake --add-missing

	# FIXME: This test fails, dunno why.
	rm tests/ts/col/multibyte
	# FIXME: Fails on GitLab CI, but passes locally, dunno why.
	rm tests/ts/misc/setarch
	# XXX: Hangs on GitLab CI.
	rm tests/ts/lsns/*
}

build() {
	# login utils are provided by shadow (with PAM) or busybox (no PAM) --nenolod
	./configure \
		--build=$CBUILD \
		--host=$CHOST \
		--with-sysroot=$CBUILDROOT \
		--prefix=/usr \
		--disable-chfn-chsh \
		--enable-raw \
		--disable-uuidd \
		--disable-nls \
		--disable-tls \
		--disable-kill \
		--disable-login \
		--disable-last \
		--disable-sulogin \
		--disable-su \
		--with-vendordir=/usr/lib \
		$_bootstrap_config
	make
}

check() {
	make check
}

package() {
	make -j1 DESTDIR="$pkgdir" -C "$builddir" install

	# Move rev to /bin to overwrite busybox's version.
	mv "$pkgdir"/usr/bin/rev "$pkgdir"/bin

	# use pkg-config
	install -D -m755 "$srcdir"/rfkill.initd "$pkgdir"/etc/init.d/rfkill
	install -D -m644 "$srcdir"/rfkill.confd "$pkgdir"/etc/conf.d/rfkill
}

_mv_bin() {
	local binname=$subpkgname
	pkgdesc="$binname tool from util-linux"
	depends=
	install_if="$pkgname=$pkgver-r$pkgrel"

	case "$binname" in
		agetty) pkgdesc="agetty program from util-linux";;
		blkid) pkgdesc="Block device identification tool from util-linux";;
		cfdisk) pkgdesc="Curses based partition table manipulator from util-linux";;
		flock) pkgdesc="File locker from util-linux";;
		logger) pkgdesc="Logger from util-linux";;
		lsblk) pkgdesc="Block device list tool from util-linux";;
		runuser) pkgdesc="Run a program with substitute user and group ID";;
		setpriv) pkgdesc="Run a program with different Linux privilege settings";;
		sfdisk) pkgdesc="Partition table manipulator from util-linux";;
		uuidgen) pkgdesc="UUID generator from util-linux";;
	esac
	local dir; for dir in usr/bin usr/sbin bin sbin; do
		if [ -e "$pkgdir"/$dir/$binname ]; then
			amove $dir/$binname
			return 0
		fi
	done
	return 1
}

_mv_lib() {
	local libname=$subpkgname
	pkgdesc="$libname library from util-linux"
	depends=

	case "$libname" in
		libblkid) pkgdesc="Block device identification library from util-linux";;
		libfdisk) pkgdesc="Partitioning library for fdisk-like programs";;
		libmount) pkgdesc="Block device identification library from util-linux";;
		libsmartcols) pkgdesc="Formatting library for ls-like programs";;
		libuuid) pkgdesc="DCE compatible Universally Unique Identifier library";;
	esac
	amove lib/$libname.so.*
}

misc() {
	pkgdesc="Misc binaries for $pkgname"
	depends=
	install_if="$pkgname=$pkgver-r$pkgrel"

	local dir; for dir in usr/bin usr/sbin bin sbin; do
		if [ -e "$pkgdir"/$dir ]; then
			amove $dir
		fi
	done
}

_py3() {
	pkgdesc="python3 bindings to libmount"
	depends=

	amove usr/lib/python*
}

sha512sums="
38f0fe820445e3bfa79550e6581c230f98c7661566ccc4daa51c7208a5f972c61b4e57dfc86bed074fdbc7c40bc79f856be8f6a05a8860c1c0cecc4208e8b81d  util-linux-2.37.2.tar.xz
876bb9041eca1b2cca1e9aac898f282db576f7860aba690a95c0ac629d7c5b2cdeccba504dda87ff55c2a10b67165985ce16ca41a0694a267507e1e0cafd46d9  ttydefaults.h
401d2ccbdbfb0ebd573ac616c1077e2c2b79ff03e9221007759d8ac25eb522c401f705abbf7daac183d5e8017982b8ec5dd0a5ebad39507c5bb0a9f31f04ee97  rfkill.confd
c4e7ba6d257496c99934add2ca532db16fb070ea2367554587c9fb4e24ab1d80b8ba3fd0fd4fdd5ef1374c3ec6414007369b292ee334ef23171d0232ef709db2  rfkill.initd
"
