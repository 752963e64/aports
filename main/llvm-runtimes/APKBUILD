# Contributor: Eric Molitor <eric@molitor.org>
# Contributor: Jakub Jirutka <jakub@jirutka.cz>
# Contributor: Rasmus Thomsen <oss@cogitri.dev>
# Maintainer: psykose <alice@ayaya.dev>
pkgname=llvm-runtimes
# Note: Update together with llvm.
pkgver=15.0.6
_llvmver=${pkgver%%.*}
pkgrel=1
pkgdesc="LLVM Runtimes"
url="https://llvm.org/"
arch="all"
license="Apache-2.0"
depends_dev="!libunwind-dev"
makedepends="
	clang
	cmake
	linux-headers
	llvm$_llvmver-dev
	llvm$_llvmver-static
	python3
	samurai
	"
subpackages="
	compiler-rt:rt
	llvm-libunwind:libunwind
	llvm-libunwind-static:libunwind_static
	llvm-libunwind-dev:libunwind_dev
	"
source="https://github.com/llvm/llvm-project/releases/download/llvmorg-$pkgver/llvm-project-$pkgver.src.tar.xz
	compiler-rt-lsan-dtp-offset.patch
	compiler-rt-ppc-fixes.patch
	compiler-rt-sanitizer-supported-arch.patch
	libcxx-musl.patch
	libcxx-ppc.patch
	libunwind-link-libssp.patch
	"
builddir="$srcdir/llvm-project-$pkgver.src"
options="!check"

case "$CARCH" in
	# Sanitizers are broken on other arches.
	# Keep in sync with sanitizer-supported-arch.patch.
	aarch64|ppc64le|riscv64|x86_64) _build_sanitizers='ON';;
	*) _build_sanitizers='OFF';;
esac

build() {
	local crossopts=''
	[ "$CBUILD" != "$CHOST" ] && crossopts="
		-DCMAKE_SYSTEM_NAME=Linux
		-DCMAKE_HOST_SYSTEM_NAME=Linux
		-DLIBUNWIND_SYSROOT=$CBUILDROOT"

	CC=clang \
	CXX=clang++ \
	cmake -B build -G Ninja -Wno-dev -S runtimes \
		-DLLVM_ENABLE_RUNTIMES="compiler-rt;libunwind" \
		-DCMAKE_BUILD_TYPE=MinSizeRel \
		-DCMAKE_INSTALL_PREFIX=/usr \
		-DLIBCXX_HAS_MUSL_LIBC=ON \
		-DLIBUNWIND_HAS_NODEFAULTLIBS_FLAG=OFF \
		-DCOMPILER_RT_INCLUDE_TESTS="$(want_check && echo ON || echo OFF)" \
		-DCOMPILER_RT_BUILD_SANITIZERS=$_build_sanitizers \
		-DCOMPILER_RT_INSTALL_PATH="/usr/lib/clang/$pkgver" \
		-DCOMPILER_RT_BUILD_GWP_ASAN=OFF \
		$crossopts
	cmake --build build
}

package() {
	DESTDIR="$pkgdir" cmake --install build

	mkdir -p "$pkgdir"/usr/include/mach-o
	cp libunwind/include/*.h "$pkgdir"/usr/include/
	cp libunwind/include/mach-o/*.h "$pkgdir"/usr/include/mach-o/

	case "$CARCH" in
	ppc64le)
		local archname="powerpc64le"
		;;
	*)
		local archname="$CARCH"
		;;
	esac

	case "$CARCH" in
	x86_64|ppc64le|aarch64)
		# provide an easier to find name for the scudo standalone allocator,
		# allowing preloading and patchelfind of something in /usr/lib instead of
		# a deep directory tree
		ln -sv /usr/lib/clang/$pkgver/lib/linux/libclang_rt.scudo_standalone-$archname.so \
			"$pkgdir"/usr/lib/libscudo.so
		;;
	esac
}

libunwind() {
	pkgdesc="LLVM libunwind library"

	amove usr/lib/libunwind.so.*
}

libunwind_static() {
	pkgdesc="LLVM libunwind library (static)"

	amove usr/lib/libunwind.a
}

libunwind_dev() {
	pkgdesc="LLVM libunwind library (development files)"

	amove usr/lib/libunwind.so
	# if libcxx is added, these have to be more careful
	amove usr/include
}

rt() {
	pkgdesc="LLVM compiler-rt runtime libraries"

	amove usr/lib/clang/$pkgver

	if [ "$_build_sanitizers" = "ON" ]; then
		amove usr/lib/libscudo.so
	fi
}

sha512sums="
3311d85f4e02610af52f06e83c8c6d2b93950d24324b831b7afc47c39a20a546d39683a14e1a315da87d226379042de900a3f36a0351053547482af9035ab949  llvm-project-15.0.6.src.tar.xz
7c2cbd095b863f735842aaa8f0daecbf0282200fc58f1394139cee30d53c4a738757e38cbf0ec734398ee827e8a47314592bd7dc9768ef5c3664db682680e5a1  compiler-rt-lsan-dtp-offset.patch
22b6d29fd75e7ca92a9c3584cbc38a8ca3f7fb0dcc4c86235e543b75241883d0258e0516df32f4d41b00739c6d9e8c5403538f9674e704cab43fe78bd1721980  compiler-rt-ppc-fixes.patch
2460aeeb2ddcc24686939e172189d5a05e78eb30a4dca03fd60f03ec3bab5d55223a5806e44305278da0c726e65411907a6074cf64697164e613f42c013e365e  compiler-rt-sanitizer-supported-arch.patch
e06a4ebc9ed4258729320d3d67fa0f7c9962c2435e713edda2fcbd9dca93bf85072b99ae4bdaa848254ace8423c7e20b9f829a3238eb4a4f5c5758ef4ee379f6  libcxx-musl.patch
fe6336bc73b3ee3aa6665b4a2a53f7360a1b23097002bb396c8515c4343e7bf8e84728f769aa033400e386c2c80a538c970f16719518040f4fea0fd667af523a  libcxx-ppc.patch
e601d0657d61cf080c9a03fd0139f9cae85339ba7f997f61283c1ba3b9fb48479cca875db44b64ee8b48a7d61a18a70d7cd123500f72966770cf5312b1aca034  libunwind-link-libssp.patch
"
